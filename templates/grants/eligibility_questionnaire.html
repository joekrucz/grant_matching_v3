{% extends 'base.html' %}

{% block title %}Eligibility Questionnaire - Trellis{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold">Eligibility Questionnaire</h1>
            <p class="text-sm text-base-content/70 mt-1">
                Comprehensive eligibility requirements compiled from {{ total_grants }} grant{{ total_grants|pluralize }} with {{ total_unique_items }} unique requirement{{ total_unique_items|pluralize:"s" }}
            </p>
        </div>
        <div>
            <a href="{% url 'grants:questionnaires_list' %}" class="btn btn-outline btn-sm">
                View Past Questionnaires
            </a>
        </div>
    </div>
</div>

<form method="post" id="questionnaire-form">
    {% csrf_token %}
    <div class="card bg-base-200 border border-base-300">
        <div class="card-body">
            <p class="text-base-content/80 mb-6">
                This questionnaire contains all eligibility requirements found across all grants in the system. 
                Use this to quickly assess your eligibility for multiple grants at once. Select the requirements you meet and save your questionnaire.
            </p>
            
            <div class="space-y-4">
                {% for item in items %}
                <div class="card bg-base-100 border border-base-300">
                    <div class="card-body p-4">
                        <div class="flex items-start gap-3">
                            <input 
                                type="checkbox" 
                                name="selected_items"
                                value="{{ item.text }}"
                                class="checkbox checkbox-primary checkbox-sm mt-1" 
                                id="item-{{ forloop.counter }}"
                            >
                            <label for="item-{{ forloop.counter }}" class="flex-1 cursor-pointer">
                                <span class="text-base-content/90">{{ item.text }}</span>
                                <span class="text-xs text-base-content/60 ml-2">
                                    (found in {{ item.frequency }} grant{{ item.frequency|pluralize }})
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info">
                    <span>No eligibility checklists found. Generate eligibility checklists for grants first.</span>
                </div>
                {% endfor %}
            </div>
            
            {% if items %}
            <div class="mt-6 pt-6 border-t border-base-300">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <span class="text-sm text-base-content/70">Selected: </span>
                        <span class="text-sm font-semibold" id="selected-count">0</span>
                        <span class="text-sm text-base-content/70"> / {{ total_unique_items }}</span>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="selectAll()" class="btn btn-sm btn-outline">Select All</button>
                        <button type="button" onclick="deselectAll()" class="btn btn-sm btn-outline">Deselect All</button>
                    </div>
                </div>
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="label">
                            <span class="label-text text-sm">Questionnaire Name (optional)</span>
                        </label>
                        <input 
                            type="text" 
                            name="questionnaire_name" 
                            placeholder="e.g., My Company Eligibility Assessment"
                            class="input input-bordered w-full"
                            maxlength="255"
                        >
                    </div>
                    <button type="submit" class="btn btn-primary" id="save-btn" disabled>
                        Save Questionnaire
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</form>

<!-- Progress Indicator (hidden by default) -->
<div id="generation-progress-alert" class="alert alert-info mt-4 hidden">
    <div class="flex items-center gap-3 w-full">
        <span class="loading loading-spinner loading-md"></span>
        <div class="flex-1">
            <p class="font-medium" id="progress-text">Saving questionnaire...</p>
            <p class="text-sm text-base-content/70" id="progress-detail">Please wait while we generate your questionnaire.</p>
        </div>
    </div>
    <div class="mt-4 w-full">
        <progress 
            id="generation-progress-bar"
            class="progress progress-primary w-full" 
            value="0" 
            max="100"
        ></progress>
    </div>
</div>

<script>
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    const countElement = document.getElementById('selected-count');
    const saveBtn = document.getElementById('save-btn');
    
    if (countElement) {
        countElement.textContent = checkboxes.length;
    }
    
    // Enable/disable save button based on selection
    if (saveBtn) {
        saveBtn.disabled = checkboxes.length === 0;
    }
}

function selectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

function deselectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

document.addEventListener('DOMContentLoaded', function() {
    // Update count when checkboxes change
    document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    updateSelectedCount();
    
    // Handle form submission with progress indicator
    const form = document.getElementById('questionnaire-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const selectedCount = document.querySelectorAll('input[type="checkbox"]:checked').length;
            if (selectedCount === 0) {
                e.preventDefault();
                return false;
            }
            
            // Show progress indicator
            const progressAlert = document.getElementById('generation-progress-alert');
            const progressText = document.getElementById('progress-text');
            const progressDetail = document.getElementById('progress-detail');
            const progressBar = document.getElementById('generation-progress-bar');
            const saveBtn = document.getElementById('save-btn');
            
            if (progressAlert) {
                progressAlert.classList.remove('hidden');
                // Scroll to progress indicator
                progressAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // Disable form
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Generating...';
            }
            
            // Update progress steps
            let progressStep = 0;
            const steps = [
                { text: 'Saving questionnaire...', detail: 'Storing your selections', progress: 20 },
                { text: 'Generating sales questionnaire...', detail: 'Using AI to create sales-friendly questions', progress: 50 },
                { text: 'Finalizing...', detail: 'Almost done!', progress: 90 },
            ];
            
            function updateProgress() {
                if (progressStep < steps.length) {
                    const step = steps[progressStep];
                    if (progressText) progressText.textContent = step.text;
                    if (progressDetail) progressDetail.textContent = step.detail;
                    if (progressBar) progressBar.value = step.progress;
                    progressStep++;
                    
                    if (progressStep < steps.length) {
                        setTimeout(updateProgress, 800);
                    }
                }
            }
            
            // Start progress updates
            updateProgress();
            
            // The form will submit normally, and the page will redirect when done
            // If there's an error, the modal will be hidden on page reload
        });
    }
});
</script>
{% endblock %}

