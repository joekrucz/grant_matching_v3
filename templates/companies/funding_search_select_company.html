{% extends 'base.html' %}

{% block title %}Select Company for Funding Search - Trellis{% endblock %}

{% block content %}
<div class="hero min-h-[80vh]">
    <div class="hero-content">
        <div class="card bg-base-200 w-full max-w-2xl border border-base-300">
            <div class="card-body">
                <h1 class="card-title text-3xl justify-center mb-4">Select Company for Funding Search</h1>
                <p class="text-center text-base-content/70 mb-6">
                    Search for an existing company or create a new one to start your funding search.
                </p>
                
                <!-- Mode Selection Tabs -->
                <div class="tabs tabs-boxed mb-6">
                    <a class="tab tab-active" onclick="switchMode('registered')" id="tab-registered">Companies House Lookup</a>
                    <a class="tab" onclick="switchMode('manual')" id="tab-manual">Manual Entry (Unregistered)</a>
                </div>
                
                <!-- Companies House Lookup Form -->
                <form method="post" action="{% url 'companies:funding_search_select_company' %}" id="form-registered">
                    {% csrf_token %}
                    <input type="hidden" name="creation_mode" value="registered">
                    
                    <div class="form-control mb-4">
                        <label class="label" for="id_company_search">
                            <span class="label-text">Search by Company Name</span>
                        </label>
                        <input 
                            type="text" 
                            id="id_company_search" 
                            placeholder="Type company name to search..."
                            class="input input-bordered"
                            autocomplete="off"
                        >
                        <label class="label">
                            <span class="label-text-alt">Search for a company by its registered name. Results will appear below.</span>
                        </label>
                        <div id="search-results" class="mt-2 hidden">
                            <div class="card bg-base-100 border border-base-300">
                                <div class="card-body p-3 max-h-64 overflow-y-auto">
                                    <div id="search-results-list"></div>
                                    <div id="search-loading" class="hidden text-center text-sm text-base-content/60">
                                        Searching...
                                    </div>
                                    <div id="search-error" class="hidden text-center text-sm text-error"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="divider">OR</div>
                    
                    <div class="form-control">
                        <label class="label" for="id_company_number">
                            <span class="label-text">Companies House Number</span>
                        </label>
                        <input 
                            type="text" 
                            name="company_number" 
                            id="id_company_number" 
                            placeholder="e.g., 12345678"
                            class="input input-bordered"
                        >
                        <label class="label">
                            <span class="label-text-alt">Enter a Companies House company number directly.</span>
                        </label>
                    </div>
                    
                    <div class="form-control mt-6">
                        <button type="submit" class="btn btn-primary">Continue to Funding Search</button>
                    </div>
                </form>
                
                <!-- Manual Entry Form -->
                <form method="post" action="{% url 'companies:funding_search_select_company' %}" id="form-manual" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" name="creation_mode" value="manual">
                    
                    <div class="form-control mb-4">
                        <label class="label" for="id_name">
                            <span class="label-text">Company Name <span class="text-error">*</span></span>
                        </label>
                        <input 
                            type="text" 
                            name="name" 
                            id="id_name" 
                            required 
                            placeholder="e.g., My Startup Ltd"
                            class="input input-bordered"
                        >
                    </div>
                    
                    <div class="form-control mb-4">
                        <label class="label" for="id_company_type">
                            <span class="label-text">Company Type</span>
                        </label>
                        <select name="company_type" id="id_company_type" class="select select-bordered">
                            <option value="">Select type...</option>
                            <option value="Startup">Startup</option>
                            <option value="Sole Trader">Sole Trader</option>
                            <option value="Partnership">Partnership</option>
                            <option value="Limited Company">Limited Company</option>
                            <option value="LLC">LLC</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-control mb-4">
                        <label class="label" for="id_website">
                            <span class="label-text">Website</span>
                        </label>
                        <input 
                            type="url" 
                            name="website" 
                            id="id_website" 
                            placeholder="https://example.com"
                            class="input input-bordered"
                        >
                    </div>
                    
                    <div class="divider">Address (Optional)</div>
                    
                    <div class="form-control mb-4">
                        <label class="label" for="id_address_line_1">
                            <span class="label-text">Address Line 1</span>
                        </label>
                        <input 
                            type="text" 
                            name="address_line_1" 
                            id="id_address_line_1" 
                            placeholder="Street address"
                            class="input input-bordered"
                        >
                    </div>
                    
                    <div class="form-control mb-4">
                        <label class="label" for="id_address_line_2">
                            <span class="label-text">Address Line 2</span>
                        </label>
                        <input 
                            type="text" 
                            name="address_line_2" 
                            id="id_address_line_2" 
                            placeholder="Apartment, suite, etc."
                            class="input input-bordered"
                        >
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="form-control">
                            <label class="label" for="id_locality">
                                <span class="label-text">City/Town</span>
                            </label>
                            <input 
                                type="text" 
                                name="locality" 
                                id="id_locality" 
                                placeholder="City"
                                class="input input-bordered"
                            >
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="id_postal_code">
                                <span class="label-text">Postal Code</span>
                            </label>
                            <input 
                                type="text" 
                                name="postal_code" 
                                id="id_postal_code" 
                                placeholder="Postcode"
                                class="input input-bordered"
                            >
                        </div>
                    </div>
                    
                    <div class="form-control mb-4">
                        <label class="label" for="id_country">
                            <span class="label-text">Country</span>
                        </label>
                        <input 
                            type="text" 
                            name="country" 
                            id="id_country" 
                            placeholder="Country"
                            class="input input-bordered"
                        >
                    </div>
                    
                    <div class="form-control mb-4">
                        <label class="label" for="id_notes">
                            <span class="label-text">Notes</span>
                        </label>
                        <textarea 
                            name="notes" 
                            id="id_notes" 
                            placeholder="Additional notes about the company..."
                            class="textarea textarea-bordered"
                            rows="3"
                        ></textarea>
                    </div>
                    
                    <div class="form-control mt-6">
                        <button type="submit" class="btn btn-primary">Continue to Funding Search</button>
                    </div>
                </form>
                
                <div class="text-center mt-4">
                    <a href="{% url 'companies:funding_searches_list' %}" class="link link-primary">Back to Funding Searches</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function switchMode(mode) {
    const registeredForm = document.getElementById('form-registered');
    const manualForm = document.getElementById('form-manual');
    const registeredTab = document.getElementById('tab-registered');
    const manualTab = document.getElementById('tab-manual');
    
    if (mode === 'registered') {
        registeredForm.style.display = 'block';
        manualForm.style.display = 'none';
        registeredTab.classList.add('tab-active');
        manualTab.classList.remove('tab-active');
    } else {
        registeredForm.style.display = 'none';
        manualForm.style.display = 'block';
        registeredTab.classList.remove('tab-active');
        manualTab.classList.add('tab-active');
    }
}

// Company search with debounce
(function() {
    const searchInput = document.getElementById('id_company_search');
    const resultsContainer = document.getElementById('search-results');
    const resultsList = document.getElementById('search-results-list');
    const loadingIndicator = document.getElementById('search-loading');
    const errorIndicator = document.getElementById('search-error');
    const companyNumberInput = document.getElementById('id_company_number');
    
    let debounceTimer = null;
    let currentSearch = null;
    
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Clear previous timer
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        
        // Hide results if query is too short
        if (query.length < 2) {
            resultsContainer.classList.add('hidden');
            resultsList.innerHTML = '';
            loadingIndicator.classList.add('hidden');
            errorIndicator.classList.add('hidden');
            return;
        }
        
        // Show loading state
        resultsContainer.classList.remove('hidden');
        loadingIndicator.classList.remove('hidden');
        errorIndicator.classList.add('hidden');
        resultsList.innerHTML = '';
        
        // Set debounce timer (300ms)
        debounceTimer = setTimeout(function() {
            currentSearch = query;
            performSearch(query);
        }, 300);
    });
    
    function performSearch(query) {
        // Only proceed if this is still the current search
        if (query !== currentSearch) {
            return;
        }
        
        fetch(`/companies/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                // Check if this is still the current search
                if (query !== currentSearch) {
                    return;
                }
                
                loadingIndicator.classList.add('hidden');
                
                if (data.error) {
                    errorIndicator.textContent = data.error;
                    errorIndicator.classList.remove('hidden');
                    return;
                }
                
                const results = data.results || [];
                
                if (results.length === 0) {
                    resultsList.innerHTML = '<div class="text-center text-sm text-base-content/60 py-2">No companies found</div>';
                    return;
                }
                
                resultsList.innerHTML = results.map(company => {
                    const status = company.company_status || 'Unknown';
                    const type = company.company_type || 'Unknown';
                    const address = company.address_snippet || '';
                    const date = company.date_of_creation || '';
                    
                    return `
                        <div class="p-2 hover:bg-base-200 rounded cursor-pointer border-b border-base-300 last:border-b-0" 
                             onclick="selectCompany('${company.company_number}', '${company.title.replace(/'/g, "\\'")}')">
                            <div class="font-semibold text-sm">${escapeHtml(company.title)}</div>
                            <div class="text-xs text-base-content/70 mt-1">
                                <span class="badge badge-outline badge-sm">${company.company_number}</span>
                                <span class="ml-2">${escapeHtml(status)}</span>
                                ${type !== 'Unknown' ? `<span class="ml-2">${escapeHtml(type)}</span>` : ''}
                            </div>
                            ${address ? `<div class="text-xs text-base-content/60 mt-1">${escapeHtml(address)}</div>` : ''}
                            ${date ? `<div class="text-xs text-base-content/60 mt-1">Created: ${escapeHtml(date)}</div>` : ''}
                        </div>
                    `;
                }).join('');
            })
            .catch(error => {
                if (query !== currentSearch) {
                    return;
                }
                loadingIndicator.classList.add('hidden');
                errorIndicator.textContent = 'Error searching companies. Please try again.';
                errorIndicator.classList.remove('hidden');
            });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    window.selectCompany = function(companyNumber, companyName) {
        companyNumberInput.value = companyNumber;
        searchInput.value = companyName;
        resultsContainer.classList.add('hidden');
        currentSearch = null;
        // Mark the form as ready to submit
        companyNumberInput.setAttribute('required', 'required');
    };
})();
</script>
{% endblock %}
