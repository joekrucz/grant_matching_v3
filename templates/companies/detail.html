{% extends 'base.html' %}

{% block title %}{{ company.name }} - Grants Aggregator{% endblock %}

{% block content %}
<div id="page-context"
     data-page-type="company"
     data-company-id="{{ company.id }}"
     class="hidden"></div>

<style>
details summary::-webkit-details-marker {
    display: none;
}
summary .collapse-indicator::after {
    content: "⌵"; /* downwards line arrow */
    font-size: 0.9rem;
}
details[open] summary .collapse-indicator::after {
    content: "⌃"; /* upwards line arrow */
}
</style>
<div class="my-2 flex items-center">
    <a href="{% url 'companies:list' %}" class="btn btn-ghost btn-sm mr-2" aria-label="Back to Companies">
        ←
    </a>
    <h1 class="text-2xl font-bold">{{ company.name|title }}</h1>
</div>

<div class="grid md:grid-cols-[220px,1fr] gap-4">
    <div class="md:hidden mb-2">
        <div class="tabs tabs-boxed w-full overflow-x-auto">
            <a href="?tab=info" class="tab {% if current_tab == 'info' %}tab-active underline{% endif %}">Company Info</a>
            <a href="?tab=notes" class="tab {% if current_tab == 'notes' %}tab-active underline{% endif %}">Website & Notes</a>
            <a href="?tab=grants" class="tab {% if current_tab == 'grants' %}tab-active underline{% endif %}">Grants</a>
            <a href="?tab=filings" class="tab {% if current_tab == 'filings' %}tab-active underline{% endif %}">Filings</a>
            <a href="?tab=funding" class="tab {% if current_tab == 'funding' %}tab-active underline{% endif %}">Funding</a>
            {% if can_edit %}
            <a href="?tab=settings" class="tab {% if current_tab == 'settings' %}tab-active underline{% endif %}">Settings</a>
            {% endif %}
        </div>
    </div>
    <div class="hidden md:block">
        <div class="tabs tabs-vertical tabs-l flex flex-col gap-1 bg-base-200 border border-base-300 rounded-xl p-2 w-full">
            <a href="?tab=info" class="tab w-full justify-start {% if current_tab == 'info' %}tab-active underline{% endif %}" data-company-tab="info">
                Company Information
            </a>
            <a href="?tab=notes" class="tab w-full justify-start {% if current_tab == 'notes' %}tab-active underline{% endif %}" data-company-tab="notes">
                Website & Notes
            </a>
            <a href="?tab=grants" class="tab w-full justify-start {% if current_tab == 'grants' %}tab-active underline{% endif %}" data-company-tab="grants">
                Historic Grants
            </a>
            <a href="?tab=filings" class="tab w-full justify-start {% if current_tab == 'filings' %}tab-active underline{% endif %}" data-company-tab="filings">
                Account Filings
            </a>
            <a href="?tab=funding" class="tab w-full justify-start {% if current_tab == 'funding' %}tab-active underline{% endif %}" data-company-tab="funding">
                Funding Searches
            </a>
            {% if can_edit %}
            <a href="?tab=settings" class="tab w-full justify-start {% if current_tab == 'settings' %}tab-active underline{% endif %}" data-company-tab="settings">
                Settings
            </a>
            {% endif %}
        </div>
    </div>
    <div class="space-y-4" id="company-tab-panels">

{% if current_tab == 'info' %}
<div id="tab-info" class="card bg-base-200 border border-base-300 mb-4">
    <div class="card-body py-4 px-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-xl">Company Information</h2>
            <div class="flex items-center gap-2">
                {% if not company.is_registered %}
                <span class="badge badge-warning">Not Yet Registered</span>
                {% else %}
                <span class="badge badge-success">Registered</span>
                {% endif %}
            </div>
        </div>
        <div class="mb-4">
            <div class="text-sm font-semibold mb-1">Company Number</div>
            <div class="text-base">
                {% if company.company_number %}
                    {{ company.company_number }}
                {% else %}
                    N/A
                {% endif %}
            </div>
        </div>
        <div class="mb-4">
            <div class="text-sm font-semibold mb-1">Status</div>
            <div class="text-base">
                {% if company.status %}
                    {{ company.status }}
                {% else %}
                    N/A
                {% endif %}
            </div>
        </div>
        <div class="mb-6">
            <div class="text-sm font-semibold mb-1">Date of Creation</div>
            <div class="text-base">
                {% if company.date_of_creation %}
                    {{ company.date_of_creation|date:"M d, Y" }}
                {% else %}
                    N/A
                {% endif %}
            </div>
        </div>
        
        {% if company.formatted_address %}
        <div class="mb-4">
            <div class="text-sm font-semibold mb-1">Address</div>
            <div>{{ company.formatted_address }}</div>
        </div>
        {% endif %}
        
        {% if company.sic_codes_array %}
        <div class="mb-4">
            <div class="text-sm font-semibold mb-1">SIC Codes</div>
            <div class="flex flex-wrap gap-1">
                {% for code in company.sic_codes_array %}
                <span class="badge badge-outline">{{ code }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if current_tab == 'notes' %}
<div id="tab-notes" class="card bg-base-200 border border-base-300 mb-4">
    <div class="card-body py-4 px-4">
        <h2 class="card-title text-xl mb-4">Website & Notes</h2>
        {% if can_edit %}
        <form method="post" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <div class="form-control">
                <label class="label" for="id_website">
                    <span class="label-text">Website</span>
                </label>
                <input 
                    type="url" 
                    name="website" 
                    id="id_website" 
                    value="{{ company.website|default:'' }}" 
                    class="input input-bordered"
                >
            </div>
            <div class="form-control">
                <label class="label" for="id_company_file">
                    <span class="label-text">Upload File</span>
                </label>
                <input 
                    type="file" 
                    name="company_file" 
                    id="id_company_file" 
                    class="file-input file-input-bordered w-full"
                >
            </div>
            <div class="form-control">
                <button type="submit" class="btn btn-primary btn-sm">Save</button>
            </div>
        </form>
        {% else %}
        {% if company.website %}
        <div class="mb-3">
            <div class="text-sm font-semibold mb-1">Website</div>
            <a href="{{ company.website }}" target="_blank" class="link link-primary">
                {{ company.website }}
            </a>
        </div>
        {% endif %}
        {% endif %}
        <div class="divider my-6">Notes</div>

        {% if can_edit %}
        <div class="mb-6">
            <form method="post" action="{% url 'companies:note_create' company.id %}" class="space-y-3">
                {% csrf_token %}
                <div class="form-control">
                    <label class="label" for="id_note_title">
                        <span class="label-text">Title (optional)</span>
                    </label>
                    <input
                        type="text"
                        name="title"
                        id="id_note_title"
                        class="input input-bordered"
                        placeholder="e.g. Call with founder, Eligibility check, Next steps"
                    >
                </div>
                <div class="form-control">
                    <label class="label" for="id_note_body">
                        <span class="label-text">Note</span>
                    </label>
                    <textarea
                        name="body"
                        id="id_note_body"
                        rows="3"
                        class="textarea textarea-bordered"
                        placeholder="Add a note about this company..."
                    ></textarea>
                </div>
                <div class="form-control">
                    <button type="submit" class="btn btn-success btn-sm">Add Note</button>
                </div>
            </form>
        </div>
        {% endif %}

        {% if notes %}
        <div class="space-y-3">
            {% for note in notes %}
            <div class="border border-base-300 rounded-lg p-3 bg-base-100">
                <div class="flex justify-between items-start gap-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            {% if note.title %}
                            <div class="font-semibold text-sm">{{ note.title }}</div>
                            {% else %}
                            <div class="font-semibold text-sm text-base-content/70">Note</div>
                            {% endif %}
                            <div class="text-xs text-base-content/60">
                                {{ note.created_at|date:"M d, Y H:i" }} by {{ note.user.name|default:note.user.email }}
                            </div>
                        </div>
                        <div class="text-sm whitespace-pre-wrap">{{ note.body }}</div>
                    </div>
                    {% if can_edit %}
                    <form method="post" action="{% url 'companies:note_delete' note.id %}">
                        {% csrf_token %}
                        <button
                            type="submit"
                            class="btn btn-ghost btn-xs text-error"
                            onclick="return confirm('Delete this note?');"
                        >
                            Delete
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-sm text-base-content/60">
            No notes yet for this company.
            {% if can_edit %}Use the form above to add the first one.{% endif %}
        </div>
        {% endif %}

        {% if company_files %}
        <div class="mt-4">
            <div class="text-sm font-semibold mb-2">Files</div>
            <div class="space-y-2 text-sm">
                {% for f in company_files %}
                <div class="flex items-center justify-between rounded-lg border border-base-300 px-3 py-2">
                    <div class="flex-1">
                        <a href="{{ f.file.url }}" class="link link-primary" target="_blank" rel="noopener noreferrer">
                            {{ f.original_name|default:f.file.name }}
                        </a>
                        <div class="text-base-content/60">Uploaded {{ f.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                    {% if can_edit %}
                    <form method="post" action="{% url 'companies:file_delete' f.id %}">
                        {% csrf_token %}
                        <button class="btn btn-ghost btn-xs text-error" type="submit">Delete</button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if current_tab == 'grants' %}
{% with grants_data=company.grants_received_360 %}
<div id="tab-grants" class="card bg-base-200 border border-base-300 mb-4">
    <div class="card-body py-4 px-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-xl">Historic Grants (360Giving)</h2>
            <div class="flex items-center gap-3">
                <div class="text-sm text-base-content/70">
                    {% if grants_data.count %}{{ grants_data.count }} recorded grant{{ grants_data.count|pluralize }}{% else %}No grants found yet{% endif %}
                    {% if grants_data.fetched_at %} • fetched {{ grants_data.fetched_at }}{% endif %}
                </div>
                {% if can_edit %}
                <form method="post" action="{% url 'companies:grants_refresh' company.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline">Refresh</button>
                </form>
                {% endif %}
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Amount Awarded</th>
                        <th>Award Date</th>
                        <th>Funder</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grant in grants_data.grants %}
                    <tr>
                        <td class="whitespace-pre-wrap">{{ grant.title|default:'-' }}</td>
                        <td class="whitespace-normal text-sm text-base-content/80">
                            {% if grant.description %}
                                {{ grant.description|truncatechars:160 }}
                            {% else %}
                                <span class="text-base-content/60">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if grant.amountAwarded %}
                                £{{ grant.amountAwarded }}
                            {% else %}
                                <span class="text-base-content/60">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if grant.awardDate %}
                                {{ grant.awardDate }}
                            {% else %}
                                <span class="text-base-content/60">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if grant.funder %}
                                {{ grant.funder }}
                            {% else %}
                                <span class="text-base-content/60">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-base-content/60">No grants recorded.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endwith %}
{% endif %}

{% if current_tab == 'filings' %}
<div id="tab-filings" class="card bg-base-200 border border-base-300 mb-4">
    <div class="card-body py-4 px-4">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <h2 class="card-title text-xl">Account Filings</h2>
            </div>
            <div class="flex items-center gap-3">
                {% if company.filing_history.fetched_at %}
                <div class="text-sm text-base-content/60">Last updated: {{ company.filing_history.fetched_at }}</div>
                {% endif %}
                {% if can_edit and company.company_number %}
                <form method="post" action="{% url 'companies:filings_refresh' company.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline" type="submit">Refresh</button>
                </form>
                {% endif %}
            </div>
        </div>

        {% if company.filing_history and company.filing_history.items %}
            {% with account_filings=company.get_account_filings %}
                {% if account_filings %}
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>Financial Year</th>
                                <th>Accounts Made Up To</th>
                                <th>Account Type</th>
                                <th>Filing Status</th>
                                <th>View Document</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for filing in account_filings %}
                            <tr>
                                <td>
                                    {% if filing.financial_year %}
                                        <span class="font-semibold">{{ filing.financial_year }}</span>
                                    {% else %}
                                        <span class="text-base-content/60">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if filing.made_up_to_date %}
                                        <span class="font-semibold">{{ filing.made_up_to_date }}</span>
                                    {% else %}
                                        <span class="text-base-content/60">Not specified</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if filing.account_type and filing.account_type != 'Unknown' %}
                                        <span class="badge badge-primary">{{ filing.account_type }}</span>
                                    {% else %}
                                        <span class="badge badge-ghost">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if filing.filing_status %}
                                        {% if filing.filing_status == 'On Time' %}
                                            <span class="badge badge-success">
                                                On Time
                                                {% if filing.filing_status_days and filing.filing_status_days > 0 %}
                                                    ({{ filing.filing_status_days }} day{{ filing.filing_status_days|pluralize }} early)
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge badge-error">
                                                Late
                                                {% if filing.filing_status_days %}
                                                    ({{ filing.filing_status_days }} day{{ filing.filing_status_days|pluralize }})
                                                {% endif %}
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-base-content/60">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if filing.document_link %}
                                        <a 
                                            href="{{ filing.document_link }}" 
                                            target="_blank" 
                                            class="btn btn-sm btn-outline"
                                            rel="noopener noreferrer"
                                        >
                                            View PDF
                                        </a>
                                    {% else %}
                                        <span class="text-base-content/60">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-sm text-base-content/70">No filings available yet for this company.</div>
                {% endif %}
            {% endwith %}
        {% else %}
            <div class="text-sm text-base-content/70">No filings available yet for this company.</div>
        {% endif %}
        
        {% if company.company_number %}
        <div class="mt-4">
            <a 
                href="https://find-and-update.company-information.service.gov.uk/company/{{ company.company_number }}/filing-history" 
                target="_blank" 
                class="btn btn-outline btn-sm"
            >
                View Full Filing History on Companies House →
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if current_tab == 'funding' %}
<div id="tab-funding" class="card bg-base-200 border border-base-300">
    <div class="card-body py-4 px-4">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <h2 class="card-title text-xl">Funding Searches</h2>
            </div>
            <span class="text-sm text-base-content/70">{{ funding_searches|length }} search{{ funding_searches|length|pluralize }}</span>
        </div>
        <div class="flex justify-between items-center mb-4">
            <div></div>
            <a href="{% url 'companies:funding_search_create' company.id %}" 
               target="_blank"
               class="btn btn-primary btn-sm">
                Add Funding Search
            </a>
        </div>
        
        {% if funding_searches %}
        <div class="space-y-2">
            {% for search in funding_searches %}
            <div class="card bg-base-300 border border-base-300">
                <div class="card-body py-3">
                    <a href="{% url 'companies:funding_search_detail' search.id %}" class="card-title text-lg link link-primary">
                        {{ search.name }}
                    </a>
                    {% if search.trl_levels or search.trl_level %}
                    <div class="flex flex-wrap gap-1 mt-1">
                        {% if search.trl_levels %}
                            {% for trl in search.trl_levels %}
                            <div class="badge badge-outline">{{ trl }}</div>
                            {% endfor %}
                        {% elif search.trl_level %}
                            <div class="badge badge-outline">{{ search.trl_level }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-sm text-base-content/70">No funding searches yet for this company.</div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if can_edit and current_tab == 'settings' %}
<div id="tab-settings" class="card bg-base-200 border border-base-300">
    <div class="card-body py-4 px-4 space-y-4">
        <h2 class="card-title text-xl">Settings</h2>
        <form method="post"
              action="{% url 'companies:delete' company.id %}"
              onsubmit="return confirm('Delete this company? This cannot be undone.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-error btn-sm">
                Delete Company
            </button>
        </form>
    </div>
</div>
{% endif %}

    </div>
</div>


{% endblock %}
