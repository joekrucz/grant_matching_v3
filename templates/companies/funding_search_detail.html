{% extends 'base.html' %}
{% load percentage %}
{% load json_filter %}
{% load grant_filters %}
{% load static %}

{% block title %}{{ funding_search.name }} - Grants Aggregator{% endblock %}

{% block content %}
<script>
    // Toast notification system for user feedback
    function showToast(message, type = 'error') {
        const toast = document.createElement('div');
        toast.className = `alert fixed top-4 right-4 z-50 shadow-lg max-w-md ${type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert-info'}`;
        toast.innerHTML = `
            <span>${escapeHtml(message)}</span>
            <button class="btn btn-sm btn-ghost" onclick="this.parentElement.remove()">×</button>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Show pre-flight progress indicator
    function showPreflightProgress() {
        const statusAlert = document.getElementById('preflight-status-alert');
        const preflightButton = document.getElementById('preflight-button');
        
        if (statusAlert) {
            statusAlert.classList.remove('hidden');
        }
        
        if (preflightButton) {
            preflightButton.disabled = true;
            preflightButton.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Running...';
        }
    }
    
    // Real-time progress polling for matching status
    let progressPollInterval = null;
    
    function startProgressPolling(fundingSearchId) {
        // Clear any existing interval
        if (progressPollInterval) {
            clearInterval(progressPollInterval);
        }
        
        // Poll every 1 second for real-time updates
        progressPollInterval = setInterval(function() {
            fetch(`/companies/funding_searches/${fundingSearchId}/status`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update button text with progress
                    const buttonText = document.getElementById('matching-button-text');
                    const cancelForm = document.getElementById('cancel-matching-form');
                    
                    if (buttonText) {
                        const percentage = data.progress.percentage || 0;
                        const current = data.progress.current || 0;
                        const total = data.progress.total || 0;
                        const stage = data.progress.stage || 'matching';
                        
                        // Update button text - show progress during matching stage
                        if (stage === 'matching' && total > 0) {
                            buttonText.textContent = `Matching in progress... ${current} of ${total} grants checked (${percentage.toFixed(1)}%)`;
                        } else if (stage === 'processing_sources' || stage === 'ready_to_match') {
                            buttonText.textContent = 'Matching in progress...';
                        } else {
                            buttonText.textContent = `Matching in progress... ${current} of ${total} grants checked (${percentage.toFixed(1)}%)`;
                        }
                    }
                    
                    // Show cancel button if running and not already visible
                    if (data.status === 'running' && !cancelForm) {
                        const matchingForm = document.getElementById('matching-form');
                        if (matchingForm) {
                            const formContainer = matchingForm.parentElement;
                            if (formContainer) {
                                const cancelFormHtml = `
                                    <form method="post" action="{% url 'companies:funding_search_cancel' funding_search.id %}" id="cancel-matching-form">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-error btn-lg" id="cancel-matching-btn">Cancel</button>
                                    </form>
                                `;
                                formContainer.insertAdjacentHTML('beforeend', cancelFormHtml);
                            }
                        }
                    }
                    
                    // If status changed from 'running', stop polling and reload page
                    if (data.status !== 'running') {
                        clearInterval(progressPollInterval);
                        progressPollInterval = null;
                        
                        // Reload page to show final results
                        if (data.status === 'completed' || data.status === 'error' || data.status === 'cancelled') {
                            setTimeout(() => {
        window.location.reload();
                            }, 500);
                        }
                    }
                })
                .catch(error => {
                    // Silently handle polling errors - they're expected if server is unavailable
                    // Errors are logged server-side if needed
                });
        }, 1000); // Poll every 1 second
    }
    
    // Function to sort list view cards by recalculated overall match score (descending)
    // This ensures the list view is ordered by the frontend-calculated score, not the database match_score
    // Defined in global scope so it can be called from any DOMContentLoaded listener
    function sortListViewCardsByOverallMatchScore() {
        const listViewContainer = document.getElementById('list-view');
        const remainingGrantsListContainer = document.getElementById('remaining-grants-list');
        
        function sortCardsByOverallMatchScore(container) {
            if (!container) return;
            
            const cards = Array.from(container.querySelectorAll('.card[data-match-id]'));
            cards.sort(function(a, b) {
                // Check if either card is excluded (has "Excluded" badge)
                const badgesA = a.querySelectorAll('.badge-error');
                const badgesB = b.querySelectorAll('.badge-error');
                let isExcludedA = false;
                let isExcludedB = false;
                
                // Check if any error badge contains "Excluded" text
                badgesA.forEach(function(badge) {
                    if (badge.textContent.trim() === 'Excluded') {
                        isExcludedA = true;
                    }
                });
                badgesB.forEach(function(badge) {
                    if (badge.textContent.trim() === 'Excluded') {
                        isExcludedB = true;
                    }
                });
                
                // Excluded grants go to the bottom
                if (isExcludedA && !isExcludedB) return 1;  // A goes after B
                if (!isExcludedA && isExcludedB) return -1; // B goes after A
                
                // If both excluded or both not excluded, sort by score
                const scoreA = a.querySelector('.overall-match-score');
                const scoreB = b.querySelector('.overall-match-score');
                
                // Parse the percentage from the text content (e.g., "85%" -> 85)
                const percentageA = scoreA ? parseFloat(scoreA.textContent.replace('%', '')) || 0 : 0;
                const percentageB = scoreB ? parseFloat(scoreB.textContent.replace('%', '')) || 0 : 0;
                
                // Sort descending (highest first)
                return percentageB - percentageA;
            });
            
            // Re-insert cards in sorted order
            cards.forEach(function(card) {
                container.appendChild(card);
            });
        }
        
        // Sort both list view containers
        sortCardsByOverallMatchScore(listViewContainer);
        sortCardsByOverallMatchScore(remainingGrantsListContainer);
    }
    
    // Start polling if matching is running
    {% if funding_search.matching_status == 'running' %}
    var fundingSearchId = {{ funding_search.id }};
    document.addEventListener('DOMContentLoaded', function() {
        startProgressPolling(fundingSearchId);
    });
    {% endif %}
    
    // Auto-upload file when selected
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('file-input');
        const fileForm = document.getElementById('file-upload-form');
        
        if (fileInput && fileForm) {
            fileInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    // Show loading state
                    const button = this.closest('form').querySelector('button');
                    if (button) {
                        button.disabled = true;
                        button.innerHTML = '<span class="loading loading-spinner loading-sm"></span>';
                    }
                    
                    // Submit form automatically
                    fileForm.submit();
                }
            });
        }
    });
</script>
<style>
    .card.bg-base-200 {
        width: 100%;
    }
    /* Prevent flash of wrong view on page load - set initial state */
    {% if current_tab == 'results' %}
    {% if current_view == 'grid' %}
    #list-view { display: none; }
    #grid-view { display: grid; }
    #remaining-grants-list { display: none; }
    #remaining-grants-grid { display: grid; }
    {% else %}
    #list-view { display: block; }
    #grid-view { display: none; }
    #remaining-grants-list { display: block; }
    #remaining-grants-grid { display: none; }
                    {% endif %}
    {% endif %}
    
    /* Add blur effect to grant modal backdrop */
    #grant-modal::backdrop {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }
    
    /* Add blur effect to TRL info modal backdrop */
    #trl-info-modal::backdrop {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }
</style>
<div class="grid md:grid-cols-[220px,1fr] gap-4">
    <div class="space-y-4 sticky top-20 self-start max-h-[calc(100vh-5rem)] overflow-y-auto z-10">
        <div class="flex flex-col gap-2 mb-4">
                <div class="flex items-center justify-between gap-2 group" id="name-editor-container">
                <div class="flex items-center gap-2">
                    <h1 class="text-xl font-bold" id="funding-search-name">{{ funding_search.name }}</h1>
            </div>
            {% if can_edit %}
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-sm btn-ghost">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                </div>
                <ul tabindex="0" class="dropdown-content z-[9999] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li>
                        <button type="button" class="w-full text-left" onclick="this.closest('.dropdown').querySelector('[tabindex=\"0\"][role=\"button\"]').blur(); editName();">Rename</button>
                    </li>
                    <li>
                        <form method="post" action="{% url 'companies:funding_search_copy' funding_search.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="w-full text-left">Make a copy</button>
                        </form>
                    </li>
                    <li>
                        <form method="post" action="{% url 'companies:funding_search_delete' funding_search.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this funding search? This action cannot be undone.');">
                            {% csrf_token %}
                            <button type="submit" class="w-full text-left text-error">Delete</button>
                        </form>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
            <a href="{% url 'companies:detail' funding_search.company.id %}" class="link link-hover text-base-content/70 hover:text-primary text-xs">
                    {{ funding_search.company.name }}
                </a>
        </div>
        <div class="md:hidden mb-2">
            <div class="tabs tabs-boxed w-full overflow-x-auto">
                <a href="?tab=setup" class="tab {% if current_tab == 'setup' %}tab-active font-bold{% else %}hover:underline{% endif %}">Grant Matching Setup</a>
                <a href="?tab=preflight" class="tab {% if current_tab == 'preflight' %}tab-active font-bold{% else %}hover:underline{% endif %}">Pre-flight Checks</a>
                <a href="?tab=results" class="tab {% if current_tab == 'results' %}tab-active font-bold{% else %}hover:underline{% endif %}">Grant Matching Results</a>
                {% if can_edit %}
                <a href="?tab=settings" class="tab {% if current_tab == 'settings' %}tab-active font-bold{% else %}hover:underline{% endif %}">Settings</a>
                {% endif %}
            </div>
        </div>
        <div class="hidden md:block">
            <div class="tabs tabs-vertical tabs-l flex flex-col gap-1 bg-base-200 border border-base-300 rounded-xl p-2 w-full">
                <a href="?tab=setup" class="tab w-full justify-start {% if current_tab == 'setup' %}tab-active font-bold{% else %}hover:underline{% endif %}" data-funding-tab="setup">
                    Grant Matching Setup
                </a>
                <a href="?tab=preflight" class="tab w-full justify-start {% if current_tab == 'preflight' %}tab-active font-bold{% else %}hover:underline{% endif %}" data-funding-tab="preflight">
                    Pre-flight Checks
                </a>
                <a href="?tab=results" class="tab w-full justify-start {% if current_tab == 'results' %}tab-active font-bold{% else %}hover:underline{% endif %}" data-funding-tab="results">
                    Grant Matching Results
                </a>
                {% if can_edit %}
                <a href="?tab=settings" class="tab w-full justify-start {% if current_tab == 'settings' %}tab-active font-bold{% else %}hover:underline{% endif %}" data-funding-tab="settings">
                    Settings
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="space-y-4" id="funding-tab-panels">

{% if current_tab == 'setup' %}
<div id="tab-setup" class="card bg-base-200 border border-base-300">
            <div class="card-body">
        <h2 class="card-title text-lg mb-4">Grant Matching Setup</h2>
        
        {% if can_edit %}
        <!-- Questionnaire Management Section -->
        <div class="mb-6 p-4 bg-base-100 rounded-lg border border-base-300">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-base font-semibold">Questionnaire</h3>
                <a href="{% url 'companies:questionnaires_list' %}" class="btn btn-sm btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Manage Questionnaires
                </a>
            </div>
            
            {% if funding_search.questionnaire %}
            <div class="mb-3 flex items-center gap-2 flex-wrap">
                <div class="badge badge-primary">
                    Using: {{ funding_search.questionnaire.name }}
                </div>
                {% if funding_search.questionnaire.last_used_at %}
                <span class="text-xs text-base-content/60">
                    Applied: {{ funding_search.questionnaire.last_used_at|date:"M d, Y" }}
                </span>
                {% endif %}
                <form method="post" action="{% url 'companies:questionnaire_unlink' funding_search.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to unlink this questionnaire? The questionnaire data will remain, but it will no longer be associated with this funding search.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-xs btn-ghost text-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Unlink
                    </button>
                </form>
            </div>
            {% endif %}
            
            {% if questionnaires %}
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-sm btn-primary">
                    Apply Questionnaire
                </label>
                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 z-[1]">
                    {% for questionnaire in questionnaires %}
                    <li>
                        <a href="{% url 'companies:questionnaire_apply' questionnaire.id funding_search.id %}">
                            {{ questionnaire.name }}{% if questionnaire.is_default %} (Default){% endif %}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% else %}
            <p class="text-xs text-base-content/60">No questionnaires available. <a href="{% url 'companies:questionnaires_list' %}" class="link link-primary">Create one</a></p>
            {% endif %}
        </div>
        {% endif %}
        
                                {% if funding_search.matching_status == 'running' %}
        <div class="mb-4">
                                <div class="badge badge-warning">Locked - Matching in progress</div>
                            </div>
        {% endif %}
        
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Attachments -->
                        <div class="border border-base-300 rounded-lg p-4 bg-white">
                            <div class="flex justify-between items-center mb-3">
                                <div class="font-semibold">
                                    Attachments
                                    {% if total_attachments_count > 0 %}({{ total_attachments_count }}){% endif %}
                    </div>
        {% if can_edit %}
                        <form method="post" enctype="multipart/form-data" action="{% url 'companies:funding_search_upload' funding_search.id %}" id="file-upload-form" class="inline-block">
            {% csrf_token %}
                    <input 
                            type="file" 
                            name="file" 
                            accept=".pdf,.docx,.txt" 
                                id="file-input"
                                class="hidden"
                                {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                            >
                            <button 
                                type="button" 
                                class="btn btn-circle btn-primary btn-sm"
                                onclick="document.getElementById('file-input').click()"
                                {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </form>
                    {% endif %}
                </div>
                            <div class="space-y-2">
                                {% for file in uploaded_files %}
                                <div class="flex items-center gap-3 p-2 bg-base-200 rounded group">
                                    <div class="badge badge-outline">File</div>
                                    <div class="flex-1">
                                        <div class="font-medium text-xs">{{ file.original_name|default:file.file.name }}</div>
                                        <div class="text-xs text-base-content/60">
                                            Uploaded {{ file.created_at|date:"M d, Y" }} by {{ file.uploaded_by.name|default:file.uploaded_by.email }}
                                        </div>
                                    </div>
                {% if can_edit %}
                                    <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <form method="post" action="{% url 'companies:funding_search_delete_file' funding_search.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this file? This action cannot be undone.');">
                    {% csrf_token %}
                                            <input type="hidden" name="file_id" value="{{ file.id }}">
                                            <button type="submit" class="btn btn-ghost btn-sm text-error hover:bg-error/20 p-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                    {% endif %}
                            </div>
                                {% endfor %}
                                
                                {% if funding_search.uploaded_file %}
                                <div class="flex items-center gap-3 p-2 bg-base-200 rounded group">
                                    <div class="badge badge-outline">File</div>
                                    <div class="flex-1">
                                        <div class="font-medium text-xs">{{ uploaded_file_name|default:funding_search.uploaded_file.name }}</div>
                                        <div class="text-xs text-base-content/60">Legacy file</div>
                                    </div>
                {% if can_edit %}
                                    <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <form method="post" action="{% url 'companies:funding_search_delete_file' funding_search.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this file? This action cannot be undone.');">
                    {% csrf_token %}
                                            <button type="submit" class="btn btn-ghost btn-sm text-error hover:bg-error/20 p-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </form>
                    </div>
                            {% endif %}
                                </div>
                                {% endif %}
                            </div>
                    </div>
                    
                        <!-- Company Information (Always Included) -->
                    <div class="border border-base-300 rounded-lg p-4 bg-white">
                        <div class="flex justify-between items-center mb-3">
                            <div class="font-semibold">
                                Company Information
                                <span class="text-xs font-normal text-base-content/70 ml-2">(Always included)</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="text-sm text-base-content/70">
                                The following company information is automatically included in all matching:
                            </div>
                            <ul class="list-disc list-inside text-sm space-y-1 ml-2">
                                <li>Company registration details (name, number, status, type)</li>
                                <li>SIC codes and descriptions</li>
                                <li>Registered address</li>
                                {% if funding_search.company.website %}
                                <li>Company website content</li>
                                {% endif %}
                                {% if funding_search.company.grants_received_360 and funding_search.company.grants_received_360.grants %}
                                <li>Grant history from 360Giving ({{ funding_search.company.grants_received_360.grants|length }} grant{{ funding_search.company.grants_received_360.grants|length|pluralize }})</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Uploaded Files -->
                    {% if selected_files %}
                    <div class="border border-base-300 rounded-lg p-4 bg-white">
                        <div class="flex justify-between items-center mb-3">
                            <div class="font-semibold">
                                Uploaded Files
                                <span class="text-xs font-normal text-base-content/70 ml-2">({{ selected_files|length }} file{{ selected_files|length|pluralize }})</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            {% for file in selected_files %}
                            <div class="flex items-center gap-3 p-2 bg-base-200 rounded">
                                <div class="badge badge-outline">File</div>
                                <div class="flex-1">
                                    <div class="font-medium text-xs">{{ file.original_name|default:file.file.name }}</div>
                                    <div class="text-xs text-base-content/60">
                                        Uploaded {{ file.created_at|date:"M d, Y" }} by {{ file.uploaded_by.name|default:file.uploaded_by.email }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    </div>
                    
                    <!-- Selected Company Notes -->
                    {% if selected_notes %}
                    <div class="border border-base-300 rounded-lg p-4">
                        <div class="font-semibold mb-3">Company Notes ({{ selected_notes|length }})</div>
                        <div class="space-y-3">
                            {% for note in selected_notes %}
                            <div class="p-3 bg-base-200 rounded">
                                <div class="flex items-start gap-2 mb-2">
                                    <div class="badge badge-outline">Note</div>
                                    {% if note.title %}
                                    <div class="font-medium text-xs">{{ note.title }}</div>
                                    {% endif %}
                                </div>
                                <p class="text-xs text-base-content/70 mb-2">{{ note.body|truncatewords:30 }}</p>
                                <div class="text-xs text-base-content/60">
                                    Created {{ note.created_at|date:"M d, Y" }} by {{ note.user.name|default:note.user.email }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                </div>
                    {% endif %}
        </div>
        
                <!-- TRL Levels and Grant Sources -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <!-- TRL Levels Selection -->
                    <div class="border border-base-300 rounded-lg p-4 bg-white">
                {% if can_edit %}
                <form method="post" id="trl-levels-form" {% if funding_search.matching_status == 'running' %}onsubmit="return false;"{% endif %}>
                    {% csrf_token %}
                    {# Preserve grant sources when submitting TRL levels form #}
                    {% if funding_search.selected_grant_sources %}
                        {% for source_code in funding_search.selected_grant_sources %}
                            <input type="hidden" name="grant_sources" value="{{ source_code }}">
                        {% endfor %}
                    {% endif %}
                                    <div class="form-control">
                                        <div class="flex items-center gap-4 flex-wrap mb-3">
                                            <h3 class="text-sm font-semibold flex items-center gap-2">
                                TRL Levels
                                <div class="tooltip tooltip-right" data-tip="Click to view TRL level explanations">
                                    <button type="button" class="btn btn-ghost btn-xs btn-circle" onclick="document.getElementById('trl-info-modal').showModal()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
            </div>
                                            </h3>
                                        </div>
                                        <label class="label cursor-pointer gap-2 justify-start">
                                    <input type="checkbox" name="let_system_decide_trl" id="let-system-decide-trl" class="checkbox checkbox-sm" {% if funding_search.let_system_decide_trl != False %}checked{% endif %} {% if funding_search.matching_status == 'running' %}disabled{% endif %}>
                                            <span class="label-text text-xs">Let system decide</span>
                        </label>
                        <div class="relative mb-2" style="padding: 0.5rem 0;" id="trl-slider-container">
                            <div class="relative" style="height: 20px;">
                                <input type="range" min="1" max="9" value="1" step="1" class="absolute w-full h-2 bg-transparent appearance-none cursor-pointer" id="trl-range-min" style="z-index: 2;" {% if funding_search.matching_status == 'running' or funding_search.let_system_decide_trl %}disabled{% endif %}>
                                <input type="range" min="1" max="9" value="9" step="1" class="absolute w-full h-2 bg-transparent appearance-none cursor-pointer" id="trl-range-max" style="z-index: 3;" {% if funding_search.matching_status == 'running' or funding_search.let_system_decide_trl %}disabled{% endif %}>
                                <div class="absolute w-full h-2 bg-base-300 rounded-full" style="top: 50%; transform: translateY(-50%); pointer-events: none;"></div>
                                <div id="trl-range-track" class="absolute h-2 bg-primary rounded-full" style="top: 50%; transform: translateY(-50%); pointer-events: none;"></div>
        </div>
                            <div class="flex justify-between text-xs text-base-content/60 mt-1" style="padding: 0 10px;">
                                {% for i in "123456789" %}
                                <span>{{ i }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {# Hidden inputs to store selected TRL levels #}
                        <div id="trl-levels-hidden-inputs"></div>
                    </div>
                </form>
                
                <!-- TRL Info Modal -->
                <dialog id="trl-info-modal" class="modal">
                    <div class="modal-box">
                        <h3 class="font-bold text-base mb-4">TRL Level Explanations</h3>
                        <div class="space-y-3">
                                {% for value, label in trl_levels %}
                            <div class="border-b border-base-300 pb-2 last:border-b-0">
                                <div class="font-semibold text-[0.625rem] leading-tight">{{ value }}</div>
                                <div class="text-[0.625rem] text-base-content/70 mt-1 leading-tight">{{ label }}</div>
                            </div>
                                {% endfor %}
                    </div>
                        <div class="modal-action">
                            <form method="dialog">
                                <button class="btn">Close</button>
                            </form>
                    </div>
                    </div>
                    <form method="dialog" class="modal-backdrop">
                        <button>close</button>
                </form>
                </dialog>
                {% else %}
                <!-- Display TRL levels for non-editors -->
                {% if funding_search.trl_levels or funding_search.trl_level %}
                                <div>
                    <div class="text-xs font-semibold mb-2">TRL Levels</div>
                    <div class="flex flex-wrap gap-2">
                        {% for trl_value in funding_search.trl_levels %}
                        {% for value, label in trl_levels %}
                                {% if value == trl_value %}
                                <span class="badge badge-primary">{{ label }}</span>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {% if funding_search.trl_level and funding_search.trl_level not in funding_search.trl_levels %}
                            {% for value, label in trl_levels %}
                                {% if value == funding_search.trl_level %}
                                <span class="badge badge-primary">{{ label }}</span>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
        </div>
                
                            <!-- Grant Sources Selection -->
                            <div class="border border-base-300 rounded-lg p-4 bg-white">
                                <div class="flex items-center justify-between gap-4 flex-wrap mb-3">
                                    <h3 class="text-sm font-semibold">Grant Sources</h3>
                                    <div class="flex items-center gap-2">
                                        {% if funding_search.matching_status == 'running' %}
                                        <div class="badge badge-warning">Locked - Matching in progress</div>
                                        {% elif can_edit %}
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                id="select-all-grant-sources"
                                                class="checkbox checkbox-primary checkbox-sm"
                                            >
                                            <span class="text-xs text-base-content/70">Select All</span>
                                        </label>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if can_edit %}
                                <form method="post" id="grant-sources-form" {% if funding_search.matching_status == 'running' %}onsubmit="return false;"{% endif %} class="flex flex-col gap-2">
                                            {% csrf_token %}
                                    {# Preserve TRL levels when submitting grant sources form #}
                                    {% if funding_search.trl_levels %}
                                        {% for trl_level in funding_search.trl_levels %}
                                            <input type="hidden" name="trl_levels" value="{{ trl_level }}">
                                        {% endfor %}
                                    {% endif %}
                                    {% for source_code, source_name in grant_sources %}
                                    <label class="flex items-center gap-2 {% if funding_search.matching_status == 'running' %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}">
                                        <input 
                                            type="checkbox" 
                                            name="grant_sources" 
                                            value="{{ source_code }}"
                                            class="checkbox checkbox-primary grant-source-checkbox"
                                            {% if source_code in funding_search.selected_grant_sources %}checked{% endif %}
                                            {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                                            data-funding-search-id="{{ funding_search.id }}"
                                        >
                                        <img src="{% grant_source_logo source_code %}" alt="{{ source_name }}" class="h-4 w-auto" onerror="this.style.display='none'">
                                        <span class="label-text">{{ source_name }}</span>
                                    </label>
                                    {% endfor %}
                                    <div class="border-t border-base-300 pt-2 mt-2">
                                        <label class="flex items-center gap-2 {% if funding_search.matching_status == 'running' %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}">
                                            <input 
                                                type="checkbox" 
                                                name="exclude_closed_competitions" 
                                                id="exclude-closed-competitions"
                                                class="checkbox checkbox-primary grant-source-checkbox"
                                                {% if funding_search.exclude_closed_competitions != False %}checked{% endif %}
                                                {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                                            >
                                            <span class="label-text text-xs">Exclude closed competitions</span>
                                        </label>
                                    </div>
                                    <div class="border-t border-base-300 pt-3 mt-3">
                                        <div class="text-xs font-semibold mb-2 text-base-content/80">Checklist Assessment Options</div>
                                        <div class="space-y-2">
                                            <label class="flex items-start gap-2 {% if funding_search.matching_status == 'running' %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}">
                                                <input 
                                                    type="checkbox" 
                                                    name="assess_exclusions" 
                                                    id="assess-exclusions"
                                                    class="checkbox checkbox-primary grant-source-checkbox mt-0.5"
                                                    {% if funding_search.assess_exclusions != False %}checked{% endif %}
                                                    {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                                                >
                                                <span class="label-text text-xs">
                                                    Assess Exclusions Checklist 
                                                    <span class="text-xs text-base-content/60 block mt-0.5">(Recommended: Check first - if excluded, skip other assessments)</span>
                                                </span>
                                            </label>
                                            <label class="flex items-start gap-2 {% if funding_search.matching_status == 'running' %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}">
                                                <input 
                                                    type="checkbox" 
                                                    name="assess_eligibility" 
                                                    id="assess-eligibility"
                                                    class="checkbox checkbox-primary grant-source-checkbox mt-0.5"
                                                    {% if funding_search.assess_eligibility != False %}checked{% endif %}
                                                    {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                                                >
                                                <span class="label-text text-xs">
                                                    Assess Eligibility Checklist 
                                                    <span class="text-xs text-base-content/60 block mt-0.5">(Recommended: Check second - if not eligible, skip competitiveness)</span>
                                                </span>
                                            </label>
                                            <label class="flex items-start gap-2 {% if funding_search.matching_status == 'running' %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}">
                                                <input 
                                                    type="checkbox" 
                                                    name="assess_competitiveness" 
                                                    id="assess-competitiveness"
                                                    class="checkbox checkbox-primary grant-source-checkbox mt-0.5"
                                                    {% if funding_search.assess_competitiveness != False %}checked{% endif %}
                                                    {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                                                >
                                                <span class="label-text text-xs">
                                                    Assess Competitiveness Checklist 
                                                    <span class="text-xs text-base-content/60 block mt-0.5">(Recommended: Check last - only if eligible and not excluded)</span>
                                                </span>
                                            </label>
                                        </div>
                                        <div class="text-xs text-base-content/60 mt-2">
                                            Assessment order: Exclusions → Eligibility → Competitiveness (if selected)
                                        </div>
                                    </div>
                                        </form>
                                {% else %}
                                <div class="flex flex-wrap gap-2">
                                    {% if funding_search.selected_grant_sources %}
                                        {% for source_code in funding_search.selected_grant_sources %}
                                            {% for code, name in grant_sources %}
                                                {% if code == source_code %}
                                                <div class="badge badge-primary badge-outline flex items-center gap-1">
                                                    <img src="{% grant_source_logo code %}" alt="{{ name }}" class="h-4 w-auto" onerror="this.style.display='none'">
                                                    <span>{{ name }}</span>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% else %}
                                    <div class="text-xs text-base-content/70">All sources selected</div>
                    {% endif %}
                </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

{% if current_tab == 'preflight' %}
<div id="tab-preflight" class="card bg-base-200 border border-base-300">
    <div class="card-body">
        <h2 class="card-title text-lg mb-4">Pre-flight Checks</h2>

        <p class="text-sm text-base-content/70 mb-4">
            Run pre-flight checks on the input material (questionnaire, notes, files, website)
            to estimate how well-prepared this funding search is before starting a full
            grant matching job.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Input summary -->
            <div class="p-4 bg-base-100 rounded-lg border border-base-300">
                <h3 class="font-semibold mb-2 text-sm">Current inputs</h3>
                <ul class="text-xs space-y-1 text-base-content/80">
                    <li>
                        Questionnaire:
                        {% if funding_search.questionnaire %}
                            <span class="font-medium">Linked ({{ funding_search.questionnaire.name }})</span>
                        {% else %}
                            <span class="text-error">Not linked</span>
                        {% endif %}
                    </li>
                    <li>
                        Funding search files:
                        {% if uploaded_files %}
                            <span class="font-medium">{{ uploaded_files|length }} file{{ uploaded_files|length|pluralize }}</span>
                        {% else %}
                            <span class="text-warning">None uploaded</span>
                        {% endif %}
                    </li>
                    <li>
                        Company registration details:
                        <span class="font-medium">Always included</span>
                        {% if funding_search.company.company_number %}
                            <span class="text-xs text-base-content/70">(Company Number: {{ funding_search.company.company_number }})</span>
                        {% endif %}
                    </li>
                    <li>
                        Company website:
                        {% if funding_search.company.website %}
                            <span class="font-medium">Always included if available</span>
                        {% else %}
                            <span class="text-warning">No website set</span>
                        {% endif %}
                    </li>
                    <li>
                        Company grant history:
                        {% if funding_search.company.grants_received_360 and funding_search.company.grants_received_360.grants %}
                            <span class="font-medium">Always included ({{ funding_search.company.grants_received_360.grants|length }} grant{{ funding_search.company.grants_received_360.grants|length|pluralize }})</span>
                        {% else %}
                            <span class="text-warning">No grant history available</span>
                        {% endif %}
                    </li>
                </ul>
            </div>

            <!-- Pre-flight score and details -->
            <div class="p-4 bg-base-100 rounded-lg border border-base-300">
                <h3 class="font-semibold mb-2 text-sm">Pre-flight score</h3>

                {% if funding_search.preflight_result %}
                    {% with pf=funding_search.preflight_result %}
                    
                    {% if pf.recommendations %}
                    <div class="mb-4">
                        <h4 class="font-semibold text-xs mb-2">Top recommendations</h4>
                        <ul class="list-disc list-inside text-xs space-y-1">
                            {% if pf.recommendations.critical %}
                                {% for item in pf.recommendations.critical %}
                                    <li><span class="font-semibold">Critical:</span> {{ item.title|default:item }}</li>
                                {% endfor %}
                            {% endif %}
                            {% if pf.recommendations.high %}
                                {% for item in pf.recommendations.high %}
                                    <li><span class="font-semibold">High:</span> {{ item.title|default:item }}</li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}

                    {# TRL Assessment #}
                    <div class="border-t border-base-300 pt-3 mt-3">
                        <h4 class="font-semibold text-xs mb-2">TRL Assessment</h4>
                        {% if pf.trl_assessment %}
                            {% with trl=pf.trl_assessment %}
                                {% if trl.assessed_trl_level and trl.assessed_trl_level != "unknown" %}
                                    <div class="mb-2">
                                        <span class="badge badge-sm badge-info">{{ trl.assessed_trl_level }}</span>
                                        {% if trl.confidence %}
                                            <span class="text-[0.65rem] text-base-content/60 ml-2">
                                                ({{ trl.confidence }} confidence)
                                            </span>
                                        {% endif %}
                                    </div>
                                    {% if trl.reasoning %}
                                        <p class="text-xs text-base-content/70 mb-2">
                                            {{ trl.reasoning }}
                                        </p>
                                    {% endif %}
                                    {% if trl.indicators %}
                                        <div class="text-xs text-base-content/60">
                                            <span class="font-semibold">Indicators:</span>
                                            <ul class="list-disc list-inside mt-1">
                                                {% for indicator in trl.indicators %}
                                                    <li>{{ indicator }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <p class="text-xs text-base-content/70">
                                        {% if trl.reasoning %}
                                            {{ trl.reasoning }}
                                        {% else %}
                                            TRL level could not be determined from the input material.
                                        {% endif %}
                                    </p>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <p class="text-xs text-base-content/70">
                                TRL assessment not available. Please run pre-flight checks again.
                            </p>
                        {% endif %}
                    </div>

                    <p class="text-[0.65rem] text-base-content/60 mt-3">
                        Last checked:
                        {{ pf.checked_at|default:"Not available" }}
                    </p>
                    {% endwith %}
                {% else %}
                    <p class="text-xs text-base-content/70 mb-3">
                        No pre-flight checks have been run yet for this funding search.
                    </p>
                {% endif %}

                {% if can_edit %}
                <!-- Pre-flight Status Alert (hidden by default) -->
                <div id="preflight-status-alert" class="alert alert-info mt-4 hidden">
                    <div class="flex items-center gap-2">
                        <span class="loading loading-spinner loading-sm"></span>
                        <span>Running pre-flight checks... This may take a minute.</span>
                    </div>
                </div>
                
                <form method="post" action="{% url 'companies:funding_search_preflight' funding_search.id %}" id="preflight-form" onsubmit="showPreflightProgress(); return true;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-primary" id="preflight-button"
                            {% if funding_search.matching_status == 'running' %}disabled{% endif %}>
                        Run pre-flight checks
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <p class="text-xs text-base-content/60">
            Pre-flight checks do not run grant matching. They only assess the quality and completeness
            of the input material to reduce the risk of low-quality matches.
        </p>
    </div>
</div>
{% endif %}

{% if current_tab == 'results' %}
<div id="tab-results" class="card bg-base-200 border border-base-300">
    <div class="card-body pb-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-xl">Grant Matching Results</h2>
            <div class="flex items-center gap-2">
                <div class="btn-group">
                    <a href="?tab=results&view=list" class="btn btn-sm {% if current_view == 'list' %}btn-active{% endif %} view-toggle-btn" data-view="list">List</a>
                    <a href="?tab=results&view=grid" class="btn btn-sm {% if current_view == 'grid' %}btn-active{% endif %} view-toggle-btn" data-view="grid">Grid</a>
                </div>
                <div class="dropdown dropdown-end">
                    <button tabindex="0" class="btn btn-sm btn-ghost">
                        Actions
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                    </button>
                    <ul tabindex="0" class="menu menu-sm dropdown-content bg-base-100 rounded-box shadow z-10 mt-2 w-52">
                        {% if match_results %}
                        <li>
                            <a href="{% url 'companies:funding_search_download_report' funding_search.id %}">
                                Download report
                            </a>
                        </li>
                        {% endif %}
                {% if can_edit %}
                        {% if match_results %}
                        <li>
                <form method="post" action="{% url 'companies:funding_search_clear_results' funding_search.id %}" onsubmit="return confirm('Are you sure you want to clear all {{ match_results|length }} matching result{{ match_results|length|pluralize }}? This action cannot be undone.');">
                    {% csrf_token %}
                                <button type="submit">
                Clear
            </button>
                </form>
                        </li>
                {% endif %}
                        <li>
                            <form method="post" action="{% url 'companies:funding_search_match_test' funding_search.id %}">
                                {% csrf_token %}
                                <button type="submit">
                                    Test match (5 grants)
                                </button>
                            </form>
                        </li>
                        {% if funding_search.matching_status == 'completed' %}
                        <li>
                            <form method="post" action="{% url 'companies:funding_search_match' funding_search.id %}">
                                {% csrf_token %}
                                <button type="submit">
                                    Run Matching Job Again
                                </button>
                            </form>
                        </li>
                {% endif %}
                {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Matching Buttons -->
        {% if funding_search.matching_status != 'completed' %}
        <div class="flex flex-col gap-2 mb-6">
            <div class="flex gap-2">
                <form method="post" action="{% url 'companies:funding_search_match' funding_search.id %}" id="matching-form" class="flex-1">
                    {% csrf_token %}
                    <button 
                        type="submit" 
                        class="btn btn-primary btn-lg w-full" 
                        {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                        id="run-matching-btn"
                    >
                        {% if funding_search.matching_status == 'running' %}
                            <span class="loading loading-spinner loading-md"></span>
                            <span id="matching-button-text">
                                {% if funding_search.matching_progress %}
                                    Matching in progress... {{ funding_search.matching_progress.current|default:0 }} of {{ funding_search.matching_progress.total|default:0 }} grants checked ({{ funding_search.matching_progress.percentage|default:0 }}%)
                                {% else %}
                                    Matching in progress...
                                {% endif %}
                            </span>
                        {% else %}
                            Run Matching Job
                        {% endif %}
                    </button>
                </form>
                {% if funding_search.matching_status == 'running' %}
                <form method="post" action="{% url 'companies:funding_search_cancel' funding_search.id %}" id="cancel-matching-form">
                    {% csrf_token %}
                    <button 
                        type="submit" 
                        class="btn btn-error btn-lg"
                        id="cancel-matching-btn"
                    >
                        Cancel
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if not match_results %}
        <p class="text-xs text-base-content/60 text-center mb-6">
            No matching results yet. Run a matching job above to find grants that match your criteria.
        </p>
        {% else %}
        <p class="text-xs text-base-content/70 mb-6">
            Found {{ match_results|length }} matching grant{{ match_results|length|pluralize }} 
            {% if funding_search.last_matched_at %}
            (matched on {{ funding_search.last_matched_at|date:"F d, Y g:i A" }})
            {% endif %}
        </p>
        
        <!-- Top 5 Results - List View -->
        <div id="list-view" class="space-y-4 view-container" {% if current_view != 'list' %}style="display: none;"{% endif %}>
            {% for match_data in match_results_with_json|slice:":5" %}
            {% with match=match_data.match %}
            <div class="card bg-base-100 border border-base-300 {% if forloop.first %}border-2 border-primary{% endif %}" data-match-id="{{ match.id }}">
                {% if forloop.first %}
                <div class="bg-primary text-primary-content px-4 py-2 rounded-t-lg">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                        </svg>
                        <span class="font-semibold text-yellow-400">Top Match</span>
                    </div>
                </div>
                {% endif %}
                <div class="card-body pb-0">
                    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start mb-2 gap-4">
                        <div class="flex-1">
                            <h3 class="card-title text-base">
                                <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary">
                                    {{ match.grant.title }}
                                </a>
                            </h3>
                            <div class="flex gap-2 mt-2 flex-wrap">
                                <div class="badge {% if match.grant.computed_status == 'open' %}badge-success{% elif match.grant.computed_status == 'closed' %}badge-error{% else %}badge-warning{% endif %}">
                                    {{ match.grant.get_status_display }}
                                </div>
                                <span class="badge badge-primary badge-outline">{{ match.grant.get_source_display }}</span>
                                {% if match.grant.deadline %}
                                <span class="badge badge-primary badge-outline">{{ match.grant.deadline|date:"M d, Y" }}</span>
                                {% endif %}
                                {% if match.grant.trl_requirements.trl_levels %}
                                    <span class="badge badge-outline" title="Grant TRL requirements">
                                        Grant TRL: {% if match.grant.trl_requirements.trl_range %}{{ match.grant.trl_requirements.trl_range }}{% else %}{{ match.grant.trl_requirements.trl_levels|trl_levels_to_range }}{% endif %}
                                    </span>
                                {% endif %}
                                {% if match_data.is_excluded %}
                                <span class="badge badge-error">Excluded</span>
                                {% endif %}
                            </div>
                            <div class="text-base-content mt-3">
                                <div class="mt-4 -mx-4 -mb-2">
                                    <div class="collapse">
                                        <input type="checkbox" id="more-details-{{ match.id }}" />
                                        <div class="collapse-title font-semibold text-sm px-4 min-h-0 flex items-center gap-2 cursor-pointer">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            <span>Details</span>
                                        </div>
                                        <div class="collapse-content px-4 pb-2 pt-0">
                                            {% if match.match_reasons.project_type_and_trl_focus or match.match_reasons.why_it_matches or match.match_reasons.key_risks_and_uncertainties %}
                                            <div class="mt-2">
                                                <div class="font-semibold text-xs mb-2">Summary</div>
                                            <div class="space-y-2">
                                                {% if match.match_reasons.project_type_and_trl_focus %}
                                                <div class="mt-2">
                                                        <div class="font-semibold text-xs mb-1">
                                                            Project type and TRL focus
                                                        </div>
                                                        <div class="pb-2">
                                                            <p class="text-xs mt-1">{{ match.match_reasons.project_type_and_trl_focus }}</p>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if match.match_reasons.why_it_matches %}
                                                <div class="mt-2">
                                                        <div class="font-semibold text-xs mb-1">
                                                            Why it matches
                                                        </div>
                                                        <div class="pb-2">
                                                            <p class="text-xs mt-1">{{ match.match_reasons.why_it_matches }}</p>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if match.match_reasons.key_risks_and_uncertainties %}
                                                <div class="mt-2">
                                                        <div class="font-semibold text-xs mb-1">
                                                            Key risks and uncertainties
                                                        </div>
                                                        <div class="pb-2">
                                                            <p class="text-xs mt-1">{{ match.match_reasons.key_risks_and_uncertainties }}</p>
                                                    </div>
                                                </div>
                                                {% endif %}
                                </div>
                            </div>
                            {% elif match.match_reasons.explanation %}
                                            <div class="mt-2">
                                                <div class="font-semibold text-xs mb-2">Summary</div>
                                                <p class="text-xs"><strong>Summary:</strong> {{ match.match_reasons.explanation }}</p>
                                            </div>
                            {% endif %}
                            
                            {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                            <div class="mt-4">
                                                <div class="font-semibold text-xs mb-2">Checklists</div>
                                        <div class="space-y-2">
                        {% if match.match_reasons.eligibility_checklist %}
                                            <div>
                                                <div class="collapse">
                                    <input type="checkbox" />
                                                    <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                        <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                        Eligibility Checklist 
                                        <span class="text-xs font-normal text-base-content/70 eligibility-checklist-score">
                                            (calculating...)
                                        </span>
                                    </div>
                                    <div class="collapse-content px-4 pb-0 pt-2">
                                        <div class="space-y-2 eligibility-checklist-items">
                            {% for item in match.match_reasons.eligibility_checklist %}
                            <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="eligibility" data-item-index="{{ forloop.counter0 }}">
                                {% if item.status == "yes" %}
                                <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                {% elif item.status == "no" %}
                                <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                {% else %}
                                <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                {% endif %}
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium">{{ item.criterion }}</span>
                                        {% if can_edit %}
                                        <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'eligibility', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        {% if item.manually_edited %}
                                        <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'eligibility', {{ forloop.counter0 }})">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                            </svg>
                                        </button>
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                    {% if item.manually_edited %}
                                    <p class="text-xs font-bold text-accent mt-1">Manually edited</p>
                                    {% elif item.reason %}
                                    <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if match.match_reasons.competitiveness_checklist %}
                                            <div>
                                <div class="collapse">
                                    <input type="checkbox" />
                                                    <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                        <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                        Competitiveness Checklist
                                        <span class="text-xs font-normal text-base-content/70 competitiveness-checklist-score">
                                            (calculating...)
                                        </span>
                                    </div>
                                    <div class="collapse-content px-4 pb-0 pt-2">
                                        <div class="space-y-2 competitiveness-checklist-items">
                            {% for item in match.match_reasons.competitiveness_checklist %}
                            <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="competitiveness" data-item-index="{{ forloop.counter0 }}">
                                {% if item.status == "yes" %}
                                <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                {% elif item.status == "no" %}
                                <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                {% else %}
                                <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                {% endif %}
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium">{{ item.criterion }}</span>
                                        {% if can_edit %}
                                        <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'competitiveness', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        {% if item.manually_edited %}
                                        <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'competitiveness', {{ forloop.counter0 }})">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                            </svg>
                                        </button>
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                    {% if item.manually_edited %}
                                    <p class="text-xs font-bold text-accent mt-1">Manually edited</p>
                                    {% elif item.reason %}
                                    <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if match.match_reasons.exclusions_checklist %}
                                            <div>
                                <div class="collapse">
                                    <input type="checkbox" />
                                                    <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                        <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                        Exclusions Checklist
                                        <span class="text-xs font-normal text-base-content/70 exclusions-checklist-score">
                                            (calculating...)
                                        </span>
                                        <span class="exclusions-warning-icon" style="display: none; margin-left: 0.5rem;">⚠️</span>
                                    </div>
                                    <div class="collapse-content px-4 pb-0 pt-2">
                                        <div class="space-y-2 exclusions-checklist-items">
                            {% for item in match.match_reasons.exclusions_checklist %}
                            <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="exclusions" data-item-index="{{ forloop.counter0 }}">
                                        {% if item.status == "yes" %}
                                                <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                        {% elif item.status == "no" %}
                                                <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                        {% else %}
                                <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                        {% endif %}
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium">{{ item.criterion }}</span>
                                        {% if can_edit %}
                                        <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'exclusions', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        {% endif %}
                                    </div>
                                                {% if item.manually_edited %}
                                                <div class="flex items-center gap-2 mt-1">
                                                    <p class="text-xs font-bold text-accent">Manually edited</p>
                                                    {% if can_edit %}
                                                    <button type="button" class="btn btn-ghost btn-xs text-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'exclusions', {{ forloop.counter0 }})">
                                                        Undo
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                {% elif item.reason %}
                                    <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% if not match.match_reasons.eligibility_checklist and not match.match_reasons.competitiveness_checklist and not match.match_reasons.exclusions_checklist %}
                            <div class="mt-4">
                                <div class="alert alert-info">
                                    <span class="text-xs">Checklists not available. Please run a new matching job to see eligibility and competitiveness checklists.</span>
                                </div>
                            </div>
                            {% endif %}
                                            <div class="mt-4 pt-3 border-t border-base-300">
                                                <button type="button" class="btn btn-ghost btn-sm w-full" onclick="document.getElementById('more-details-{{ match.id }}').checked = false; document.getElementById('more-details-{{ match.id }}').dispatchEvent(new Event('change'));">
                                                    Hide
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="lg:text-right lg:ml-4 min-w-[200px]">
                            <div class="flex items-center justify-end gap-3 mb-3">
                                {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                <div>
                                    <svg width="90" height="90" viewBox="0 0 60 60" class="checklist-pie-chart" 
                                         data-match-id="{{ match.id }}"
                                         data-eligibility='{{ match_data.eligibility_json }}'
                                         data-competitiveness='{{ match_data.competitiveness_json }}'
                                         data-exclusions='{{ match_data.exclusions_json }}'>
                                        <circle cx="30" cy="30" r="25" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                    </svg>
                                </div>
                                {% endif %}
                                <div>
                            <div class="stat-value text-primary text-4xl overall-match-score">{{ match.match_score|percentage }}%</div>
                                    <div class="stat-desc text-xs">Overall Match</div>
                                    <div class="stat-desc text-xs mt-1 certainty-percentage" data-match-id="{{ match.id }}" {% if match_data.certainty is not None %}data-certainty="{{ match_data.certainty }}"{% endif %}>Calculating...</div>
                                </div>
                            </div>
                            {% if match.eligibility_score is not None or match.competitiveness_score is not None or match.match_reasons.exclusions_checklist %}
                            <div class="border-t border-base-300 pt-3 mt-3 score-breakdown-{{ match.id }}" style="display: none;">
                                <div class="text-xs font-bold mb-2 text-left">Score Breakdown:</div>
                                <div class="space-y-2">
                                    {% if match.eligibility_score is not None %}
                                    <div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-base-content/70">Eligibility</span>
                                            <span class="text-xs font-semibold eligibility-breakdown-percentage">
                                                {{ match.eligibility_score|percentage }}%
                                                <span class="text-xs font-normal text-base-content/60 eligibility-breakdown-count ml-1">(calculating...)</span>
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if match.competitiveness_score is not None %}
                                    <div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-base-content/70">Competitiveness</span>
                                            <span class="text-xs font-semibold competitiveness-breakdown-percentage">
                                                {{ match.competitiveness_score|percentage }}%
                                                <span class="text-xs font-normal text-base-content/60 competitiveness-breakdown-count ml-1">(calculating...)</span>
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if match.match_reasons.exclusions_checklist %}
                                    <div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-base-content/70">Exclusions</span>
                                            <span class="text-xs font-semibold exclusions-breakdown-percentage">
                                                (calculating...)
                                                <span class="text-xs font-normal text-base-content/60 exclusions-breakdown-count ml-1"></span>
                                                <span class="exclusions-breakdown-warning-icon" style="display: none; margin-left: 0.5rem;">⚠️</span>
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {# Other Checks Section #}
                                    {% if match.match_reasons.project_type_and_trl_focus %}
                                        {% if match.grant.trl_requirements %}
                                            {% if match.grant.trl_requirements.trl_levels %}
                                            <div class="border-t border-base-300 pt-3 mt-3">
                                                <div class="text-xs font-bold mb-2 text-left">Other Checks:</div>
                                                <div>
                                                    {% check_project_trl_in_grant_range match.match_reasons.project_type_and_trl_focus match.grant.trl_requirements as trl_check_status %}
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-xs text-base-content/70">TRL Range</span>
                                                        <span class="text-xs font-semibold">
                                                            {% if trl_check_status == "yes" %}
                                                                <span class="text-success">✓</span>
                                                            {% elif trl_check_status == "no" %}
                                                                <span class="text-error">✗</span>
                                                            {% else %}
                                                                <span class="text-warning">?</span>
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <div class="text-xs text-base-content/50 mt-2 score-breakdown-{{ match.id }}" style="display: none;">Score breakdown not available</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>
        
        <!-- Top 9 Results - Grid View -->
        <div id="grid-view" class="grid grid-cols-1 md:grid-cols-3 gap-4 view-container" {% if current_view != 'grid' %}style="display: none;"{% endif %}>
            {% for match_data in match_results_with_json|slice:":9" %}
            {% with match=match_data.match %}
            <div class="card bg-base-100 border border-base-300 cursor-pointer" onclick="openGrantModal({{ match.id }})" data-match-id="{{ match.id }}">
                <div class="card-body pb-4">
                    <h3 class="card-title text-sm">
                        <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary line-clamp-2" onclick="event.stopPropagation();">
                            {{ match.grant.title }}
                        </a>
                    </h3>
                    <div class="flex gap-2 mt-2 flex-wrap">
                        <div class="badge {% if match.grant.computed_status == 'open' %}badge-success{% elif match.grant.computed_status == 'closed' %}badge-error{% else %}badge-warning{% endif %} badge-sm">
                            {{ match.grant.get_status_display }}
                        </div>
                        <span class="badge badge-primary badge-outline badge-sm">
                            {% if match.grant.get_source_display == "Innovate UK" %}IUK{% else %}{{ match.grant.get_source_display }}{% endif %}
                        </span>
                        {% if match.grant.deadline %}
                        <span class="badge badge-primary badge-outline badge-sm">{{ match.grant.deadline|date:"M d, Y" }}</span>
                        {% endif %}
                        {% if match_data.is_excluded %}
                        <span class="badge badge-error badge-sm">Excluded</span>
                        {% endif %}
                    </div>
                                <div class="mt-4 flex items-center justify-center gap-3">
                                    {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                    <div>
                                        <svg width="60" height="60" viewBox="0 0 60 60" class="checklist-pie-chart" 
                                             data-match-id="{{ match.id }}"
                                             data-eligibility='{{ match_data.eligibility_json }}'
                                             data-competitiveness='{{ match_data.competitiveness_json }}'
                                             data-exclusions='{{ match_data.exclusions_json }}'>
                                            <circle cx="30" cy="30" r="25" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                        </svg>
                                    </div>
                                    {% endif %}
                                    <div class="text-center">
                                        <div class="stat-value text-primary text-2xl overall-match-score">{{ match.match_score|percentage }}%</div>
                                        <div class="stat-desc text-xs">Overall Match</div>
                                        <div class="stat-desc text-xs mt-1 certainty-percentage" data-match-id="{{ match.id }}" {% if match_data.certainty is not None %}data-certainty="{{ match_data.certainty }}"{% endif %}>Calculating...</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>
        
        <!-- Remaining Results (Expandable) -->
        {% if match_results|length > 9 %}
        {% with remaining_count=match_results|length|add:"-9" %}
        <div class="mt-6">
            <button 
                id="toggle-remaining-grants" 
                class="btn btn-outline btn-primary w-full"
                onclick="toggleRemainingGrants()"
                data-remaining-count="{{ remaining_count }}"
            >
                <span id="toggle-text">View All {{ remaining_count }} Remaining Grant{{ remaining_count|pluralize }}</span>
                <svg id="toggle-icon" class="w-5 h-5 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <div id="remaining-grants-section" class="hidden mt-4">
                <div class="border border-base-300 rounded-lg p-4 bg-base-100" style="max-height: 800px; overflow-y: auto;">
                    <!-- Remaining Grants - List View -->
                    <div id="remaining-grants-list" class="space-y-4 remaining-grants-view" {% if current_view != 'list' %}style="display: none;"{% endif %}>
                        {% for match_data in match_results_with_json|slice:"5:" %}
                        {% with match=match_data.match %}
                        <div class="card bg-base-100 border border-base-300">
                            <div class="card-body pb-0">
                                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start mb-2 gap-4">
                                    <div class="flex-1">
                                        <h3 class="card-title text-base">
                                            <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary">
                                                {{ match.grant.title }}
                                            </a>
                                        </h3>
                                        <div class="flex gap-2 mt-2 flex-wrap">
                                            <div class="badge {% if match.grant.computed_status == 'open' %}badge-success{% elif match.grant.computed_status == 'closed' %}badge-error{% else %}badge-warning{% endif %}">
                                                {{ match.grant.get_status_display }}
                                            </div>
                                            <span class="badge badge-primary badge-outline">{{ match.grant.get_source_display }}</span>
                                            {% if match.grant.deadline %}
                                            <span class="badge badge-primary badge-outline">{{ match.grant.deadline|date:"M d, Y" }}</span>
                                            {% endif %}
                                            {% if match.grant.trl_requirements.trl_levels %}
                                                <span class="badge badge-outline" title="Grant TRL requirements">
                                                    Grant TRL: {% if match.grant.trl_requirements.trl_range %}{{ match.grant.trl_requirements.trl_range }}{% else %}{{ match.grant.trl_requirements.trl_levels|trl_levels_to_range }}{% endif %}
                                                </span>
                                            {% endif %}
                                            {% if match_data.is_excluded %}
                                            <span class="badge badge-error">Excluded</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-base-content mt-3">
                                    <div class="mt-4 -mx-4 -mb-2">
                                        <div class="collapse">
                                            <input type="checkbox" id="more-details-{{ match.id }}" />
                                            <div class="collapse-title font-semibold text-sm px-4 min-h-0 flex items-center gap-2 cursor-pointer">
                                                <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <span>Details</span>
                                            </div>
                                            <div class="collapse-content px-4 pb-2 pt-0">
                                                {% if match.match_reasons.project_type_and_trl_focus or match.match_reasons.why_it_matches or match.match_reasons.key_risks_and_uncertainties %}
                                                <div class="mt-2">
                                                    <div class="font-semibold text-xs mb-2">Summary</div>
                                                <div class="space-y-2">
                                                    {% if match.match_reasons.project_type_and_trl_focus %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Project type and TRL focus
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.project_type_and_trl_focus }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% if match.match_reasons.why_it_matches %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Why it matches
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.why_it_matches }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% if match.match_reasons.key_risks_and_uncertainties %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Key risks and uncertainties
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.key_risks_and_uncertainties }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                    </div>
                                </div>
                                {% elif match.match_reasons.explanation %}
                                                <div class="mt-2">
                                                    <div class="font-semibold text-xs mb-2">Summary</div>
                                                    <p class="text-xs"><strong>Summary:</strong> {{ match.match_reasons.explanation }}</p>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                                <div class="mt-4">
                                                    <div class="font-semibold text-xs mb-2">Checklists</div>
                                            <div class="space-y-2">
                                {% if match.match_reasons.eligibility_checklist %}
                                                <div>
                                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Eligibility Checklist
                                            <span class="text-xs font-normal text-base-content/70 eligibility-checklist-score">
                                                (calculating...)
                                            </span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 eligibility-checklist-items">
                                        {% for item in match.match_reasons.eligibility_checklist %}
                                        <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="eligibility" data-item-index="{{ forloop.counter0 }}">
                                            {% if item.status == "yes" %}
                                            <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                            {% elif item.status == "no" %}
                                            <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                            {% else %}
                                            <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                            {% endif %}
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                    {% if can_edit %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'eligibility', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                    </button>
                                                    {% if item.manually_edited %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'eligibility', {{ forloop.counter0 }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                        </svg>
                                                    </button>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                                {% if item.manually_edited %}
                                                <p class="text-xs font-bold text-accent mt-1">Manually edited</p>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.competitiveness_checklist %}
                                                <div>
                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Competitiveness Checklist
                                            <span class="text-xs font-normal text-base-content/70 competitiveness-checklist-score">
                                                (calculating...)
                                            </span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 competitiveness-checklist-items">
                                        {% for item in match.match_reasons.competitiveness_checklist %}
                                        <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="competitiveness" data-item-index="{{ forloop.counter0 }}">
                                            {% if item.status == "yes" %}
                                            <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                            {% elif item.status == "no" %}
                                            <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                            {% else %}
                                            <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                            {% endif %}
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                    {% if can_edit %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'competitiveness', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                    </button>
                                                    {% if item.manually_edited %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'competitiveness', {{ forloop.counter0 }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                        </svg>
                                                    </button>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                                {% if item.manually_edited %}
                                                <p class="text-xs font-bold text-accent mt-1">Manually edited</p>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                                            </div>
                                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.exclusions_checklist %}
                                                <div>
                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Exclusions Checklist
                                            <span class="text-xs font-normal text-base-content/70 exclusions-checklist-score">
                                                (calculating...)
                                            </span>
                                            <span class="exclusions-warning-icon" style="display: none; margin-left: 0.5rem;">⚠️</span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 exclusions-checklist-items">
                                                {% for item in match.match_reasons.exclusions_checklist %}
                                                <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="exclusions" data-item-index="{{ forloop.counter0 }}">
                                                    {% if item.status == "yes" %}
                                                                    <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                                    {% elif item.status == "no" %}
                                                                    <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                                    {% else %}
                                                    <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                                    {% endif %}
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                            {% if can_edit %}
                                                            <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'exclusions', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                </svg>
                                                            </button>
                                                    {% endif %}
                                                </div>
                                                            {% if item.manually_edited %}
                                                        <div class="flex items-center gap-2 mt-1">
                                                            <p class="text-xs font-bold text-accent">Manually edited</p>
                                                            {% if can_edit %}
                                                            <button type="button" class="btn btn-ghost btn-xs text-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'exclusions', {{ forloop.counter0 }})">
                                                                Undo
                                                            </button>
                                                            {% endif %}
                                                </div>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if not match.match_reasons.eligibility_checklist and not match.match_reasons.competitiveness_checklist and not match.match_reasons.exclusions_checklist %}
                                <div class="mt-4">
                                    <div class="alert alert-info">
                                        <span class="text-xs">Checklists not available. Please run a new matching job to see eligibility and competitiveness checklists.</span>
                                    </div>
                                </div>
                                {% endif %}
                                            <div class="mt-4 pt-3 border-t border-base-300">
                                                <button type="button" class="btn btn-ghost btn-sm w-full" onclick="document.getElementById('more-details-{{ match.id }}').checked = false; document.getElementById('more-details-{{ match.id }}').dispatchEvent(new Event('change'));">
                                                    Hide
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                    </div>
                                    <div class="lg:text-right lg:ml-4 min-w-[200px]">
                                        <div class="flex items-center justify-end gap-3 mb-3">
                                            {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                            <div>
                                                <svg width="90" height="90" viewBox="0 0 60 60" class="checklist-pie-chart" 
                                                     data-match-id="{{ match.id }}"
                                                     data-eligibility='{{ match_data.eligibility_json }}'
                                                     data-competitiveness='{{ match_data.competitiveness_json }}'
                                                     data-exclusions='{{ match_data.exclusions_json }}'>
                                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                                </svg>
                                            </div>
                                            {% endif %}
                                            <div>
                                        <div class="stat-value text-primary text-4xl overall-match-score">{{ match.match_score|percentage }}%</div>
                                                <div class="stat-desc text-xs">Overall Match</div>
                                                <div class="stat-desc text-xs mt-1 certainty-percentage" data-match-id="{{ match.id }}" {% if match_data.certainty is not None %}data-certainty="{{ match_data.certainty }}"{% endif %}>Calculating...</div>
                                            </div>
                                        </div>
                                        {% if match.eligibility_score is not None or match.competitiveness_score is not None or match.match_reasons.exclusions_checklist %}
                                        <div class="border-t border-base-300 pt-3 mt-3 score-breakdown-{{ match.id }}" style="display: none;">
                                            <div class="text-xs font-bold mb-2 text-left">Score Breakdown:</div>
                                            <div class="space-y-2">
                                                {% if match.eligibility_score is not None %}
                                                <div>
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-xs text-base-content/70">Eligibility</span>
                                                        <span class="text-xs font-semibold eligibility-breakdown-percentage">
                                                            {{ match.eligibility_score|percentage }}%
                                                            <span class="text-xs font-normal text-base-content/60 eligibility-breakdown-count ml-1">(calculating...)</span>
                                                        </span>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if match.competitiveness_score is not None %}
                                                <div>
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-xs text-base-content/70">Competitiveness</span>
                                                        <span class="text-xs font-semibold competitiveness-breakdown-percentage">
                                                            {{ match.competitiveness_score|percentage }}%
                                                            <span class="text-xs font-normal text-base-content/60 competitiveness-breakdown-count ml-1">(calculating...)</span>
                                                        </span>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if match.match_reasons.exclusions_checklist %}
                                                <div>
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-xs text-base-content/70">Exclusions</span>
                                                        <span class="text-xs font-semibold exclusions-breakdown-percentage">
                                                            (calculating...)
                                                            <span class="text-xs font-normal text-base-content/60 exclusions-breakdown-count ml-1"></span>
                                                            <span class="exclusions-breakdown-warning-icon" style="display: none; margin-left: 0.5rem;">⚠️</span>
                                                        </span>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                
                                                {# Other Checks Section #}
                                                {% if match.match_reasons.project_type_and_trl_focus %}
                                                    {% if match.grant.trl_requirements %}
                                                        {% if match.grant.trl_requirements.trl_levels %}
                                                        <div class="border-t border-base-300 pt-3 mt-3">
                                                            <div class="text-xs font-bold mb-2 text-left">Other Checks:</div>
                                                            <div>
                                                                {% check_project_trl_in_grant_range match.match_reasons.project_type_and_trl_focus match.grant.trl_requirements as trl_check_status %}
                                                                <div class="flex justify-between items-center">
                                                                    <span class="text-xs text-base-content/70">TRL Range</span>
                                                                    <span class="text-xs font-semibold">
                                                                        {% if trl_check_status == "yes" %}
                                                                            <span class="text-success">✓</span>
                                                                        {% elif trl_check_status == "no" %}
                                                                            <span class="text-error">✗</span>
                                                                        {% else %}
                                                                            <span class="text-warning">?</span>
                                                                        {% endif %}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="text-xs text-base-content/50 mt-2 score-breakdown-{{ match.id }}" style="display: none;">Score breakdown not available</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                </div>
                            </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                    
                    <!-- Remaining Grants - Grid View -->
                    <div id="remaining-grants-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 remaining-grants-view" {% if current_view != 'grid' %}style="display: none;"{% endif %}>
                        {% for match_data in match_results_with_json|slice:"9:" %}
                        {% with match=match_data.match %}
                        <div class="card bg-base-100 border border-base-300 cursor-pointer" onclick="openGrantModal({{ match.id }})" data-match-id="{{ match.id }}">
                            <div class="card-body pb-4">
                                <h3 class="card-title text-sm">
                                    <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary line-clamp-2" onclick="event.stopPropagation();">
                                        {{ match.grant.title }}
                                    </a>
                                </h3>
                                <div class="flex gap-2 mt-2 flex-wrap">
                                    <div class="badge {% if match.grant.computed_status == 'open' %}badge-success{% elif match.grant.computed_status == 'closed' %}badge-error{% else %}badge-warning{% endif %} badge-sm">
                                        {{ match.grant.get_status_display }}
                </div>
                                    <span class="badge badge-primary badge-outline badge-sm flex items-center gap-1">
                                        <img src="{% grant_source_logo match.grant.source %}" alt="{{ match.grant.get_source_display }}" class="h-3 w-auto" onerror="this.style.display='none'">
                                        <span>{% if match.grant.get_source_display == "Innovate UK" %}IUK{% else %}{{ match.grant.get_source_display }}{% endif %}</span>
                                    </span>
                                    {% if match.grant.deadline %}
                                    <span class="badge badge-primary badge-outline badge-sm">{{ match.grant.deadline|date:"M d, Y" }}</span>
                                    {% endif %}
                                    {% if match.grant.trl_requirements.trl_levels %}
                                        <span class="badge badge-outline badge-sm" title="Grant TRL requirements">
                                            Grant TRL: {% if match.grant.trl_requirements.trl_range %}{{ match.grant.trl_requirements.trl_range }}{% else %}{{ match.grant.trl_requirements.trl_levels|trl_levels_to_range }}{% endif %}
                                        </span>
                                    {% endif %}
                                    {% if match_data.is_excluded %}
                                    <span class="badge badge-error badge-sm">Excluded</span>
                                    {% endif %}
                                </div>
                                <div class="mt-4 flex items-center justify-center gap-3">
                                    {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                    <div>
                                        <svg width="60" height="60" viewBox="0 0 60 60" class="checklist-pie-chart" 
                                             data-match-id="{{ match.id }}"
                                             data-eligibility='{{ match_data.eligibility_json }}'
                                             data-competitiveness='{{ match_data.competitiveness_json }}'
                                             data-exclusions='{{ match_data.exclusions_json }}'>
                                            <circle cx="30" cy="30" r="25" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                        </svg>
                                    </div>
                                    {% endif %}
                                    <div class="text-center">
                                        <div class="stat-value text-primary text-2xl overall-match-score">{{ match.match_score|percentage }}%</div>
                                        <div class="stat-desc text-xs">Overall Match</div>
                                        <div class="stat-desc text-xs mt-1 certainty-percentage" data-match-id="{{ match.id }}" {% if match_data.certainty is not None %}data-certainty="{{ match_data.certainty }}"{% endif %}>Calculating...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endif %}
        {% endif %}
        
        <!-- Not Eligible Grants (Expandable) -->
        {% if not_eligible_grants_with_json|length > 0 %}
        {% with not_eligible_count=not_eligible_grants_with_json|length %}
        <div class="mt-6">
            <button 
                id="toggle-not-eligible-grants" 
                class="btn btn-outline btn-warning w-full"
                onclick="toggleNotEligibleGrants()"
                data-not-eligible-count="{{ not_eligible_count }}"
            >
                <span id="toggle-not-eligible-text">View {{ not_eligible_count }} Not Eligible Grant{{ not_eligible_count|pluralize }}</span>
                <svg id="toggle-not-eligible-icon" class="w-5 h-5 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <div id="not-eligible-grants-section" class="hidden mt-4">
                <div class="border border-warning rounded-lg p-4 bg-base-100" style="max-height: 800px; overflow-y: auto;">
                    <!-- Not Eligible Grants - List View -->
                    <div id="not-eligible-grants-list" class="space-y-4 not-eligible-grants-view" {% if current_view != 'list' %}style="display: none;"{% endif %}>
                        {% for match_data in not_eligible_grants_with_json %}
                        {% with match=match_data.match %}
                        <div class="card bg-base-100 border border-warning">
                            <div class="card-body pb-0">
                                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start mb-2 gap-4">
                                    <div class="flex-1">
                                        <h3 class="card-title text-base">
                                            <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary">
                                                {{ match.grant.title }}
                                            </a>
                                        </h3>
                                        <div class="flex gap-2 mt-2 flex-wrap">
                                            <div class="badge {% if match.grant.computed_status == 'open' %}badge-success{% elif match.grant.computed_status == 'closed' %}badge-error{% else %}badge-warning{% endif %}">
                                                {{ match.grant.get_status_display }}
                                            </div>
                                            <span class="badge badge-primary badge-outline">{{ match.grant.get_source_display }}</span>
                                            {% if match.grant.deadline %}
                                            <span class="badge badge-primary badge-outline">{{ match.grant.deadline|date:"M d, Y" }}</span>
                                            {% endif %}
                                            {% if match.grant.trl_requirements.trl_levels %}
                                                <span class="badge badge-outline" title="Grant TRL requirements">
                                                    Grant TRL: {% if match.grant.trl_requirements.trl_range %}{{ match.grant.trl_requirements.trl_range }}{% else %}{{ match.grant.trl_requirements.trl_levels|trl_levels_to_range }}{% endif %}
                                                </span>
                                            {% endif %}
                                            <span class="badge badge-warning">Not Eligible</span>
                                        </div>
                                        <div class="text-base-content mt-3">
                                    <div class="mt-4 -mx-4 -mb-2">
                                        <div class="collapse">
                                            <input type="checkbox" id="more-details-not-eligible-{{ match.id }}" />
                                            <div class="collapse-title font-semibold text-sm px-4 min-h-0 flex items-center gap-2 cursor-pointer">
                                                <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <span>Details</span>
                                            </div>
                                            <div class="collapse-content px-4 pb-2 pt-0">
                                                {% if match.match_reasons.project_type_and_trl_focus or match.match_reasons.why_it_matches or match.match_reasons.key_risks_and_uncertainties %}
                                                <div class="mt-2">
                                                    <div class="font-semibold text-xs mb-2">Summary</div>
                                                <div class="space-y-2">
                                                    {% if match.match_reasons.project_type_and_trl_focus %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Project type and TRL focus
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.project_type_and_trl_focus }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% if match.match_reasons.why_it_matches %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Why it matches
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.why_it_matches }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% if match.match_reasons.key_risks_and_uncertainties %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Key risks and uncertainties
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.key_risks_and_uncertainties }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                    </div>
                                </div>
                                {% elif match.match_reasons.explanation %}
                                                <div class="mt-2">
                                                    <div class="font-semibold text-xs mb-2">Summary</div>
                                                    <p class="text-xs"><strong>Summary:</strong> {{ match.match_reasons.explanation }}</p>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                                <div class="mt-4">
                                                    <div class="font-semibold text-xs mb-2">Checklists</div>
                                            <div class="space-y-2">
                                {% if match.match_reasons.eligibility_checklist %}
                                                <div>
                                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Eligibility Checklist
                                            <span class="text-xs font-normal text-base-content/70 eligibility-checklist-score">
                                                (calculating...)
                                            </span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 eligibility-checklist-items">
                                        {% for item in match.match_reasons.eligibility_checklist %}
                                        <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="eligibility" data-item-index="{{ forloop.counter0 }}">
                                            {% if item.status == "yes" %}
                                            <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                            {% elif item.status == "no" %}
                                            <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                            {% else %}
                                            <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                            {% endif %}
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                    {% if can_edit %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'eligibility', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                    </button>
                                                    {% if item.manually_edited %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'eligibility', {{ forloop.counter0 }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                        </svg>
                                                    </button>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                                {% if item.manually_edited %}
                                                <p class="text-xs font-bold text-accent mt-1">Manually edited</p>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.competitiveness_checklist %}
                                                <div>
                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Competitiveness Checklist
                                            <span class="text-xs font-normal text-base-content/70 competitiveness-checklist-score">
                                                (calculating...)
                                            </span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 competitiveness-checklist-items">
                                        {% for item in match.match_reasons.competitiveness_checklist %}
                                        <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="competitiveness" data-item-index="{{ forloop.counter0 }}">
                                            {% if item.status == "yes" %}
                                            <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                            {% elif item.status == "no" %}
                                            <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                            {% else %}
                                            <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                            {% endif %}
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                    {% if can_edit %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'competitiveness', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                    </button>
                                                    {% if item.manually_edited %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'competitiveness', {{ forloop.counter0 }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                        </svg>
                                                    </button>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                                {% if item.manually_edited %}
                                                <p class="text-xs font-bold text-accent mt-1">Manually edited</p>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                                            </div>
                                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.exclusions_checklist %}
                                                <div>
                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Exclusions Checklist
                                            <span class="text-xs font-normal text-base-content/70 exclusions-checklist-score">
                                                (calculating...)
                                            </span>
                                            <span class="exclusions-warning-icon" style="display: none; margin-left: 0.5rem;">⚠️</span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 exclusions-checklist-items">
                                                {% for item in match.match_reasons.exclusions_checklist %}
                                                <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="exclusions" data-item-index="{{ forloop.counter0 }}">
                                                    {% if item.status == "yes" %}
                                                                    <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                                    {% elif item.status == "no" %}
                                                                    <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                                    {% else %}
                                                    <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                                    {% endif %}
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                            {% if can_edit %}
                                                            <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'exclusions', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                </svg>
                                                            </button>
                                                    {% endif %}
                                                </div>
                                                            {% if item.manually_edited %}
                                                        <div class="flex items-center gap-2 mt-1">
                                                            <p class="text-xs font-bold text-accent">Manually edited</p>
                                                            {% if can_edit %}
                                                            <button type="button" class="btn btn-ghost btn-xs text-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'exclusions', {{ forloop.counter0 }})">
                                                                Undo
                                                            </button>
                                                            {% endif %}
                                                </div>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if not match.match_reasons.eligibility_checklist and not match.match_reasons.competitiveness_checklist and not match.match_reasons.exclusions_checklist %}
                                <div class="mt-4">
                                    <div class="alert alert-info">
                                        <span class="text-xs">Checklists not available. Please run a new matching job to see eligibility and competitiveness checklists.</span>
                                    </div>
                                </div>
                                {% endif %}
                                            <div class="mt-4 pt-3 border-t border-base-300">
                                                <button type="button" class="btn btn-ghost btn-sm w-full" onclick="document.getElementById('more-details-not-eligible-{{ match.id }}').checked = false; document.getElementById('more-details-not-eligible-{{ match.id }}').dispatchEvent(new Event('change'));">
                                                    Hide
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                    </div>
                                    <div class="lg:text-right lg:ml-4 min-w-[200px]">
                                        <div class="flex items-center justify-end gap-3 mb-3">
                                            {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                            <div>
                                                <svg width="90" height="90" viewBox="0 0 60 60" class="checklist-pie-chart" 
                                                     data-match-id="{{ match.id }}"
                                                     data-eligibility='{{ match_data.eligibility_json }}'
                                                     data-competitiveness='{{ match_data.competitiveness_json }}'
                                                     data-exclusions='{{ match_data.exclusions_json }}'>
                                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                                </svg>
                                            </div>
                                            {% endif %}
                                            <div>
                                        <div class="stat-value text-warning text-4xl overall-match-score">{{ match.match_score|percentage }}%</div>
                                                <div class="stat-desc text-xs">Overall Match</div>
                                                <div class="stat-desc text-xs mt-1 certainty-percentage" data-match-id="{{ match.id }}" {% if match_data.certainty is not None %}data-certainty="{{ match_data.certainty }}"{% endif %}>Calculating...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                </div>
                            </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                    
                    <!-- Not Eligible Grants - Grid View -->
                    <div id="not-eligible-grants-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 not-eligible-grants-view" {% if current_view != 'grid' %}style="display: none;"{% endif %}>
                        {% for match_data in not_eligible_grants_with_json %}
                        {% with match=match_data.match %}
                        <div class="card bg-base-100 border border-warning cursor-pointer" onclick="openGrantModal({{ match.id }})" data-match-id="{{ match.id }}">
                            <div class="card-body pb-4">
                                <h3 class="card-title text-sm">
                                    <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary line-clamp-2" onclick="event.stopPropagation();">
                                        {{ match.grant.title }}
                                    </a>
                                </h3>
                                <div class="flex gap-2 mt-2 flex-wrap">
                                    <div class="badge {% if match.grant.computed_status == 'open' %}badge-success{% elif match.grant.computed_status == 'closed' %}badge-error{% else %}badge-warning{% endif %} badge-sm">
                                        {{ match.grant.get_status_display }}
                </div>
                                    <span class="badge badge-primary badge-outline badge-sm flex items-center gap-1">
                                        <img src="{% grant_source_logo match.grant.source %}" alt="{{ match.grant.get_source_display }}" class="h-3 w-auto" onerror="this.style.display='none'">
                                        <span>{% if match.grant.get_source_display == "Innovate UK" %}IUK{% else %}{{ match.grant.get_source_display }}{% endif %}</span>
                                    </span>
                                    {% if match.grant.deadline %}
                                    <span class="badge badge-primary badge-outline badge-sm">{{ match.grant.deadline|date:"M d, Y" }}</span>
                                    {% endif %}
                                    {% if match.grant.trl_requirements.trl_levels %}
                                        <span class="badge badge-outline badge-sm" title="Grant TRL requirements">
                                            Grant TRL: {% if match.grant.trl_requirements.trl_range %}{{ match.grant.trl_requirements.trl_range }}{% else %}{{ match.grant.trl_requirements.trl_levels|trl_levels_to_range }}{% endif %}
                                        </span>
                                    {% endif %}
                                    <span class="badge badge-warning badge-sm">Not Eligible</span>
                                </div>
                                <div class="mt-4 flex items-center justify-center gap-3">
                                    {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                    <div>
                                        <svg width="60" height="60" viewBox="0 0 60 60" class="checklist-pie-chart" 
                                             data-match-id="{{ match.id }}"
                                             data-eligibility='{{ match_data.eligibility_json }}'
                                             data-competitiveness='{{ match_data.competitiveness_json }}'
                                             data-exclusions='{{ match_data.exclusions_json }}'>
                                            <circle cx="30" cy="30" r="25" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                        </svg>
                                    </div>
                                    {% endif %}
                                    <div class="text-center">
                                        <div class="stat-value text-warning text-3xl overall-match-score">{{ match.match_score|percentage }}%</div>
                                        <div class="stat-desc text-xs">Overall Match</div>
                                        <div class="stat-desc text-xs mt-1 certainty-percentage" data-match-id="{{ match.id }}" {% if match_data.certainty is not None %}data-certainty="{{ match_data.certainty }}"{% endif %}>Calculating...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endif %}
        
        <!-- Excluded Grants (Expandable) -->
        {% if excluded_grants_with_json|length > 0 %}
        {% with excluded_count=excluded_grants_with_json|length %}
        <div class="mt-6">
            <button 
                id="toggle-excluded-grants" 
                class="btn btn-outline btn-error w-full"
                onclick="toggleExcludedGrants()"
                data-excluded-count="{{ excluded_count }}"
            >
                <span id="toggle-excluded-text">View {{ excluded_count }} Excluded Grant{{ excluded_count|pluralize }}</span>
                <svg id="toggle-excluded-icon" class="w-5 h-5 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <div id="excluded-grants-section" class="hidden mt-4">
                <div class="border border-error rounded-lg p-4 bg-base-100" style="max-height: 800px; overflow-y: auto;">
                    <!-- Excluded Grants - List View -->
                    <div id="excluded-grants-list" class="space-y-4 excluded-grants-view" {% if current_view != 'list' %}style="display: none;"{% endif %}>
                        {% for match_data in excluded_grants_with_json %}
                        {% with match=match_data.match %}
                        <div class="card bg-base-100 border border-error">
                            <div class="card-body pb-0">
                                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start mb-2 gap-4">
                                    <div class="flex-1">
                                        <h3 class="card-title text-base">
                                            <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary">
                                                {{ match.grant.title }}
                                            </a>
                                        </h3>
                                        <div class="flex gap-2 mt-2 flex-wrap">
                                            <div class="badge {% if match.grant.computed_status == 'open' %}badge-success{% elif match.grant.computed_status == 'closed' %}badge-error{% else %}badge-warning{% endif %}">
                                                {{ match.grant.get_status_display }}
                                            </div>
                                            <span class="badge badge-primary badge-outline">{{ match.grant.get_source_display }}</span>
                                            {% if match.grant.deadline %}
                                            <span class="badge badge-primary badge-outline">{{ match.grant.deadline|date:"M d, Y" }}</span>
                                            {% endif %}
                                            {% if match.grant.trl_requirements.trl_levels %}
                                                <span class="badge badge-outline" title="Grant TRL requirements">
                                                    Grant TRL: {% if match.grant.trl_requirements.trl_range %}{{ match.grant.trl_requirements.trl_range }}{% else %}{{ match.grant.trl_requirements.trl_levels|trl_levels_to_range }}{% endif %}
                                                </span>
                                            {% endif %}
                                            <span class="badge badge-error">Excluded</span>
                                        </div>
                                        <div class="text-base-content mt-3">
                                    <div class="mt-4 -mx-4 -mb-2">
                                        <div class="collapse">
                                            <input type="checkbox" id="more-details-excluded-{{ match.id }}" />
                                            <div class="collapse-title font-semibold text-sm px-4 min-h-0 flex items-center gap-2 cursor-pointer">
                                                <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                                <span>Details</span>
                                            </div>
                                            <div class="collapse-content px-4 pb-2 pt-0">
                                                {% if match.match_reasons.project_type_and_trl_focus or match.match_reasons.why_it_matches or match.match_reasons.key_risks_and_uncertainties %}
                                                <div class="mt-2">
                                                    <div class="font-semibold text-xs mb-2">Summary</div>
                                                <div class="space-y-2">
                                                    {% if match.match_reasons.project_type_and_trl_focus %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Project type and TRL focus
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.project_type_and_trl_focus }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% if match.match_reasons.why_it_matches %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Why it matches
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.why_it_matches }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% if match.match_reasons.key_risks_and_uncertainties %}
                                                    <div class="mt-2">
                                                            <div class="font-semibold text-xs mb-1">
                                                                Key risks and uncertainties
                                                            </div>
                                                            <div class="pb-2">
                                                                <p class="text-xs mt-1">{{ match.match_reasons.key_risks_and_uncertainties }}</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                    </div>
                                </div>
                                {% elif match.match_reasons.explanation %}
                                                <div class="mt-2">
                                                    <div class="font-semibold text-xs mb-2">Summary</div>
                                                    <p class="text-xs"><strong>Summary:</strong> {{ match.match_reasons.explanation }}</p>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                                <div class="mt-4">
                                                    <div class="font-semibold text-xs mb-2">Checklists</div>
                                            <div class="space-y-2">
                                {% if match.match_reasons.eligibility_checklist %}
                                                <div>
                                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Eligibility Checklist
                                            <span class="text-xs font-normal text-base-content/70 eligibility-checklist-score">
                                                (calculating...)
                                            </span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 eligibility-checklist-items">
                                        {% for item in match.match_reasons.eligibility_checklist %}
                                        <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="eligibility" data-item-index="{{ forloop.counter0 }}">
                                            {% if item.status == "yes" %}
                                            <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                            {% elif item.status == "no" %}
                                            <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                            {% else %}
                                            <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                            {% endif %}
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                    {% if can_edit %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'eligibility', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                    </button>
                                                    {% if item.manually_edited %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'eligibility', {{ forloop.counter0 }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                        </svg>
                                                    </button>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                                {% if item.manually_edited %}
                                                <p class="text-xs font-bold text-accent mt-1">Manually edited</p>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.competitiveness_checklist %}
                                                <div>
                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Competitiveness Checklist
                                            <span class="text-xs font-normal text-base-content/70 competitiveness-checklist-score">
                                                (calculating...)
                                            </span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 competitiveness-checklist-items">
                                        {% for item in match.match_reasons.competitiveness_checklist %}
                                        <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="competitiveness" data-item-index="{{ forloop.counter0 }}">
                                            {% if item.status == "yes" %}
                                            <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                            {% elif item.status == "no" %}
                                            <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                            {% else %}
                                            <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                            {% endif %}
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                    {% if can_edit %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'competitiveness', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                    </button>
                                                    {% if item.manually_edited %}
                                                    <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'competitiveness', {{ forloop.counter0 }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                        </svg>
                                                    </button>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                                {% if item.manually_edited %}
                                                <p class="text-xs font-bold text-accent mt-1">Manually edited</p>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                                            </div>
                                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if match.match_reasons.exclusions_checklist %}
                                                <div>
                                    <div class="collapse">
                                        <input type="checkbox" />
                                                        <div class="collapse-title font-semibold text-xs px-4 min-h-0 flex items-center gap-2">
                                            <svg class="w-4 h-4 transition-transform duration-200 collapse-arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            Exclusions Checklist
                                            <span class="text-xs font-normal text-base-content/70 exclusions-checklist-score">
                                                (calculating...)
                                            </span>
                                            <span class="exclusions-warning-icon" style="display: none; margin-left: 0.5rem;">⚠️</span>
                                        </div>
                                        <div class="collapse-content px-4 pb-0 pt-2">
                                            <div class="space-y-2 exclusions-checklist-items">
                                                {% for item in match.match_reasons.exclusions_checklist %}
                                                <div class="flex items-start gap-2 group checklist-item" data-match-id="{{ match.id }}" data-checklist-type="exclusions" data-item-index="{{ forloop.counter0 }}">
                                                    {% if item.status == "yes" %}
                                                                    <span class="text-error text-base checklist-status-icon w-6 flex-shrink-0">✗</span>
                                                    {% elif item.status == "no" %}
                                                                    <span class="text-success text-base checklist-status-icon w-6 flex-shrink-0">✓</span>
                                                    {% else %}
                                                    <span class="text-warning text-base checklist-status-icon w-6 flex-shrink-0">?</span>
                                                    {% endif %}
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-xs font-medium">{{ item.criterion }}</span>
                                                            {% if can_edit %}
                                                            <button type="button" class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="openChecklistEditModal({{ match.id }}, 'exclusions', {{ forloop.counter0 }}, '{{ item.status }}', '{{ item.criterion|escapejs }}')">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                </svg>
                                                            </button>
                                                    {% endif %}
                                                </div>
                                                            {% if item.manually_edited %}
                                                        <div class="flex items-center gap-2 mt-1">
                                                            <p class="text-xs font-bold text-accent">Manually edited</p>
                                                            {% if can_edit %}
                                                            <button type="button" class="btn btn-ghost btn-xs text-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="undoChecklistEdit({{ match.id }}, 'exclusions', {{ forloop.counter0 }})">
                                                                Undo
                                                            </button>
                                                            {% endif %}
                                                </div>
                                                {% elif item.reason %}
                                                <p class="text-xs text-base-content/70 mt-1">{{ item.reason }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if not match.match_reasons.eligibility_checklist and not match.match_reasons.competitiveness_checklist and not match.match_reasons.exclusions_checklist %}
                                <div class="mt-4">
                                    <div class="alert alert-info">
                                        <span class="text-xs">Checklists not available. Please run a new matching job to see eligibility and competitiveness checklists.</span>
                                    </div>
                                </div>
                                {% endif %}
                                            <div class="mt-4 pt-3 border-t border-base-300">
                                                <button type="button" class="btn btn-ghost btn-sm w-full" onclick="document.getElementById('more-details-excluded-{{ match.id }}').checked = false; document.getElementById('more-details-excluded-{{ match.id }}').dispatchEvent(new Event('change'));">
                                                    Hide
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                    </div>
                                    <div class="lg:text-right lg:ml-4 min-w-[200px]">
                                        <div class="flex items-center justify-end gap-3 mb-3">
                                            {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                            <div>
                                                <svg width="90" height="90" viewBox="0 0 60 60" class="checklist-pie-chart" 
                                                     data-match-id="{{ match.id }}"
                                                     data-eligibility='{{ match_data.eligibility_json }}'
                                                     data-competitiveness='{{ match_data.competitiveness_json }}'
                                                     data-exclusions='{{ match_data.exclusions_json }}'>
                                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                                </svg>
                                            </div>
                                            {% endif %}
                                            <div>
                                        <div class="stat-value text-error text-4xl overall-match-score">{{ match.match_score|percentage }}%</div>
                                                <div class="stat-desc text-xs">Overall Match</div>
                                                <div class="stat-desc text-xs mt-1 certainty-percentage" data-match-id="{{ match.id }}" {% if match_data.certainty is not None %}data-certainty="{{ match_data.certainty }}"{% endif %}>Calculating...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                </div>
                            </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                    
                    <!-- Excluded Grants - Grid View -->
                    <div id="excluded-grants-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 excluded-grants-view" {% if current_view != 'grid' %}style="display: none;"{% endif %}>
                        {% for match_data in excluded_grants_with_json %}
                        {% with match=match_data.match %}
                        <div class="card bg-base-100 border border-error cursor-pointer" onclick="openGrantModal({{ match.id }})" data-match-id="{{ match.id }}">
                            <div class="card-body pb-4">
                                <h3 class="card-title text-sm">
                                    <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary line-clamp-2" onclick="event.stopPropagation();">
                                        {{ match.grant.title }}
                                    </a>
                                </h3>
                                <div class="flex gap-2 mt-2 flex-wrap">
                                    <div class="badge {% if match.grant.computed_status == 'open' %}badge-success{% elif match.grant.computed_status == 'closed' %}badge-error{% else %}badge-warning{% endif %} badge-sm">
                                        {{ match.grant.get_status_display }}
                </div>
                                    <span class="badge badge-primary badge-outline badge-sm flex items-center gap-1">
                                        <img src="{% grant_source_logo match.grant.source %}" alt="{{ match.grant.get_source_display }}" class="h-3 w-auto" onerror="this.style.display='none'">
                                        <span>{% if match.grant.get_source_display == "Innovate UK" %}IUK{% else %}{{ match.grant.get_source_display }}{% endif %}</span>
                                    </span>
                                    {% if match.grant.deadline %}
                                    <span class="badge badge-primary badge-outline badge-sm">{{ match.grant.deadline|date:"M d, Y" }}</span>
                                    {% endif %}
                                    {% if match.grant.trl_requirements.trl_levels %}
                                        <span class="badge badge-outline badge-sm" title="Grant TRL requirements">
                                            Grant TRL: {% if match.grant.trl_requirements.trl_range %}{{ match.grant.trl_requirements.trl_range }}{% else %}{{ match.grant.trl_requirements.trl_levels|trl_levels_to_range }}{% endif %}
                                        </span>
                                    {% endif %}
                                    <span class="badge badge-error badge-sm">Excluded</span>
                                </div>
                                <div class="mt-4 flex items-center justify-center gap-3">
                                    {% if match.match_reasons.eligibility_checklist or match.match_reasons.competitiveness_checklist or match.match_reasons.exclusions_checklist %}
                                    <div>
                                        <svg width="60" height="60" viewBox="0 0 60 60" class="checklist-pie-chart" 
                                             data-match-id="{{ match.id }}"
                                             data-eligibility='{{ match_data.eligibility_json }}'
                                             data-competitiveness='{{ match_data.competitiveness_json }}'
                                             data-exclusions='{{ match_data.exclusions_json }}'>
                                            <circle cx="30" cy="30" r="25" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                        </svg>
                                    </div>
                                    {% endif %}
                                    <div class="text-center">
                                        <div class="stat-value text-error text-2xl overall-match-score">{{ match.match_score|percentage }}%</div>
                                        <div class="stat-desc text-xs">Overall Match</div>
                                        <div class="stat-desc text-xs mt-1 certainty-percentage" data-match-id="{{ match.id }}" {% if match_data.certainty is not None %}data-certainty="{{ match_data.certainty }}"{% endif %}>Calculating...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Grant Detail Modal -->
<dialog id="grant-modal" class="modal">
    <div class="modal-box max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <div id="grant-modal-content">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% if can_edit and current_tab == 'settings' %}
<div id="tab-settings" class="card bg-base-200 border border-base-300">
    <div class="card-body py-4 px-4 space-y-4">
        <h2 class="card-title text-lg">Settings</h2>
        <div class="space-y-2">
            <div>
                <label class="text-xs font-semibold text-base-content/70">Owner</label>
                <p class="text-xs">
                    {% if funding_search.user.get_full_name %}
                        {{ funding_search.user.get_full_name }}
                    {% else %}
                        {{ funding_search.user.email }}
                    {% endif %}
                </p>
            </div>
            <div>
                <label class="text-xs font-semibold text-base-content/70">Date Created</label>
                <p class="text-xs">{{ funding_search.created_at|date:"F d, Y g:i A" }}</p>
            </div>
        </div>
        <form method="post"
              action="{% url 'companies:funding_search_delete' funding_search.id %}"
              onsubmit="return confirm('Delete this funding search? This cannot be undone.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-error btn-sm">
                Delete Funding Search
            </button>
        </form>
    </div>
</div>
{% endif %}

    </div>
</div>

<!-- Checklist Edit Modal -->
<dialog id="checklist-edit-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-base mb-4">Edit Checklist Item</h3>
        <div class="mb-4">
            <p class="text-xs text-base-content/70 mb-2" id="edit-modal-criterion"></p>
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Status</span>
                </label>
                <select class="select select-bordered w-full" id="edit-modal-status">
                    <option value="yes">✓ Yes</option>
                    <option value="no">✗ No</option>
                    <option value="unknown">? Unknown</option>
                </select>
            </div>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button type="button" class="btn" onclick="document.getElementById('checklist-edit-modal').close()">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-checklist-edit-btn">Save</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const rangeMin = document.getElementById('trl-range-min');
    const rangeMax = document.getElementById('trl-range-max');
    const hiddenInputsContainer = document.getElementById('trl-levels-hidden-inputs');
    const letSystemDecideCheckbox = document.getElementById('let-system-decide-trl');
    const trlSliderContainer = document.getElementById('trl-slider-container');
    
    // Check if matching is running
    const isMatchingRunning = {% if funding_search.matching_status == 'running' %}true{% else %}false{% endif %};
    
    if (!rangeMin || !rangeMax || !hiddenInputsContainer) {
        return; // Elements not found
    }
    
    // Handle "Let system decide" checkbox
    if (letSystemDecideCheckbox) {
        function updateSliderState() {
            const isChecked = letSystemDecideCheckbox.checked;
            if (rangeMin) rangeMin.disabled = isChecked || isMatchingRunning;
            if (rangeMax) rangeMax.disabled = isChecked || isMatchingRunning;
            if (trlSliderContainer) {
                if (isChecked) {
                    trlSliderContainer.style.opacity = '0.5';
                    trlSliderContainer.style.pointerEvents = 'none';
                } else {
                    trlSliderContainer.style.opacity = '1';
                    trlSliderContainer.style.pointerEvents = 'auto';
                }
            }
        }
        
        // Set initial state
        updateSliderState();
        
        // Update on change
        letSystemDecideCheckbox.addEventListener('change', function() {
            updateSliderState();
            // Save the checkbox state via AJAX
            const form = document.getElementById('trl-levels-form');
            if (form) {
                const formData = new FormData(form);
                formData.append('let_system_decide_trl', this.checked ? 'on' : '');
                
                // Use current page URL if form doesn't have action
                const formAction = form.action || window.location.pathname;
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrfToken) {
                    showToast('CSRF token not found. Please refresh the page.', 'error');
                    return;
                }
                
                fetch(formAction, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken.value,
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `HTTP error! status: ${response.status}`);
                        }).catch(() => {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Success - no user feedback needed for auto-save
                    } else {
                        showToast('Error saving TRL preference. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    showToast('Error saving TRL preference. Please try again.', 'error');
                });
            }
        });
    }
    
    // TRL levels data
    const trlLevels = [
        {% for value, label in trl_levels %}
        { value: "{{ value }}", label: "{{ label }}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Initialize sliders from current TRL levels
    {% if funding_search.trl_levels and funding_search.trl_levels|length > 0 %}
    const currentLevels = {{ funding_search.trl_levels|json }};
    if (currentLevels && currentLevels.length > 0) {
        // Find min and max TRL levels from current selection
        const trlNumbers = currentLevels.map(level => {
            const match = level.match(/TRL (\d+)/);
            return match ? parseInt(match[1]) : null;
        }).filter(n => n !== null);
        
        if (trlNumbers.length > 0) {
            const minLevel = Math.min(...trlNumbers);
            const maxLevel = Math.max(...trlNumbers);
            rangeMin.value = minLevel;
            rangeMax.value = maxLevel;
        }
    }
    {% else %}
    // Default to full range if no TRL levels selected
    rangeMin.value = 1;
    rangeMax.value = 9;
    {% endif %}
    
    function updateRangeTrack() {
        const min = parseInt(rangeMin.value);
        const max = parseInt(rangeMax.value);
        const minPercent = ((min - 1) / 8) * 100;
        const maxPercent = ((max - 1) / 8) * 100;
        
        const track = document.getElementById('trl-range-track');
        if (track) {
            track.style.left = minPercent + '%';
            track.style.width = (maxPercent - minPercent) + '%';
        }
    }
    
    function updateDisplay() {
        const min = parseInt(rangeMin.value);
        const max = parseInt(rangeMax.value);
        
        // Ensure min <= max
        if (min > max) {
            if (rangeMin === document.activeElement) {
                rangeMax.value = min;
        } else {
                rangeMin.value = max;
            }
            return updateDisplay();
        }
        
        // Update range track visual
        updateRangeTrack();
        
        // Generate selected TRL levels
        const selectedLevels = [];
        for (let i = min; i <= max; i++) {
            const trlLevel = trlLevels[i - 1];
            if (trlLevel) {
                selectedLevels.push(trlLevel);
            }
        }
        
        // Update hidden inputs for form submission (escape values to prevent XSS)
        hiddenInputsContainer.innerHTML = selectedLevels.map(level => {
            const escapedValue = escapeHtml(level.value);
            return `<input type="hidden" name="trl_levels" value="${escapedValue}">`;
        }).join('');
    }
    
    // Initialize display
    updateDisplay();
    
    // Handle slider changes
    function handleSliderChange(event) {
            if (isMatchingRunning) {
            // Revert to previous values if matching is running
            event.preventDefault();
            updateDisplay();
                return;
            }
        
        const min = parseInt(rangeMin.value);
        const max = parseInt(rangeMax.value);
        
        // Ensure min <= max
        if (min > max) {
            if (event.target === rangeMin) {
                rangeMax.value = min;
            } else {
                rangeMin.value = max;
            }
        }
        
            updateDisplay();
    }
    
    // Save TRL levels via AJAX (debounced)
    let trlSaveTimeout = null;
    function saveTRLLevels() {
        if (isMatchingRunning) {
            return;
        }
        
        clearTimeout(trlSaveTimeout);
        trlSaveTimeout = setTimeout(function() {
            const form = document.getElementById('trl-levels-form');
            if (!form) return;
            
            const formData = new FormData(form);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Success - no page refresh needed
        } else {
                    showToast('Error saving TRL levels. Please try again.', 'error');
                }
            })
            .catch(error => {
                showToast('Error saving TRL levels. Please try again.', 'error');
            });
        }, 500); // Debounce: wait 500ms after last change
    }
    
    rangeMin.addEventListener('input', function(event) {
        handleSliderChange(event);
        saveTRLLevels();
    });
    rangeMax.addEventListener('input', function(event) {
        handleSliderChange(event);
        saveTRLLevels();
    });
    
    // Style the range inputs to look like handles on a single track
    const style = document.createElement('style');
    style.textContent = `
        #trl-range-min::-webkit-slider-thumb,
        #trl-range-max::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: hsl(var(--p));
            border: 2px solid hsl(var(--b1));
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-top: 10px;
            pointer-events: auto;
            position: relative;
            z-index: 10;
        }
        #trl-range-min::-moz-range-thumb,
        #trl-range-max::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: hsl(var(--p));
            border: 2px solid hsl(var(--b1));
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-top: 10px;
            pointer-events: auto;
        }
        #trl-range-min::-webkit-slider-runnable-track,
        #trl-range-max::-webkit-slider-runnable-track {
            pointer-events: none;
        }
        #trl-range-min::-moz-range-track,
        #trl-range-max::-moz-range-track {
            pointer-events: none;
        }
        #trl-range-min:disabled::-webkit-slider-thumb,
        #trl-range-max:disabled::-webkit-slider-thumb {
            background: hsl(var(--bc) / 0.3);
            cursor: not-allowed;
        }
        #trl-range-min:disabled::-moz-range-thumb,
        #trl-range-max:disabled::-moz-range-thumb {
            background: hsl(var(--bc) / 0.3);
            cursor: not-allowed;
    }
    `;
    document.head.appendChild(style);
    
    // Fix the z-index issue: intercept clicks and manually set the correct slider value
    const sliderContainer = rangeMin.parentElement;
    let isDragging = false;
    let activeSlider = null;
    
    // Intercept clicks on the slider container
    sliderContainer.addEventListener('mousedown', function(e) {
        if (isMatchingRunning) return;
        
        // Check if click is directly on a thumb (allow normal dragging)
        const target = e.target;
        // If clicking on the input element itself (not the track), allow normal behavior
        if (target === rangeMin || target === rangeMax) {
            // Check if click is near the thumb
            const rect = target.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const value = parseInt(target.value);
            const thumbPercent = (value - 1) / 8;
            const clickPercent = clickX / width;
            const distToThumb = Math.abs(clickPercent - thumbPercent);
            
            // If click is close to thumb (within 5% of track), allow normal dragging
            if (distToThumb < 0.05) {
                activeSlider = target;
                isDragging = true;
                return; // Let normal behavior handle it
            }
        }
        
        // Otherwise, intercept and route to correct slider
        e.preventDefault();
        e.stopPropagation();
        
        const rect = sliderContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;
        const clickPercent = clickX / width;
        
        const minValue = parseInt(rangeMin.value);
        const maxValue = parseInt(rangeMax.value);
        const minPercent = (minValue - 1) / 8;
        const maxPercent = (maxValue - 1) / 8;
        
        // Determine which slider is closer
        const distToMin = Math.abs(clickPercent - minPercent);
        const distToMax = Math.abs(clickPercent - maxPercent);
        
        if (distToMin < distToMax) {
            // Click closer to min slider
            const newValue = Math.round(clickPercent * 8) + 1;
            const clampedValue = Math.max(1, Math.min(9, Math.min(newValue, maxValue)));
            rangeMin.value = clampedValue;
            handleSliderChange({target: rangeMin});
            activeSlider = rangeMin;
        } else {
            // Click closer to max slider
            const newValue = Math.round(clickPercent * 8) + 1;
            const clampedValue = Math.max(1, Math.min(9, Math.max(newValue, minValue)));
            rangeMax.value = clampedValue;
            handleSliderChange({target: rangeMax});
            activeSlider = rangeMax;
        }
        
        isDragging = true;
    }, true); // Use capture phase
    
    // Handle dragging
    document.addEventListener('mousemove', function(e) {
        if (!isDragging || !activeSlider || isMatchingRunning) return;
        
        const rect = sliderContainer.getBoundingClientRect();
        const moveX = e.clientX - rect.left;
        const width = rect.width;
        const movePercent = moveX / width;
        const newValue = Math.round(movePercent * 8) + 1;
        const clampedValue = Math.max(1, Math.min(9, newValue));
        
        if (activeSlider === rangeMin) {
            if (clampedValue <= parseInt(rangeMax.value)) {
                rangeMin.value = clampedValue;
                handleSliderChange({target: rangeMin});
            }
        } else {
            if (clampedValue >= parseInt(rangeMin.value)) {
                rangeMax.value = clampedValue;
                handleSliderChange({target: rangeMax});
            }
        }
    });
    
    document.addEventListener('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            activeSlider = null;
            saveTRLLevels();
        }
    });
    
    // Handle grant sources checkbox changes with AJAX to prevent page scroll to top
    // Only treat actual grant source checkboxes (not the options below like "Exclude closed competitions" or checklist toggles)
    const grantSourceCheckboxes = document.querySelectorAll(
        '#grant-sources-form input.grant-source-checkbox[name="grant_sources"]'
    );
    const grantSourcesForm = document.getElementById('grant-sources-form');
    
    if (grantSourceCheckboxes.length > 0 && grantSourcesForm && !isMatchingRunning) {
        grantSourceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                // Prevent default form submission
                e.preventDefault();
                
                // Collect all form data
                const formData = new FormData(grantSourcesForm);
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Submit via AJAX
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // If it's a redirect (302), follow it
                        if (response.redirected) {
                            // Reload the page but maintain scroll position
                            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                            sessionStorage.setItem('fundingSearchScrollPosition', scrollPosition.toString());
                            window.location.href = response.url;
                        } else {
                            // If response is OK but not redirected, just reload maintaining scroll
                            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                            sessionStorage.setItem('fundingSearchScrollPosition', scrollPosition.toString());
                            window.location.reload();
                        }
                    } else {
                        showToast('Error updating grant sources. Please try again.', 'error');
                        // Revert checkbox on error
                        this.checked = !this.checked;
                    }
                })
                .catch(error => {
                    showToast('Error updating grant sources. Please try again.', 'error');
                    // Revert checkbox on error
                    this.checked = !this.checked;
                });
            });
        });
        
        // Handle select/deselect all checkbox
        const selectAllCheckbox = document.getElementById('select-all-grant-sources');
        if (selectAllCheckbox && grantSourceCheckboxes.length > 0 && !isMatchingRunning) {
            // Set initial state based on current checkboxes
            function updateSelectAllState() {
                const checkedCount = Array.from(grantSourceCheckboxes).filter(cb => cb.checked).length;
                selectAllCheckbox.checked = checkedCount === grantSourceCheckboxes.length;
                selectAllCheckbox.nextElementSibling.textContent = selectAllCheckbox.checked ? 'Deselect All' : 'Select All';
            }
            
            // Update state on page load
            updateSelectAllState();
            
            // Update state when individual checkboxes change
            grantSourceCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Wait a bit for the AJAX to potentially update checkboxes
                    setTimeout(updateSelectAllState, 100);
                });
            });
            
            // Handle select all checkbox click
            selectAllCheckbox.addEventListener('change', function(e) {
                e.preventDefault();
                
                const shouldSelectAll = this.checked;
                
                // Update all checkboxes visually
                grantSourceCheckboxes.forEach(checkbox => {
                    checkbox.checked = shouldSelectAll;
                });
                
                // Submit form once with all updates
                const formData = new FormData(grantSourcesForm);
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        if (response.redirected) {
                            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                            sessionStorage.setItem('fundingSearchScrollPosition', scrollPosition.toString());
                            window.location.href = response.url;
                        } else {
                            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                            sessionStorage.setItem('fundingSearchScrollPosition', scrollPosition.toString());
                            window.location.reload();
                        }
                    } else {
                        showToast('Error updating grant sources. Please try again.', 'error');
                        // Revert all checkboxes on error
                        grantSourceCheckboxes.forEach(checkbox => {
                            checkbox.checked = !shouldSelectAll;
                        });
                        selectAllCheckbox.checked = !shouldSelectAll;
                        updateSelectAllState();
                    }
                })
                .catch(error => {
                    showToast('Error updating grant sources. Please try again.', 'error');
                    // Revert all checkboxes on error
                    grantSourceCheckboxes.forEach(checkbox => {
                        checkbox.checked = !shouldSelectAll;
                    });
                    selectAllCheckbox.checked = !shouldSelectAll;
                    updateSelectAllState();
                });
                
                // Update label text
                this.nextElementSibling.textContent = shouldSelectAll ? 'Deselect All' : 'Select All';
            });
        }
    }
});

// Restore scroll position after page load (for grant sources form submission)
document.addEventListener('DOMContentLoaded', function() {
    const savedScrollPosition = sessionStorage.getItem('fundingSearchScrollPosition');
    if (savedScrollPosition) {
        // Remove from sessionStorage so it only applies once
        sessionStorage.removeItem('fundingSearchScrollPosition');
        // Restore scroll position after a short delay to ensure page is fully loaded
        setTimeout(() => {
            window.scrollTo(0, parseInt(savedScrollPosition));
        }, 100);
    }
    
    // Render pie charts for checklist summaries
    function renderPieChart(svg) {
        try {
            const eligibilityStr = svg.getAttribute('data-eligibility') || '[]';
            const competitivenessStr = svg.getAttribute('data-competitiveness') || '[]';
            const exclusionsStr = svg.getAttribute('data-exclusions') || '[]';
            
            const eligibility = JSON.parse(eligibilityStr);
            const competitiveness = JSON.parse(competitivenessStr);
            const exclusions = JSON.parse(exclusionsStr);
            
            // Count ticks (yes), crosses (no), and question marks (unknown) across all checklists
            let ticks = 0, crosses = 0, questions = 0;
            
            // Process eligibility and competitiveness checklists
            // Exclusions checklist is NOT included in pie chart
            [...eligibility, ...competitiveness].forEach(item => {
                const status = item.status;
                if (status === 'yes') ticks++;
                else if (status === 'no') crosses++;
                else questions++;
            });
            
            const total = ticks + crosses + questions;
            if (total === 0) {
                // Show empty circle
                return;
            }
            
            // Calculate angles for pie chart
            const radius = 25;
            const centerX = 30;
            const centerY = 30;
            let currentAngle = -90; // Start at top
            
            // Colors: green for ticks, red for crosses, orange/yellow for questions
            const colors = {
                ticks: '#22c55e',    // green
                crosses: '#ef4444',  // red
                questions: '#f59e0b' // orange/yellow
            };
            
            // Clear existing paths
            svg.innerHTML = '';
            
            // Draw ticks segment (green)
            if (ticks > 0) {
                const ticksAngle = (ticks / total) * 360;
                const ticksPath = createPieSegment(centerX, centerY, radius, currentAngle, currentAngle + ticksAngle);
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', ticksPath);
                path.setAttribute('fill', colors.ticks);
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', '1');
                svg.appendChild(path);
                currentAngle += ticksAngle;
            }
            
            // Draw crosses segment (red)
            if (crosses > 0) {
                const crossesAngle = (crosses / total) * 360;
                const crossesPath = createPieSegment(centerX, centerY, radius, currentAngle, currentAngle + crossesAngle);
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', crossesPath);
                path.setAttribute('fill', colors.crosses);
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', '1');
                svg.appendChild(path);
                currentAngle += crossesAngle;
            }
            
            // Draw questions segment (orange/yellow)
            if (questions > 0) {
                const questionsAngle = (questions / total) * 360;
                const questionsPath = createPieSegment(centerX, centerY, radius, currentAngle, currentAngle + questionsAngle);
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', questionsPath);
                path.setAttribute('fill', colors.questions);
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', '1');
                svg.appendChild(path);
            }
        } catch (e) {
            console.error('Error rendering pie chart:', e);
        }
    }
    
    // Helper function to create pie segment path
    function createPieSegment(cx, cy, r, startAngle, endAngle) {
        const start = polarToCartesian(cx, cy, r, endAngle);
        const end = polarToCartesian(cx, cy, r, startAngle);
        const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
        return [
            "M", cx, cy,
            "L", start.x, start.y,
            "A", r, r, 0, largeArcFlag, 0, end.x, end.y,
            "Z"
        ].join(" ");
    }
    
    // Helper function to convert polar to cartesian coordinates
    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    }
    
    // Render all pie charts
    document.querySelectorAll('.checklist-pie-chart').forEach(renderPieChart);
    
    // Rotate collapse arrows when expanded
    document.querySelectorAll('.collapse input[type="checkbox"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const collapse = this.closest('.collapse');
            const arrow = collapse.querySelector('.collapse-arrow-icon');
            if (arrow) {
                if (this.checked) {
                    arrow.style.transform = 'rotate(90deg)';
                } else {
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        });
        // Set initial state
        const collapse = checkbox.closest('.collapse');
        const arrow = collapse.querySelector('.collapse-arrow-icon');
        if (arrow) {
            if (checkbox.checked) {
                arrow.style.transform = 'rotate(90deg)';
            } else {
                arrow.style.transform = 'rotate(0deg)';
            }
        }
    });
    
    // Checklist edit functionality
    let currentEditData = null;
    
    window.openChecklistEditModal = function(matchId, checklistType, itemIndex, currentStatus, criterion) {
        currentEditData = {
            matchId: matchId,
            checklistType: checklistType,
            itemIndex: itemIndex
        };
        
        document.getElementById('edit-modal-criterion').textContent = criterion;
        document.getElementById('edit-modal-status').value = currentStatus || 'unknown';
        document.getElementById('checklist-edit-modal').showModal();
    };
    
    document.getElementById('save-checklist-edit-btn').addEventListener('click', function() {
        if (!currentEditData) return;
        
        // Validate matchId
        if (!currentEditData.matchId || !Number.isInteger(Number(currentEditData.matchId))) {
            showToast('Invalid match ID. Please refresh the page.', 'error');
            return;
        }
        if (!currentEditData.checklistType || !['eligibility', 'competitiveness', 'exclusions'].includes(currentEditData.checklistType)) {
            showToast('Invalid checklist type.', 'error');
            return;
        }
        if (!Number.isInteger(Number(currentEditData.itemIndex)) || Number(currentEditData.itemIndex) < 0) {
            showToast('Invalid item index.', 'error');
            return;
        }
        
        const newStatus = document.getElementById('edit-modal-status').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('CSRF token not found. Please refresh the page.', 'error');
            return;
        }
        
        fetch(`/companies/grant_match_results/${currentEditData.matchId}/edit_checklist/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken.value,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                checklist_type: currentEditData.checklistType,
                item_index: currentEditData.itemIndex,
                status: newStatus
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }).catch(() => {
                    throw new Error(`HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update the UI
                const checklistItem = document.querySelector(
                    `.checklist-item[data-match-id="${currentEditData.matchId}"][data-checklist-type="${currentEditData.checklistType}"][data-item-index="${currentEditData.itemIndex}"]`
                );
                
                if (checklistItem) {
                    // Update status icon
                    const statusIcon = checklistItem.querySelector('.checklist-status-icon');
                    if (statusIcon) {
                        if (newStatus === 'yes') {
                            statusIcon.textContent = '✓';
                            statusIcon.className = 'text-success text-base checklist-status-icon';
                        } else if (newStatus === 'no') {
                            statusIcon.textContent = '✗';
                            statusIcon.className = 'text-error text-base checklist-status-icon';
                        } else {
                            statusIcon.textContent = '?';
                            statusIcon.className = 'text-warning text-base checklist-status-icon';
                        }
                    }
                    
                    // Update reason/manually edited text
                    const reasonP = checklistItem.querySelector('p.text-xs');
                    if (reasonP) {
                        reasonP.className = 'text-xs font-bold text-accent mt-1';
                        reasonP.textContent = 'Manually edited';
                    } else {
                        // Create new paragraph if it doesn't exist
                        const flexDiv = checklistItem.querySelector('.flex-1');
                        if (flexDiv) {
                            const newP = document.createElement('p');
                            newP.className = 'text-xs font-bold text-accent mt-1';
                            newP.textContent = 'Manually edited';
                            flexDiv.appendChild(newP);
                        }
                    }
                    
                    // Recalculate scores and update pie chart
                    updateChecklistScores(checklistItem);
                    updatePieChartForMatch(currentEditData.matchId);
                    // Update overall match score for this card
                    // DISABLED: Display database value instead of recalculating
                    // updateOverallMatchScore(checklistItem.closest('.card'));
                    // Re-sort list view cards by updated overall match score
                    sortListViewCardsByOverallMatchScore();
                }
                
                document.getElementById('checklist-edit-modal').close();
                currentEditData = null;
            } else {
                showToast('Error updating checklist item: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            {% if debug %}
            console.error('Error:', error);
            {% endif %}
            showToast('Error updating checklist item. Please try again.', 'error');
        });
    });
    
    function updateChecklistScores(checklistItem) {
        // Trigger the existing score calculation functions
        const container = checklistItem.closest('.eligibility-checklist-items, .competitiveness-checklist-items, .exclusions-checklist-items');
        if (container) {
            if (container.classList.contains('eligibility-checklist-items')) {
                // Recalculate eligibility score
                const items = container.querySelectorAll('.checklist-item');
                const totalItems = items.length; // Count all items including "don't know"
                let yesCount = 0;
                let noCount = 0;
                
                items.forEach(item => {
                    const icon = item.querySelector('.checklist-status-icon');
                    if (icon) {
                        if (icon.textContent.includes('✓')) {
                            yesCount++;
                        } else if (icon.textContent.includes('✗')) {
                            noCount++;
                        }
                    }
                    // "don't know" items are counted in totalItems but not in yesCount/noCount
                });
                
                const scoreText = totalItems > 0 ? `(${yesCount}/${totalItems})` : '';
                const percentage = totalItems > 0 ? Math.round((yesCount / totalItems) * 100) : 0;
                
                const collapseSection = container.closest('.collapse');
                const scoreSpan = collapseSection ? collapseSection.querySelector('.eligibility-checklist-score') : null;
                if (scoreSpan && totalItems > 0) {
                    scoreSpan.textContent = scoreText;
                }
                
                const card = container.closest('.card');
                const breakdownPercentage = card ? card.querySelector('.eligibility-breakdown-percentage') : null;
                if (breakdownPercentage && totalItems > 0) {
                    // Safe: percentage and scoreText are numbers/calculated values, not user input
                    breakdownPercentage.innerHTML = `${percentage}% <span class="text-xs font-normal text-base-content/60 eligibility-breakdown-count ml-1">${escapeHtml(scoreText)}</span>`;
                }
                // Update overall match score
                // DISABLED: Display database value instead of recalculating
                // if (card) {
                //     updateOverallMatchScore(card);
                // }
            } else if (container.classList.contains('competitiveness-checklist-items')) {
                // Recalculate competitiveness score
                const items = container.querySelectorAll('.checklist-item');
                const totalItems = items.length; // Count all items including "don't know"
                let yesCount = 0;
                let noCount = 0;
                
                items.forEach(item => {
                    const icon = item.querySelector('.checklist-status-icon');
                    if (icon) {
                        if (icon.textContent.includes('✓')) {
                            yesCount++;
                        } else if (icon.textContent.includes('✗')) {
                            noCount++;
                        }
                    }
                    // "don't know" items are counted in totalItems but not in yesCount/noCount
                });
                
                const scoreText = totalItems > 0 ? `(${yesCount}/${totalItems})` : '';
                const percentage = totalItems > 0 ? Math.round((yesCount / totalItems) * 100) : 0;
                
                const collapseSection = container.closest('.collapse');
                const scoreSpan = collapseSection ? collapseSection.querySelector('.competitiveness-checklist-score') : null;
                if (scoreSpan && totalItems > 0) {
                    scoreSpan.textContent = scoreText;
                }
                
                const card = container.closest('.card');
                const breakdownPercentage = card ? card.querySelector('.competitiveness-breakdown-percentage') : null;
                if (breakdownPercentage && totalItems > 0) {
                    // Safe: percentage and scoreText are numbers/calculated values, not user input
                    breakdownPercentage.innerHTML = `${percentage}% <span class="text-xs font-normal text-base-content/60 competitiveness-breakdown-count ml-1">${escapeHtml(scoreText)}</span>`;
                }
                // Update overall match score
                // DISABLED: Display database value instead of recalculating
                // if (card) {
                //     updateOverallMatchScore(card);
                // }
            } else if (container.classList.contains('exclusions-checklist-items')) {
                // Recalculate exclusions score (for exclusions, "no" is good)
                const items = container.querySelectorAll('.checklist-item');
                const totalItems = items.length; // Count all items including "don't know"
                let noCount = 0;
                let yesCount = 0;
                
                items.forEach(item => {
                    const icon = item.querySelector('.checklist-status-icon');
                    if (icon) {
                        if (icon.textContent.includes('✓')) {
                            noCount++; // "no" status shows green checkmark (not excluded = good)
                        } else if (icon.textContent.includes('✗')) {
                            yesCount++; // "yes" status shows red X (excluded = bad)
                        }
                    }
                    // "don't know" items are counted in totalItems but not in yesCount/noCount
                });
                
                const scoreText = totalItems > 0 ? `(${noCount}/${totalItems})` : '';
                const percentage = totalItems > 0 ? Math.round((noCount / totalItems) * 100) : 0;
                
                const collapseSection = container.closest('.collapse');
                const scoreSpan = collapseSection ? collapseSection.querySelector('.exclusions-checklist-score') : null;
                if (scoreSpan && totalItems > 0) {
                    scoreSpan.textContent = scoreText;
                }
                
                const card = container.closest('.card');
                const breakdownPercentage = card ? card.querySelector('.exclusions-breakdown-percentage') : null;
                if (breakdownPercentage && totalItems > 0) {
                    // Safe: percentage and scoreText are numbers/calculated values, not user input
                    breakdownPercentage.innerHTML = `${percentage}% <span class="text-xs font-normal text-base-content/60 exclusions-breakdown-count ml-1">${escapeHtml(scoreText)}</span>`;
                    const warningIcon = breakdownPercentage.querySelector('.exclusions-breakdown-warning-icon');
                    if (warningIcon) {
                        warningIcon.style.display = yesCount > 0 ? 'inline' : 'none';
                    }
                }
                // Update overall match score
                // DISABLED: Display database value instead of recalculating
                // if (card) {
                //     updateOverallMatchScore(card);
                // }
            }
        }
    }
    
    function updateOverallMatchScore(card) {
        // Update overall match score for a specific card
        // Uses multiplicative approach: eligibility × (0.3 + 0.7 × competitiveness)
        // Eligibility acts as a base multiplier - if eligibility is 0%, overall is 0%
        // Exclusions are disqualifying only (not included in calculation)
        if (!card) return;
        
        // Check if project is excluded first
        const exclusionsItems = card.querySelectorAll('.exclusions-checklist-items .checklist-item');
        let exclusionsYesCount = 0;
        let exclusionsDecidedCount = 0;
        exclusionsItems.forEach(function(item) {
            const icon = item.querySelector('.checklist-status-icon');
            const status = icon ? (icon.textContent.includes('✓') ? 'no' : icon.textContent.includes('✗') ? 'yes' : 'don\'t know') : 'don\'t know';
            if (status !== 'don\'t know') {
                exclusionsDecidedCount++;
                if (status === 'yes') {  // "yes" means IS excluded (bad)
                    exclusionsYesCount++;
                }
            }
        });
        
        // If excluded (any "yes" in exclusions checklist), score is 0
        if (exclusionsDecidedCount > 0) {
            // If there's even one "yes", the grant is excluded
            if (exclusionsYesCount > 0) {
                const overallMatchScores = card.querySelectorAll('.overall-match-score');
                overallMatchScores.forEach(function(scoreElement) {
                    scoreElement.textContent = '0%';
                });
                return;
            }
        }
        
        // Calculate eligibility score (percentage of "yes" out of decided items)
        const eligibilityItems = card.querySelectorAll('.eligibility-checklist-items .checklist-item');
        let eligibilityYesCount = 0;
        let eligibilityDecidedCount = 0;
        eligibilityItems.forEach(function(item) {
            const icon = item.querySelector('.checklist-status-icon');
            const status = icon ? (icon.textContent.includes('✓') ? 'yes' : icon.textContent.includes('✗') ? 'no' : 'don\'t know') : 'don\'t know';
            if (status !== 'don\'t know') {
                eligibilityDecidedCount++;
                if (status === 'yes') {
                    eligibilityYesCount++;
                }
            }
        });
        const eligibilityScore = eligibilityDecidedCount > 0 ? eligibilityYesCount / eligibilityDecidedCount : 0;
        
        // Calculate competitiveness score (percentage of "yes" out of decided items)
        const competitivenessItems = card.querySelectorAll('.competitiveness-checklist-items .checklist-item');
        let competitivenessYesCount = 0;
        let competitivenessDecidedCount = 0;
        competitivenessItems.forEach(function(item) {
            const icon = item.querySelector('.checklist-status-icon');
            const status = icon ? (icon.textContent.includes('✓') ? 'yes' : icon.textContent.includes('✗') ? 'no' : 'don\'t know') : 'don\'t know';
            if (status !== 'don\'t know') {
                competitivenessDecidedCount++;
                if (status === 'yes') {
                    competitivenessYesCount++;
                }
            }
        });
        const competitivenessScore = competitivenessDecidedCount > 0 ? competitivenessYesCount / competitivenessDecidedCount : 0;
        
        // Calculate multiplicative score: eligibility × (0.3 + 0.7 × competitiveness)
        // Eligibility acts as a base multiplier (paramount importance)
        let overallScore = 0;
        if (eligibilityDecidedCount > 0 && competitivenessDecidedCount > 0) {
            // Both assessed: multiplicative (eligibility as base)
            overallScore = eligibilityScore * (0.3 + 0.7 * competitivenessScore);
        } else if (eligibilityDecidedCount > 0) {
            // Only eligibility assessed
            overallScore = eligibilityScore;
        } else if (competitivenessDecidedCount > 0) {
            // Only competitiveness assessed
            overallScore = competitivenessScore;
        }
        
        // Update display only if we have checklist data (otherwise keep database score)
        if (eligibilityDecidedCount > 0 || competitivenessDecidedCount > 0 || exclusionsDecidedCount > 0) {
            const overallPercentage = Math.round(overallScore * 100);
            const overallMatchScores = card.querySelectorAll('.overall-match-score');
            overallMatchScores.forEach(function(scoreElement) {
                scoreElement.textContent = `${overallPercentage}%`;
            });
        }
        // If no checklist data found, leave the database score as-is (don't overwrite with 0)
    }
    
    function updatePieChartForMatch(matchId) {
        // Find the pie chart SVG for this match
        const svg = document.querySelector(`.checklist-pie-chart[data-match-id="${matchId}"]`);
        if (!svg) return;
        
        // Re-read checklist data from the DOM
        const card = svg.closest('.card');
        if (!card) return;
        
        // Collect all checklist items for this match
        const eligibilityItems = Array.from(card.querySelectorAll('.eligibility-checklist-items .checklist-item')).map(item => {
            const icon = item.querySelector('.checklist-status-icon');
            return {
                status: icon && icon.textContent.includes('✓') ? 'yes' : 
                       icon && icon.textContent.includes('✗') ? 'no' : 'unknown'
            };
        });
        
        const competitivenessItems = Array.from(card.querySelectorAll('.competitiveness-checklist-items .checklist-item')).map(item => {
            const icon = item.querySelector('.checklist-status-icon');
            return {
                status: icon && icon.textContent.includes('✓') ? 'yes' : 
                       icon && icon.textContent.includes('✗') ? 'no' : 'unknown'
            };
        });
        
        const exclusionsItems = Array.from(card.querySelectorAll('.exclusions-checklist-items .checklist-item')).map(item => {
            const icon = item.querySelector('.checklist-status-icon');
            return {
                status: icon && icon.textContent.includes('✓') ? 'no' :  // Inverted: ✓ means 'no' exclusion
                       icon && icon.textContent.includes('✗') ? 'yes' : 'unknown'
            };
        });
        
        // Update data attributes
        svg.setAttribute('data-eligibility', JSON.stringify(eligibilityItems));
        svg.setAttribute('data-competitiveness', JSON.stringify(competitivenessItems));
        svg.setAttribute('data-exclusions', JSON.stringify(exclusionsItems));
        
        // Re-render the pie chart
        renderPieChart(svg);
    }
    
    // Undo checklist edit function
    window.undoChecklistEdit = function(matchId, checklistType, itemIndex) {
        if (!confirm('Reset this checklist item to the AI-generated value?')) {
            return;
        }
        
        // Validate inputs
        if (!matchId || !Number.isInteger(Number(matchId))) {
            showToast('Invalid match ID. Please refresh the page.', 'error');
            return;
        }
        if (!checklistType || !['eligibility', 'competitiveness', 'exclusions'].includes(checklistType)) {
            showToast('Invalid checklist type.', 'error');
            return;
        }
        if (!Number.isInteger(Number(itemIndex)) || Number(itemIndex) < 0) {
            showToast('Invalid item index.', 'error');
            return;
        }
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('CSRF token not found. Please refresh the page.', 'error');
            return;
        }
        
        fetch(`/companies/grant_match_results/${matchId}/undo_checklist/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken.value,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                checklist_type: checklistType,
                item_index: itemIndex
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }).catch(() => {
                    throw new Error(`HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Reload the page to show the restored values
                window.location.reload();
            } else {
                showToast('Error undoing checklist edit: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            {% if debug %}
            console.error('Error:', error);
            {% endif %}
            showToast('Error undoing checklist edit. Please try again.', 'error');
        });
    };
});

// Function to calculate certainty for all elements
function calculateAllCertainty() {
    document.querySelectorAll('.certainty-percentage').forEach(function(certaintyElement) {
        if (certaintyElement.textContent === 'Calculating...' || certaintyElement.textContent.trim() === '') {
            try {
                // First, check if backend certainty is available
                const backendCertainty = certaintyElement.getAttribute('data-certainty');
                if (backendCertainty !== null && backendCertainty !== '') {
                    const certaintyPercentage = Math.round(parseFloat(backendCertainty) * 100);
                    certaintyElement.textContent = `${certaintyPercentage}% Certainty`;
                    return;
                }
                
                // Fallback to calculating from checklist data
                const matchId = certaintyElement.getAttribute('data-match-id');
                // Search in the entire document for the pie chart
                const svgElement = document.querySelector(`svg.checklist-pie-chart[data-match-id="${matchId}"]`);
                
                if (svgElement) {
                    const eligibilityData = JSON.parse(svgElement.getAttribute('data-eligibility') || '[]');
                    const competitivenessData = JSON.parse(svgElement.getAttribute('data-competitiveness') || '[]');
                    // Exclusions checklist is NOT included in certainty calculation
                    
                    const allItems = [...eligibilityData, ...competitivenessData];
                    const totalItems = allItems.length;
                    
                    if (totalItems > 0) {
                        const yesNoCount = allItems.filter(item => item.status === 'yes' || item.status === 'no').length;
                        const certaintyPercentage = Math.round((yesNoCount / totalItems) * 100);
                        certaintyElement.textContent = `${certaintyPercentage}% Certainty`;
                    } else {
                        certaintyElement.textContent = '';
                    }
                }
            } catch (e) {
                console.error('Error calculating certainty:', e);
            }
        }
    });
}

// Set initial view based on URL parameter and handle view switching
document.addEventListener('DOMContentLoaded', function() {
    const listView = document.getElementById('list-view');
    const gridView = document.getElementById('grid-view');
    const remainingGrantsList = document.getElementById('remaining-grants-list');
    const remainingGrantsGrid = document.getElementById('remaining-grants-grid');
    const excludedGrantsList = document.getElementById('excluded-grants-list');
    const excludedGrantsGrid = document.getElementById('excluded-grants-grid');
    
    // Get current view from URL or default to list
    const urlParams = new URLSearchParams(window.location.search);
    const currentView = urlParams.get('view') || 'list';
    
    // Set initial view
    function setView(view) {
        if (view === 'list') {
            if (listView) listView.style.display = 'block';
            if (gridView) gridView.style.display = 'none';
            if (remainingGrantsList) remainingGrantsList.style.display = 'block';
            if (remainingGrantsGrid) remainingGrantsGrid.style.display = 'none';
            if (excludedGrantsList) excludedGrantsList.style.display = 'block';
            if (excludedGrantsGrid) excludedGrantsGrid.style.display = 'none';
        } else if (view === 'grid') {
            if (listView) listView.style.display = 'none';
            if (gridView) gridView.style.display = 'grid';
            if (remainingGrantsList) remainingGrantsList.style.display = 'none';
            if (remainingGrantsGrid) remainingGrantsGrid.style.display = 'grid';
            if (excludedGrantsList) excludedGrantsList.style.display = 'none';
            if (excludedGrantsGrid) excludedGrantsGrid.style.display = 'grid';
            // Recalculate certainty when switching to grid view
            setTimeout(calculateAllCertainty, 100);
        }
    }
    
    // Set initial view on page load
    setView(currentView);
    
    // Handle view toggle button clicks (update URL)
    const viewToggleButtons = document.querySelectorAll('.view-toggle-btn');
    viewToggleButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default link behavior
            const view = this.getAttribute('data-view');
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('view', view);
            // Preserve the tab parameter
            if (!urlParams.has('tab')) {
                urlParams.set('tab', 'results');
            }
            // Update URL without page reload
            window.history.pushState({}, '', '?' + urlParams.toString());
            // Update button states
            viewToggleButtons.forEach(function(btn) {
                btn.classList.remove('btn-active');
            });
            this.classList.add('btn-active');
            // Update view
            setView(view);
        });
    });
});

// Toggle remaining grants section
function toggleRemainingGrants() {
    const section = document.getElementById('remaining-grants-section');
    const button = document.getElementById('toggle-remaining-grants');
    const text = document.getElementById('toggle-text');
    const icon = document.getElementById('toggle-icon');
    const remainingGrantsList = document.getElementById('remaining-grants-list');
    const remainingGrantsGrid = document.getElementById('remaining-grants-grid');
    
    // Determine current view mode from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentView = urlParams.get('view') || 'list';
    
    if (section && button && text && icon) {
        const isHidden = section.classList.contains('hidden');
        const remainingCount = parseInt(button.getAttribute('data-remaining-count')) || 0;
        
        if (isHidden) {
            section.classList.remove('hidden');
            text.textContent = 'Hide Remaining Grants';
            icon.style.transform = 'rotate(180deg)';
            
            // Show the appropriate view based on current mode
            if (currentView === 'grid') {
                if (remainingGrantsList) remainingGrantsList.style.display = 'none';
                if (remainingGrantsGrid) remainingGrantsGrid.style.display = 'grid';
                setTimeout(calculateAllCertainty, 100);
            } else {
                if (remainingGrantsList) remainingGrantsList.style.display = 'block';
                if (remainingGrantsGrid) remainingGrantsGrid.style.display = 'none';
            }
        } else {
            section.classList.add('hidden');
            text.textContent = `View All ${remainingCount} Remaining Grant${remainingCount !== 1 ? 's' : ''}`;
            icon.style.transform = 'rotate(0deg)';
        }
    }
}

// Toggle not eligible grants section
function toggleNotEligibleGrants() {
    const section = document.getElementById('not-eligible-grants-section');
    const button = document.getElementById('toggle-not-eligible-grants');
    const text = document.getElementById('toggle-not-eligible-text');
    const icon = document.getElementById('toggle-not-eligible-icon');
    const notEligibleGrantsList = document.getElementById('not-eligible-grants-list');
    const notEligibleGrantsGrid = document.getElementById('not-eligible-grants-grid');
    
    // Determine current view mode from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentView = urlParams.get('view') || 'list';
    
    if (section && button && text && icon) {
        const isHidden = section.classList.contains('hidden');
        const notEligibleCount = parseInt(button.getAttribute('data-not-eligible-count')) || 0;
        
        if (isHidden) {
            section.classList.remove('hidden');
            text.textContent = 'Hide Not Eligible Grants';
            icon.style.transform = 'rotate(180deg)';
            
            // Show the appropriate view based on current mode
            if (currentView === 'grid') {
                if (notEligibleGrantsList) notEligibleGrantsList.style.display = 'none';
                if (notEligibleGrantsGrid) notEligibleGrantsGrid.style.display = 'grid';
                setTimeout(calculateAllCertainty, 100);
            } else {
                if (notEligibleGrantsList) notEligibleGrantsList.style.display = 'block';
                if (notEligibleGrantsGrid) notEligibleGrantsGrid.style.display = 'none';
            }
        } else {
            section.classList.add('hidden');
            text.textContent = `View ${notEligibleCount} Not Eligible Grant${notEligibleCount !== 1 ? 's' : ''}`;
            icon.style.transform = 'rotate(0deg)';
        }
    }
}

// Toggle excluded grants section
function toggleExcludedGrants() {
    const section = document.getElementById('excluded-grants-section');
    const button = document.getElementById('toggle-excluded-grants');
    const text = document.getElementById('toggle-excluded-text');
    const icon = document.getElementById('toggle-excluded-icon');
    const excludedGrantsList = document.getElementById('excluded-grants-list');
    const excludedGrantsGrid = document.getElementById('excluded-grants-grid');
    
    // Determine current view mode from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentView = urlParams.get('view') || 'list';
    
    if (section && button && text && icon) {
        const isHidden = section.classList.contains('hidden');
        const excludedCount = parseInt(button.getAttribute('data-excluded-count')) || 0;
        
        if (isHidden) {
            section.classList.remove('hidden');
            text.textContent = 'Hide Excluded Grants';
            icon.style.transform = 'rotate(180deg)';
            
            // Show the appropriate view based on current mode
            if (currentView === 'grid') {
                if (excludedGrantsList) excludedGrantsList.style.display = 'none';
                if (excludedGrantsGrid) excludedGrantsGrid.style.display = 'grid';
                setTimeout(calculateAllCertainty, 100);
            } else {
                if (excludedGrantsList) excludedGrantsList.style.display = 'block';
                if (excludedGrantsGrid) excludedGrantsGrid.style.display = 'none';
            }
        } else {
            section.classList.add('hidden');
            text.textContent = `View ${excludedCount} Excluded Grant${excludedCount !== 1 ? 's' : ''}`;
            icon.style.transform = 'rotate(0deg)';
        }
    }
}

// Extract and display TRL levels from text
function extractAndDisplayTRL() {
    const trlElements = document.querySelectorAll('.trl-extract');
    trlElements.forEach(function(element) {
        const text = element.textContent;
        // Try to find TRL pattern (e.g., "TRL 5", "TRL-5", "Technology Readiness Level 5", "level 5")
        const patterns = [
            /TRL\s*[:\-]?\s*(\d)/i,
            /Technology\s+Readiness\s+Level\s+(\d)/i,
            /level\s+(\d)/i,
        ];
        
        let trlNumber = null;
        for (const pattern of patterns) {
            const match = text.match(pattern);
            if (match) {
                trlNumber = parseInt(match[1]);
                if (trlNumber >= 1 && trlNumber <= 9) {
                    break;
                }
            }
        }
        
        if (trlNumber) {
            element.textContent = `TRL ${trlNumber}`;
        } else {
            // If no TRL found, hide the badge
            const badge = element.closest('.badge');
            if (badge && badge.textContent.includes('Project TRL:')) {
                badge.style.display = 'none';
            }
        }
    });
}

// Call TRL extraction on page load
document.addEventListener('DOMContentLoaded', function() {
    extractAndDisplayTRL();
});

// Inline name editing
function editName() {
    const nameElement = document.getElementById('funding-search-name');
    if (!nameElement) return;
    
    const currentName = nameElement.textContent.trim();
    
    // Create input field
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentName;
    input.className = 'input input-bordered text-2xl font-bold';
    input.style.width = '100%';
    input.style.maxWidth = '600px';
    
    // Replace name with input
    nameElement.style.display = 'none';
    nameElement.parentElement.insertBefore(input, nameElement);
    input.focus();
    input.select();
    
    // Save on Enter or blur
    function saveName() {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
            // Create form data
            const formData = new FormData();
            formData.append('name', newName);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                showToast('CSRF token not found. Please refresh the page.', 'error');
                nameElement.style.display = '';
                input.remove();
                return;
            }
            formData.append('csrfmiddlewaretoken', csrfToken.value);
            
            // Submit via fetch
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken.value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json().catch(() => ({})); // Try to parse JSON, but allow non-JSON responses
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to update name');
                    }).catch(() => {
                        throw new Error('Failed to update name');
                    });
                }
            })
            .then(data => {
                    nameElement.textContent = newName;
                    nameElement.style.display = '';
                    input.remove();
                showToast('Name updated successfully.', 'success');
                    // Reload page to show updated name
                setTimeout(() => window.location.reload(), 500);
            })
            .catch(error => {
                showToast(error.message || 'Error updating name. Please try again.', 'error');
                nameElement.style.display = '';
                input.remove();
            });
        } else {
            // Cancel editing
            nameElement.style.display = '';
            input.remove();
        }
    }
    
    input.addEventListener('blur', saveName);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            input.blur();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            nameElement.style.display = '';
            input.remove();
        }
    });
}

// Calculate and display checklist scores
document.addEventListener('DOMContentLoaded', function() {
    // Store scores per card for overall match calculation
    const cardScores = new Map();
    
    // Calculate eligibility checklist scores
    // Process list view first to maintain correct order, then grid view
    const listView = document.getElementById('list-view');
    const gridView = document.getElementById('grid-view');
    const remainingGrantsList = document.getElementById('remaining-grants-list');
    const remainingGrantsGrid = document.getElementById('remaining-grants-grid');
    
    // Process list view cards first (in DOM order)
    const listViewContainers = [];
    if (listView) {
        listViewContainers.push(...listView.querySelectorAll('.eligibility-checklist-items'));
    }
    if (remainingGrantsList) {
        listViewContainers.push(...remainingGrantsList.querySelectorAll('.eligibility-checklist-items'));
    }
    const excludedGrantsList = document.getElementById('excluded-grants-list');
    if (excludedGrantsList) {
        listViewContainers.push(...excludedGrantsList.querySelectorAll('.eligibility-checklist-items'));
    }
    
    // Then process grid view cards
    const gridViewContainers = [];
    if (gridView) {
        gridViewContainers.push(...gridView.querySelectorAll('.eligibility-checklist-items'));
    }
    if (remainingGrantsGrid) {
        gridViewContainers.push(...remainingGrantsGrid.querySelectorAll('.eligibility-checklist-items'));
    }
    const excludedGrantsGrid = document.getElementById('excluded-grants-grid');
    if (excludedGrantsGrid) {
        gridViewContainers.push(...excludedGrantsGrid.querySelectorAll('.eligibility-checklist-items'));
    }
    
    // Process in order: list view first, then grid view
    [...listViewContainers, ...gridViewContainers].forEach(function(container) {
        const items = container.querySelectorAll('.flex.items-start');
        const totalItems = items.length; // Count all items including "don't know"
        let yesCount = 0;
        let noCount = 0;
        
        items.forEach(function(item) {
            const successIcon = item.querySelector('.text-success');
            const errorIcon = item.querySelector('.text-error');
            if (successIcon) {
                yesCount++;
            } else if (errorIcon) {
                noCount++;
            }
            // "don't know" items are counted in totalItems but not in yesCount/noCount
        });
        
        const scoreText = totalItems > 0 ? `(${yesCount}/${totalItems})` : '';
        const percentage = totalItems > 0 ? Math.round((yesCount / totalItems) * 100) : 0;
        
        // Update heading score (look for it in the collapse-title)
        const collapseSection = container.closest('.collapse');
        const scoreSpan = collapseSection ? collapseSection.querySelector('.eligibility-checklist-score') : null;
        if (scoreSpan && totalItems > 0) {
            scoreSpan.textContent = scoreText;
        }
        
        // Update score breakdown percentage and count
        const card = container.closest('.card');
        const breakdownPercentage = card ? card.querySelector('.eligibility-breakdown-percentage') : null;
        if (breakdownPercentage && totalItems > 0) {
            // Safe: percentage and scoreText are numbers/calculated values, not user input
            breakdownPercentage.innerHTML = `${percentage}% <span class="text-xs font-normal text-base-content/60 eligibility-breakdown-count ml-1">${escapeHtml(scoreText)}</span>`;
        }
        
        // Store eligibility score for this card
        if (card) {
            if (!cardScores.has(card)) {
                cardScores.set(card, {});
            }
            cardScores.get(card).eligibility = percentage / 100; // Store as decimal (0.0-1.0)
        }
    });
    
    // Calculate competitiveness checklist scores
    // Process list view first to maintain correct order, then grid view
    const competitivenessListViewContainers = [];
    if (listView) {
        competitivenessListViewContainers.push(...listView.querySelectorAll('.competitiveness-checklist-items'));
    }
    if (remainingGrantsList) {
        competitivenessListViewContainers.push(...remainingGrantsList.querySelectorAll('.competitiveness-checklist-items'));
    }
    if (excludedGrantsList) {
        competitivenessListViewContainers.push(...excludedGrantsList.querySelectorAll('.competitiveness-checklist-items'));
    }
    
    const competitivenessGridViewContainers = [];
    if (gridView) {
        competitivenessGridViewContainers.push(...gridView.querySelectorAll('.competitiveness-checklist-items'));
    }
    if (remainingGrantsGrid) {
        competitivenessGridViewContainers.push(...remainingGrantsGrid.querySelectorAll('.competitiveness-checklist-items'));
    }
    if (excludedGrantsGrid) {
        competitivenessGridViewContainers.push(...excludedGrantsGrid.querySelectorAll('.competitiveness-checklist-items'));
    }
    
    [...competitivenessListViewContainers, ...competitivenessGridViewContainers].forEach(function(container) {
        const items = container.querySelectorAll('.flex.items-start');
        const totalItems = items.length; // Count all items including "don't know"
        let yesCount = 0;
        let noCount = 0;
        
        items.forEach(function(item) {
            const successIcon = item.querySelector('.text-success');
            const errorIcon = item.querySelector('.text-error');
            if (successIcon) {
                yesCount++;
            } else if (errorIcon) {
                noCount++;
            }
            // "don't know" items are counted in totalItems but not in yesCount/noCount
        });
        
        const scoreText = totalItems > 0 ? `(${yesCount}/${totalItems})` : '';
        const percentage = totalItems > 0 ? Math.round((yesCount / totalItems) * 100) : 0;
        
        // Update heading score (look for it in the collapse-title)
        const collapseSection = container.closest('.collapse');
        const scoreSpan = collapseSection ? collapseSection.querySelector('.competitiveness-checklist-score') : null;
        if (scoreSpan && totalItems > 0) {
            scoreSpan.textContent = scoreText;
        }
        
        // Update score breakdown percentage and count
        const card = container.closest('.card');
        const breakdownPercentage = card ? card.querySelector('.competitiveness-breakdown-percentage') : null;
        if (breakdownPercentage && totalItems > 0) {
            // Safe: percentage and scoreText are numbers/calculated values, not user input
            breakdownPercentage.innerHTML = `${percentage}% <span class="text-xs font-normal text-base-content/60 competitiveness-breakdown-count ml-1">${escapeHtml(scoreText)}</span>`;
        }
        
        // Store competitiveness score for this card
        if (card) {
            if (!cardScores.has(card)) {
                cardScores.set(card, {});
            }
            cardScores.get(card).competitiveness = percentage / 100; // Store as decimal (0.0-1.0)
        }
    });
    
    // Calculate exclusions checklist scores (for exclusions, "no" is good - means NOT excluded)
    // Process list view first to maintain correct order, then grid view
    const exclusionsListViewContainers = [];
    if (listView) {
        exclusionsListViewContainers.push(...listView.querySelectorAll('.exclusions-checklist-items'));
    }
    if (remainingGrantsList) {
        exclusionsListViewContainers.push(...remainingGrantsList.querySelectorAll('.exclusions-checklist-items'));
    }
    if (excludedGrantsList) {
        exclusionsListViewContainers.push(...excludedGrantsList.querySelectorAll('.exclusions-checklist-items'));
    }
    
    const exclusionsGridViewContainers = [];
    if (gridView) {
        exclusionsGridViewContainers.push(...gridView.querySelectorAll('.exclusions-checklist-items'));
    }
    if (remainingGrantsGrid) {
        exclusionsGridViewContainers.push(...remainingGrantsGrid.querySelectorAll('.exclusions-checklist-items'));
    }
    if (excludedGrantsGrid) {
        exclusionsGridViewContainers.push(...excludedGrantsGrid.querySelectorAll('.exclusions-checklist-items'));
    }
    
    [...exclusionsListViewContainers, ...exclusionsGridViewContainers].forEach(function(container) {
        const items = container.querySelectorAll('.flex.items-start');
        const totalItems = items.length; // Count all items including "don't know"
        let noCount = 0; // Count "no" answers (not excluded = good)
        let yesCount = 0; // Count "yes" answers (excluded = bad)
        
        items.forEach(function(item) {
            // "no" status shows green checkmark (not excluded = good)
            const successIcon = item.querySelector('span.text-success');
            if (successIcon && successIcon.textContent.includes('✓')) {
                noCount++;
            }
            // Check for "yes" status (excluded - shows red X)
            const errorIcon = item.querySelector('span.text-error');
            if (errorIcon && errorIcon.textContent.includes('✗')) {
                yesCount++;
            }
            // "don't know" items are counted in totalItems but not in yesCount/noCount
        });
        
        const scoreText = totalItems > 0 ? `(${noCount}/${totalItems})` : '';
        const percentage = totalItems > 0 ? Math.round((noCount / totalItems) * 100) : 0;
        
        // Update heading score (look for it in the collapse-title)
        const collapseSection = container.closest('.collapse');
        const scoreSpan = collapseSection ? collapseSection.querySelector('.exclusions-checklist-score') : null;
        if (scoreSpan && totalItems > 0) {
            scoreSpan.textContent = scoreText;
        }
        
        // Update score breakdown percentage and count
        const card = container.closest('.card');
        const breakdownPercentage = card ? card.querySelector('.exclusions-breakdown-percentage') : null;
        if (breakdownPercentage && totalItems > 0) {
            // Safe: percentage and scoreText are numbers/calculated values, not user input
            const warningIconHtml = yesCount > 0 ? '<span class="exclusions-breakdown-warning-icon" style="display: inline; margin-left: 0.5rem;">⚠️</span>' : '<span class="exclusions-breakdown-warning-icon" style="display: none; margin-left: 0.5rem;">⚠️</span>';
            breakdownPercentage.innerHTML = `${percentage}% <span class="text-xs font-normal text-base-content/60 exclusions-breakdown-count ml-1">${escapeHtml(scoreText)}</span>${warningIconHtml}`;
        }
        
        // Show warning icon in heading if any exclusion is met
        const warningIconSpan = collapseSection ? collapseSection.querySelector('.exclusions-warning-icon') : null;
        if (warningIconSpan) {
            if (yesCount > 0) {
                warningIconSpan.style.display = 'inline';
            } else {
                warningIconSpan.style.display = 'none';
            }
        }
        
        // Store exclusions score for this card
        if (card) {
            if (!cardScores.has(card)) {
                cardScores.set(card, {});
            }
            cardScores.get(card).exclusions = percentage / 100; // Store as decimal (0.0-1.0)
        }
    });
    
    // Overall match scores are now calculated by updateOverallMatchScore() 
    // which is called for all cards below (line 4175)
    // This removes duplicate calculation logic
    
    // DISABLED: Display database value instead of recalculating
    // Ensure all cards with checklist items have their scores recalculated using updateOverallMatchScore
    // This catches any cards that might have been missed in the cardScores loop
    // document.querySelectorAll('.card').forEach(function(card) {
    //     const hasChecklistItems = card.querySelectorAll('.eligibility-checklist-items .checklist-item, .competitiveness-checklist-items .checklist-item, .exclusions-checklist-items .checklist-item').length > 0;
    //     if (hasChecklistItems) {
    //         updateOverallMatchScore(card);
    //     }
    // });
    
    // Calculate certainty percentage
    cardScores.forEach(function(scores, card) {
        // Calculate certainty percentage
        const certaintyElement = card.querySelector('.certainty-percentage');
        if (certaintyElement) {
            try {
                // First, check if backend certainty is available
                const backendCertainty = certaintyElement.getAttribute('data-certainty');
                if (backendCertainty !== null && backendCertainty !== '') {
                    const certaintyPercentage = Math.round(parseFloat(backendCertainty) * 100);
                    certaintyElement.textContent = `${certaintyPercentage}% Certainty`;
                } else {
                    // Fallback to calculating from checklist data
                    const matchId = certaintyElement.getAttribute('data-match-id');
                    const svgElement = card.querySelector(`svg[data-match-id="${matchId}"]`);
                    
                    if (svgElement) {
                        const eligibilityData = JSON.parse(svgElement.getAttribute('data-eligibility') || '[]');
                        const competitivenessData = JSON.parse(svgElement.getAttribute('data-competitiveness') || '[]');
                        const exclusionsData = JSON.parse(svgElement.getAttribute('data-exclusions') || '[]');
                        
                        const allItems = [...eligibilityData, ...competitivenessData, ...exclusionsData];
                        const totalItems = allItems.length;
                        
                        if (totalItems > 0) {
                            const yesNoCount = allItems.filter(item => item.status === 'yes' || item.status === 'no').length;
                            const certaintyPercentage = Math.round((yesNoCount / totalItems) * 100);
                            certaintyElement.textContent = `${certaintyPercentage}% Certainty`;
                        } else {
                            certaintyElement.textContent = '';
                        }
                    } else {
                        certaintyElement.textContent = '';
                    }
                }
            } catch (e) {
                console.error('Error calculating certainty:', e);
                certaintyElement.textContent = '';
            }
        }
    });
    
    // DISABLED: Display database value instead of recalculating
    // Ensure all cards with checklist items have their scores recalculated using updateOverallMatchScore
    // This catches any cards that might have been missed in the cardScores loop
    // document.querySelectorAll('.card').forEach(function(card) {
    //     const hasChecklistItems = card.querySelectorAll('.eligibility-checklist-items .checklist-item, .competitiveness-checklist-items .checklist-item, .exclusions-checklist-items .checklist-item').length > 0;
    //     if (hasChecklistItems) {
    //         updateOverallMatchScore(card);
    //     }
    // });
    
    // Sort list view cards by recalculated overall match score (descending)
    // This ensures the list view is ordered by the frontend-calculated score, not the database match_score
    sortListViewCardsByOverallMatchScore();
    
    // Calculate certainty for all cards (including grid view cards that might not have checklist scores)
    document.querySelectorAll('.certainty-percentage').forEach(function(certaintyElement) {
        if (certaintyElement.textContent === 'Calculating...') {
            try {
                // First, check if backend certainty is available
                const backendCertainty = certaintyElement.getAttribute('data-certainty');
                if (backendCertainty !== null && backendCertainty !== '') {
                    const certaintyPercentage = Math.round(parseFloat(backendCertainty) * 100);
                    certaintyElement.textContent = `${certaintyPercentage}% Certainty`;
                    return;
                }
                
                // Fallback to calculating from checklist data
                const matchId = certaintyElement.getAttribute('data-match-id');
                // Search in the entire document, not just within a card
                const svgElement = document.querySelector(`svg.checklist-pie-chart[data-match-id="${matchId}"]`);
                
                if (svgElement) {
                    const eligibilityData = JSON.parse(svgElement.getAttribute('data-eligibility') || '[]');
                    const competitivenessData = JSON.parse(svgElement.getAttribute('data-competitiveness') || '[]');
                    // Exclusions checklist is NOT included in certainty calculation
                    
                    const allItems = [...eligibilityData, ...competitivenessData];
                    const totalItems = allItems.length;
                    
                    if (totalItems > 0) {
                        const yesNoCount = allItems.filter(item => item.status === 'yes' || item.status === 'no').length;
                        const certaintyPercentage = Math.round((yesNoCount / totalItems) * 100);
                        certaintyElement.textContent = `${certaintyPercentage}% Certainty`;
                    } else {
                        certaintyElement.textContent = '';
                    }
                }
            } catch (e) {
                console.error('Error calculating certainty:', e);
            }
        }
    });
});

// Handle arrow rotation and score breakdown visibility for collapsible sections
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[type="checkbox"][id^="more-details-"]').forEach(function(checkbox) {
        const arrowIcon = checkbox.closest('.collapse').querySelector('.collapse-arrow-icon');
        const matchId = checkbox.id.replace('more-details-', '');
        const scoreBreakdown = document.querySelector('.score-breakdown-' + matchId);
        
        // Function to update visibility
        function updateVisibility() {
            if (arrowIcon) {
                if (checkbox.checked) {
                    arrowIcon.style.transform = 'rotate(90deg)';
                } else {
                    arrowIcon.style.transform = 'rotate(0deg)';
                }
            }
            if (scoreBreakdown) {
                scoreBreakdown.style.display = checkbox.checked ? 'block' : 'none';
            }
        }
        
        // Set initial state
        updateVisibility();
        
        // Update on change
        checkbox.addEventListener('change', updateVisibility);
    });
});

// Open grant modal with full list view content
function openGrantModal(matchId) {
    const modal = document.getElementById('grant-modal');
    const modalContent = document.getElementById('grant-modal-content');
    
    if (!modal || !modalContent) return;
    
    // Find the list view card for this match
    let foundCard = document.querySelector(`#list-view .card[data-match-id="${matchId}"]`);
    
    if (!foundCard) {
        // Fallback: try to find by checking for elements with the match ID inside
        const listViewCards = document.querySelectorAll('#list-view .card');
        listViewCards.forEach(function(card) {
            const certaintyEl = card.querySelector(`.certainty-percentage[data-match-id="${matchId}"]`);
            if (certaintyEl && !foundCard) {
                foundCard = card;
            }
        });
        
        if (!foundCard) {
            console.error('Could not find list view card for match ID:', matchId);
            return;
        }
    }
    
    // Clone the card
    const clonedCard = foundCard.cloneNode(true);
    
    // Remove collapse functionality - convert all collapses to always-visible sections
    clonedCard.querySelectorAll('.collapse').forEach(function(collapse) {
        const checkbox = collapse.querySelector('input[type="checkbox"]');
        const title = collapse.querySelector('.collapse-title');
        const content = collapse.querySelector('.collapse-content');
        
        if (title && content) {
            // Get title text without icons and clean it up
            const titleClone = title.cloneNode(true);
            titleClone.querySelectorAll('svg, .collapse-arrow-icon').forEach(function(el) {
                el.remove();
            });
            let titleText = titleClone.textContent.trim();
            titleText = titleText.replace(/\(calculating\.\.\.\)/g, '').trim();
            
            // Determine heading class based on content
            const isDetails = titleText.includes('Details') || collapse.id && collapse.id.includes('more-details');
            const isChecklist = titleText.includes('Checklist');
            
            // Create a simple heading
            const titleDiv = document.createElement('div');
            if (isDetails) {
                titleDiv.className = 'font-semibold text-sm px-4 mb-2 mt-4';
                titleDiv.textContent = 'Details';
            } else if (isChecklist) {
                titleDiv.className = 'font-semibold text-xs px-4 mb-2 mt-4';
                titleDiv.textContent = titleText;
            } else {
                titleDiv.className = 'font-semibold text-xs px-4 mb-2 mt-4';
                titleDiv.textContent = titleText;
            }
            
            // Make content always visible
            content.classList.remove('collapse-content');
            content.style.display = 'block';
            content.style.paddingTop = '0.5rem';
            content.style.paddingBottom = '1rem';
            
            // Replace collapse with title and content
            const parent = collapse.parentElement;
            if (parent) {
                collapse.replaceWith(titleDiv);
                titleDiv.parentElement.insertBefore(content, titleDiv.nextSibling);
            }
        }
    });
    
    // Remove "Hide" button and its container
    clonedCard.querySelectorAll('button').forEach(function(btn) {
        if (btn.textContent && btn.textContent.includes('Hide')) {
            const hideSection = btn.closest('.border-t');
            if (hideSection) {
                hideSection.remove();
            }
        }
    });
    
    // Show score breakdown (remove display:none)
    clonedCard.querySelectorAll('[class*="score-breakdown-"]').forEach(function(el) {
        if (el.classList.toString().includes('score-breakdown-')) {
            el.style.display = 'block';
        }
    });
    
    // Expand all checklist items by removing collapse structure
    clonedCard.querySelectorAll('.collapse').forEach(function(collapse) {
        const content = collapse.querySelector('.collapse-content');
        if (content) {
            content.style.display = 'block';
            content.classList.remove('collapse-content');
        }
    });
    
    // Clear modal and add cloned content
    modalContent.innerHTML = '';
    modalContent.appendChild(clonedCard);
    
    // Show modal
    modal.showModal();
    
    // Recalculate scores and certainty for the cloned content
    setTimeout(function() {
        calculateAllCertainty();
    }, 100);
}
</script>

<!-- Grant Detail Modal -->
<dialog id="grant-modal" class="modal">
    <div class="modal-box max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <div id="grant-modal-content">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% endblock %}
