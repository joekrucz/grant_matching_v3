{% extends 'base.html' %}
{% load percentage %}

{% block title %}{{ funding_search.name }} - Grants Aggregator{% endblock %}

{% block content %}
<script>
    // Real-time progress polling for matching status
    let progressPollInterval = null;
    
    function startProgressPolling(fundingSearchId) {
        // Clear any existing interval
        if (progressPollInterval) {
            clearInterval(progressPollInterval);
        }
        
        // Poll every 1 second for real-time updates
        progressPollInterval = setInterval(function() {
            fetch(`/companies/funding_searches/${fundingSearchId}/status`)
                .then(response => response.json())
                .then(data => {
                    // Update progress bar
                    const progressBar = document.getElementById('matching-progress-bar');
                    const progressText = document.getElementById('matching-progress-text');
                    const statusAlert = document.getElementById('matching-status-alert');
                    
                    if (progressBar && progressText) {
                        const percentage = data.progress.percentage || 0;
                        const current = data.progress.current || 0;
                        const total = data.progress.total || 0;
                        
                        progressBar.style.width = percentage + '%';
                        progressBar.setAttribute('aria-valuenow', percentage);
                        progressText.textContent = `${current} of ${total} grants checked (${percentage.toFixed(1)}%)`;
                    }
                    
                    // If status changed from 'running', stop polling and reload page
                    if (data.status !== 'running') {
                        clearInterval(progressPollInterval);
                        progressPollInterval = null;
                        
                        // Reload page to show final results
                        if (data.status === 'completed' || data.status === 'error') {
                            setTimeout(() => {
        window.location.reload();
                            }, 500);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error polling matching status:', error);
                });
        }, 1000); // Poll every 1 second
    }
    
    // Start polling if matching is running
    {% if funding_search.matching_status == 'running' %}
    document.addEventListener('DOMContentLoaded', function() {
        startProgressPolling({{ funding_search.id }});
    });
    {% endif %}
</script>
<div class="mb-6">
    <a href="{% url 'companies:detail' funding_search.company.id %}" class="btn btn-ghost btn-sm">
        ‚Üê Back to Company
    </a>
</div>

<div class="card bg-base-200 border border-base-300">
    <div class="card-body">
        <div class="flex justify-between items-start mb-6">
            <h1 class="card-title text-3xl">{{ funding_search.name }}</h1>
            {% if can_edit %}
            <a href="{% url 'companies:funding_search_delete' funding_search.id %}" class="btn btn-error btn-sm">
                Delete
            </a>
            {% endif %}
        </div>
        
        <div class="mb-6">
            <div class="text-sm font-semibold mb-1">Company</div>
            <a href="{% url 'companies:detail' funding_search.company.id %}" class="link link-primary">
                {{ funding_search.company.name }}
            </a>
        </div>
        
        {% if can_edit %}
        <form method="post">
            {% csrf_token %}
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label" for="id_name">
                        <span class="label-text">Name</span>
                    </label>
                    <input 
                        type="text" 
                        name="name" 
                        id="id_name" 
                        value="{{ funding_search.name }}" 
                        required
                        class="input input-bordered"
                    >
                </div>
                <div class="form-control">
                    <label class="label" for="id_trl_level">
                        <span class="label-text">TRL Level</span>
                    </label>
                    <select name="trl_level" id="id_trl_level" class="select select-bordered">
                        <option value="">Select TRL Level</option>
                        {% for value, label in trl_levels %}
                        <option value="{{ value }}" {% if funding_search.trl_level == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-control">
                    <label class="label" for="id_notes">
                        <span class="label-text">Notes</span>
                    </label>
                    <textarea 
                        name="notes" 
                        id="id_notes" 
                        rows="6"
                        class="textarea textarea-bordered"
                    >{{ funding_search.notes|default:'' }}</textarea>
                </div>
                <div class="form-control">
                    <label class="label" for="id_project_description">
                        <span class="label-text">Project Description</span>
                        <span class="label-text-alt">Describe your project, roadmap, or product for grant matching</span>
                    </label>
                    <textarea 
                        name="project_description" 
                        id="id_project_description" 
                        rows="10"
                        class="textarea textarea-bordered"
                        placeholder="Enter a detailed description of your project, including objectives, technology, target market, and funding needs..."
                    >{{ funding_search.project_description|default:'' }}</textarea>
                </div>
                <div class="form-control mt-6">
                    <button type="submit" class="btn btn-primary">Update Funding Search</button>
                </div>
            </div>
        </form>
        
        <!-- File Upload Section -->
        <div class="divider">OR</div>
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body">
                <h2 class="card-title text-xl">Upload Project Document</h2>
                <p class="text-sm text-base-content/70 mb-4">
                    Upload a PDF, DOCX, or TXT file containing your project description. 
                    The system will extract text automatically.
                </p>
                <form method="post" enctype="multipart/form-data" action="{% url 'companies:funding_search_upload' funding_search.id %}">
                    {% csrf_token %}
                    <div class="form-control">
                        <input 
                            type="file" 
                            name="file" 
                            accept=".pdf,.docx,.txt" 
                            class="file-input file-input-bordered file-input-primary w-full"
                            required
                        >
                        <label class="label">
                            <span class="label-text-alt">Maximum file size: 10MB</span>
                        </label>
                    </div>
                    <div class="form-control mt-4">
                        <button type="submit" class="btn btn-outline btn-primary">Upload & Extract Text</button>
                    </div>
                </form>
                {% if funding_search.uploaded_file %}
                <div class="alert alert-info mt-4">
                    <span>üìÑ Uploaded: {{ funding_search.uploaded_file.name }} ({{ funding_search.file_type|upper }})</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Matching Section -->
        {% if funding_search.project_description %}
        <div class="divider"></div>
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body">
                <h2 class="card-title text-xl">Grant Matching</h2>
                <p class="text-sm text-base-content/70 mb-4">
                    Match your project against all available grants using AI-powered analysis.
                </p>
                
                <form method="post" action="{% url 'companies:funding_search_match' funding_search.id %}">
                    {% csrf_token %}
                    <button 
                        type="submit" 
                        class="btn btn-primary btn-lg w-full" 
                        {% if funding_search.matching_status == 'running' %}disabled{% endif %}
                    >
                        {% if funding_search.matching_status == 'running' %}
                            <span class="loading loading-spinner loading-md"></span>
                            Matching in progress... This may take 1-2 minutes
                        {% elif funding_search.matching_status == 'completed' %}
                            Run Matching Job Again
                        {% else %}
                            Run Matching Job
                        {% endif %}
                    </button>
                </form>
                
                {% if funding_search.matching_status == 'running' %}
                <div id="matching-status-alert" class="alert alert-info mt-4">
                    <span>Status: Processing grants... This may take 1-2 minutes.</span>
                    {% if funding_search.matching_progress %}
                    <div class="mt-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span id="matching-progress-text">
                                {{ funding_search.matching_progress.current|default:0 }} of {{ funding_search.matching_progress.total|default:0 }} grants checked 
                                ({{ funding_search.matching_progress.percentage|default:0 }}%)
                            </span>
                        </div>
                        <progress 
                            id="matching-progress-bar"
                            class="progress progress-primary w-full" 
                            value="{{ funding_search.matching_progress.percentage|default:0 }}" 
                            max="100"
                            aria-valuenow="{{ funding_search.matching_progress.percentage|default:0 }}"
                            aria-valuemin="0"
                            aria-valuemax="100"
                        ></progress>
                    </div>
                    {% else %}
                    <div class="mt-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span id="matching-progress-text">Initializing...</span>
                        </div>
                        <progress 
                            id="matching-progress-bar"
                            class="progress progress-primary w-full" 
                            value="0" 
                            max="100"
                            aria-valuenow="0"
                        ></progress>
                    </div>
                    {% endif %}
                </div>
                {% elif funding_search.matching_status == 'error' %}
                <div class="alert alert-error mt-4">
                    <span>Error: An error occurred during matching. Please try again.</span>
                    {% if funding_search.matching_error %}
                    <div class="mt-2 text-sm">
                        <strong>Error details:</strong>
                        <pre class="mt-1 text-xs bg-base-300 p-2 rounded overflow-auto max-h-40 overflow-y-auto">{{ funding_search.matching_error }}</pre>
                    </div>
                    {% endif %}
                </div>
                {% elif funding_search.matching_status == 'completed' and funding_search.last_matched_at %}
                <div class="alert alert-success mt-4">
                    <span>Status: Last matched: {{ funding_search.last_matched_at|date:"F d, Y g:i A" }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="divider"></div>
        <div class="alert alert-warning">
            <span>Warning: Please provide a project description or upload a file before running matching.</span>
        </div>
        {% endif %}
        {% else %}
        {% if funding_search.trl_level %}
        <div class="mb-4">
            <div class="text-sm font-semibold mb-1">TRL Level</div>
            <div class="badge badge-outline">{{ funding_search.trl_level }}</div>
        </div>
        {% endif %}
        {% if funding_search.notes %}
        <div class="mb-4">
            <div class="text-sm font-semibold mb-1">Notes</div>
            <div class="whitespace-pre-wrap">{{ funding_search.notes }}</div>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>

<!-- Match Results Section -->
{% if match_results %}
<div class="card bg-base-200 border border-base-300 mt-6">
    <div class="card-body">
        <h2 class="card-title text-2xl mb-4">Grant Matching Results</h2>
        <p class="text-sm text-base-content/70 mb-6">
            Found {{ match_results|length }} matching grant{{ match_results|length|pluralize }} 
            {% if funding_search.last_matched_at %}
            (matched on {{ funding_search.last_matched_at|date:"F d, Y g:i A" }})
            {% endif %}
        </p>
        
        <div class="space-y-4">
            {% for match in match_results %}
            <div class="card bg-base-100 border border-base-300 {% if forloop.first %}border-2 border-primary{% endif %}">
                <div class="card-body">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h3 class="card-title text-lg">
                                <a href="{% url 'grants:detail' match.grant.slug %}" class="link link-primary">
                                    {{ match.grant.title }}
                                </a>
                            </h3>
                            <div class="flex gap-2 mt-2 flex-wrap">
                                <span class="badge badge-primary badge-outline">{{ match.grant.get_source_display }}</span>
                                {% if match.grant.status == 'open' %}
                                <span class="badge badge-success">Open</span>
                                {% else %}
                                <span class="badge badge-error">Closed</span>
                                {% endif %}
                                {% if match.grant.deadline %}
                                <span class="badge badge-info">Deadline: {{ match.grant.deadline|date:"M d, Y" }}</span>
                                {% endif %}
                            </div>
                            {% if match.grant.summary %}
                            <p class="text-base-content/80 mt-3 text-sm">{{ match.grant.summary|truncatewords:30 }}</p>
                            {% endif %}
                        </div>
                        <div class="text-right ml-4">
                            <div class="stat-value text-primary text-3xl">{{ match.match_score|percentage }}%</div>
                            <div class="stat-desc text-xs">Match Score</div>
                        </div>
                    </div>
                    
                    {% if match.match_reasons.explanation %}
                    <div class="mt-4">
                        <p class="text-base-content/90 text-sm">
                            <strong>Why this matches:</strong> {{ match.match_reasons.explanation }}
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if match.match_reasons.alignment_points %}
                    <div class="mt-4">
                        <div class="flex flex-wrap gap-2">
                            {% for point in match.match_reasons.alignment_points %}
                            <span class="badge badge-success badge-outline">‚úì {{ point }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if match.match_reasons.concerns %}
                    <div class="mt-3">
                        <div class="flex flex-wrap gap-2">
                            {% for concern in match.match_reasons.concerns %}
                            <span class="badge badge-warning badge-outline">Warning: {{ concern }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="card-actions justify-end mt-4">
                        <a href="{% url 'grants:detail' match.grant.slug %}" class="btn btn-primary btn-sm">
                            View Grant Details
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% elif funding_search.matching_status == 'completed' %}
<div class="card bg-base-200 border border-base-300 mt-6">
    <div class="card-body">
        <div class="alert alert-info">
            <span>No matching grants found above the threshold. Try adjusting your project description or run the matching again.</span>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
