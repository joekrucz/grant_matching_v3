{% extends 'base.html' %}

{% block title %}AI Conversations - Admin Panel{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-200px)] gap-4">
    <!-- Left Sidebar: Conversation List -->
    <div class="w-64 bg-base-200 rounded-lg border border-base-300 flex flex-col">
        <div class="p-4 border-b border-base-300">
            <div class="flex items-center justify-between mb-2">
                <h2 class="font-semibold text-lg">Conversations</h2>
                <a href="{% url 'admin_panel:conversations_page' %}" 
                   class="btn btn-xs btn-primary"
                   title="New Conversation">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                </a>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-2 space-y-1">
            {% if conversations %}
                {% for conv in conversations %}
                <a href="{% url 'admin_panel:conversations_page' %}?conversation_id={{ conv.id }}"
                   class="block group p-3 rounded-lg {% if selected_conversation and selected_conversation.id == conv.id %}bg-primary text-primary-content{% else %}bg-base-100 hover:bg-base-300{% endif %} transition-colors">
                    <div class="font-semibold text-sm truncate overflow-hidden text-ellipsis whitespace-nowrap">
                        {{ conv.title|default:conv.get_default_title }}
                    </div>
                    <div class="text-xs opacity-70 mt-1">
                        {{ conv.get_message_count }} messages
                    </div>
                    <div class="text-xs opacity-60 mt-1">
                        {{ conv.updated_at|date:"M d, Y H:i" }}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="text-center text-base-content/60 text-sm p-4">
                    No conversations yet.<br>
                    Start chatting with the AI assistant to create one.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Main Area: Selected Conversation -->
    <div class="flex-1 bg-base-200 rounded-lg border border-base-300 flex flex-col">
        {% if selected_conversation %}
            <div class="p-4 border-b border-base-300">
                <div class="flex items-start justify-between gap-2">
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg" id="conversation-title-display">{{ selected_conversation.title|default:selected_conversation.get_default_title }}</h3>
                        <div class="text-xs text-base-content/60 mt-1">
                            Started {{ selected_conversation.created_at|date:"F d, Y" }} â€¢ 
                            {% if selected_conversation.initial_page_type == 'grant' %}
                                Grant context
                            {% elif selected_conversation.initial_page_type == 'company' %}
                                Company context
                            {% else %}
                                General conversation
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="button"
                                class="btn btn-xs btn-ghost"
                                onclick="renameConversation({{ selected_conversation.id }}, '{{ selected_conversation.title|default:selected_conversation.get_default_title|escapejs }}')"
                                title="Rename conversation">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.885L17.5 5.5a2.121 2.121 0 0 0-3-3L3.58 13.419a4 4 0 0 0-.885 1.343Z" />
                            </svg>
                        </button>
                        <button type="button"
                                class="btn btn-xs btn-ghost text-error"
                                onclick="deleteConversation({{ selected_conversation.id }})"
                                title="Delete conversation">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div id="conversation-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Messages are loaded dynamically via JavaScript -->
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-base-300">
                <form id="conversation-form" onsubmit="sendMessage(event)">
                    {% csrf_token %}
                    <div class="flex gap-2">
                        <textarea
                            id="conversation-input"
                            class="textarea textarea-bordered flex-1"
                            rows="2"
                            placeholder="Type your message..."></textarea>
                        <button type="submit" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-base-content/30 mb-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
                    </svg>
                    <h3 class="text-lg font-semibold mb-2">No conversation selected</h3>
                    <p class="text-base-content/60">
                        {% if conversations %}
                            Select a conversation from the sidebar to view it.
                        {% else %}
                            Start a conversation with the AI assistant to see it here.
                        {% endif %}
                    </p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

{% if selected_conversation %}
<script>
    function getCsrfToken() {
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken && metaToken.content) return metaToken.content.trim();
        const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
        return cookie ? cookie.split('=')[1] : null;
    }

    async function sendMessage(event) {
        event.preventDefault();
        const input = document.getElementById('conversation-input');
        const message = (input.value || '').trim();
        if (!message) return;

        const messagesContainer = document.getElementById('conversation-messages');
        
        // Add user message to UI
        const userBubble = document.createElement('div');
        userBubble.className = 'flex justify-end';
        userBubble.innerHTML = `
            <div class="max-w-[80%] rounded-lg px-4 py-2 bg-primary text-primary-content">
                <div class="text-sm whitespace-pre-wrap">${escapeHtml(message)}</div>
                <div class="text-xs opacity-70 mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            </div>
        `;
        messagesContainer.appendChild(userBubble);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        input.value = '';
        input.disabled = true;

        // Show thinking message
        const thinkingBubble = document.createElement('div');
        thinkingBubble.className = 'flex justify-start';
        thinkingBubble.id = 'thinking-message';
        thinkingBubble.innerHTML = `
            <div class="max-w-[80%] rounded-lg px-4 py-2 bg-base-100">
                <div class="text-sm">Thinking...</div>
            </div>
        `;
        messagesContainer.appendChild(thinkingBubble);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        try {
                    const ctx = {
                        pageType: '{{ selected_conversation.initial_page_type|default:"unknown" }}',
                        grantId: {% if selected_conversation.initial_grant_id %}{{ selected_conversation.initial_grant_id }}{% else %}null{% endif %},
                        companyId: {% if selected_conversation.initial_company_id %}{{ selected_conversation.initial_company_id }}{% else %}null{% endif %},
                    };

            const response = await fetch('/admin-panel/ai/contextual_qa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    message: message,
                    page_type: ctx.pageType,
                    grant_id: ctx.grantId,
                    company_id: ctx.companyId,
                    conversation_id: {% if selected_conversation %}{{ selected_conversation.id }}{% else %}null{% endif %},
                }),
            });

            if (!response.ok) {
                throw new Error('Failed to send message');
            }

            const data = await response.json();
            const answer = data.answer || 'No answer returned.';
            const caveats = (data.caveats || []).join(' ');

            // Remove thinking message
            thinkingBubble.remove();

            // Add assistant response with markdown processing
            const assistantBubble = document.createElement('div');
            assistantBubble.className = 'flex justify-start';
            const fullAnswer = answer + (caveats ? '\n\n' + caveats : '');
            const markdownHtml = parseMarkdown(fullAnswer);
            const linkedContent = linkifyGrantNames(markdownHtml);
            assistantBubble.innerHTML = `
                <div class="max-w-[80%] rounded-lg px-4 py-2 bg-base-100">
                    <div class="text-sm">${linkedContent}</div>
                    <div class="text-xs opacity-70 mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            messagesContainer.appendChild(assistantBubble);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

        } catch (error) {
            thinkingBubble.remove();
            const errorBubble = document.createElement('div');
            errorBubble.className = 'flex justify-start';
            errorBubble.innerHTML = `
                <div class="max-w-[80%] rounded-lg px-4 py-2 bg-error text-error-content">
                    <div class="text-sm">Error: ${escapeHtml(error.message)}</div>
                </div>
            `;
            messagesContainer.appendChild(errorBubble);
        } finally {
            input.disabled = false;
            input.focus();
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Track grants mentioned in conversation for link generation
    let conversationGrants = {};

    function parseMarkdown(text) {
        if (!text) return '';
        
        // Split into lines for processing
        const lines = text.split('\n');
        const processedLines = [];
        let inList = false;
        let listType = null; // 'ol' or 'ul'
        let currentListItem = null;
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            const trimmed = line.trim();
            const leadingSpaces = line.length - line.trimStart().length;
            
            // Skip empty lines - if we're in a list item, add a line break
            if (!trimmed) {
                if (currentListItem !== null) {
                    currentListItem += '<br>';
                } else if (inList) {
                    // Empty line ends the list item
                    if (currentListItem !== null) {
                        processedLines.push(`<li class="ml-2 mb-2">${currentListItem}</li>`);
                        currentListItem = null;
                    }
                }
                continue;
            }
            
            // Check for numbered list items: 1. item, 2. item, etc.
            const numberedMatch = trimmed.match(/^(\d+)\.\s+(.+)$/);
            if (numberedMatch && leadingSpaces < 3) {
                // Close previous list item if any
                if (currentListItem !== null) {
                    processedLines.push(`<li class="ml-2 mb-2">${currentListItem}</li>`);
                    currentListItem = null;
                }
                
                if (!inList || listType !== 'ol') {
                    if (inList) {
                        processedLines.push(`</${listType}>`);
                    }
                    processedLines.push('<ol class="list-decimal list-inside my-2 space-y-1">');
                    inList = true;
                    listType = 'ol';
                }
                // Start new list item
                currentListItem = processInlineMarkdown(numberedMatch[2]);
                continue;
            }
            
            // Check for bullet list items: - item or * item
            const bulletMatch = trimmed.match(/^[-*]\s+(.+)$/);
            if (bulletMatch && leadingSpaces < 3) {
                // Close previous list item if any
                if (currentListItem !== null) {
                    processedLines.push(`<li class="ml-2 mb-2">${currentListItem}</li>`);
                    currentListItem = null;
                }
                
                if (!inList || listType !== 'ul') {
                    if (inList) {
                        processedLines.push(`</${listType}>`);
                    }
                    processedLines.push('<ul class="list-disc list-inside my-2 space-y-1">');
                    inList = true;
                    listType = 'ul';
                }
                // Start new list item
                currentListItem = processInlineMarkdown(bulletMatch[1]);
                continue;
            }
            
            // If we're in a list item and this line is indented, it's a continuation
            if (currentListItem !== null && leadingSpaces >= 3) {
                currentListItem += '<br>' + processInlineMarkdown(trimmed);
                continue;
            }
            
            // Not a list item - close any open list and list item
            if (currentListItem !== null) {
                processedLines.push(`<li class="ml-2 mb-2">${currentListItem}</li>`);
                currentListItem = null;
            }
            if (inList) {
                processedLines.push(`</${listType}>`);
                inList = false;
                listType = null;
            }
            
            // Process markdown in regular text lines
            line = processInlineMarkdown(line);
            processedLines.push(`<div class="my-1">${line}</div>`);
        }
        
        // Close any open list item and list
        if (currentListItem !== null) {
            processedLines.push(`<li class="ml-2 mb-2">${currentListItem}</li>`);
        }
        if (inList) {
            processedLines.push(`</${listType}>`);
        }
        
        let result = processedLines.join('\n');
        
        // Convert multiple consecutive empty lines to single breaks
        result = result.replace(/\n{3,}/g, '\n\n');
        
        return result;
    }
    
    function processInlineMarkdown(text) {
        if (!text) return '';
        
        // First escape HTML to prevent XSS
        let result = escapeHtml(text);
        
        // Process markdown links: [text](url) - must come before bold processing
        result = result.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
            const escapedUrl = escapeHtml(url);
            const escapedText = linkText; // Already escaped by escapeHtml above
            return `<a href="${escapedUrl}" class="link link-primary" target="_blank" rel="noopener noreferrer">${escapedText}</a>`;
        });
        
        // Process bold: **text** or __text__ (must come before italic)
        result = result.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        result = result.replace(/__([^_]+)__/g, '<strong>$1</strong>');
        
        // Process italic: *text* or _text_ (but not if it's part of bold)
        // Only match single asterisks/underscores that aren't part of double ones
        result = result.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
        result = result.replace(/(?<!_)_([^_]+)_(?!_)/g, '<em>$1</em>');
        
        return result;
    }

    function linkifyGrantNames(htmlText) {
        // Convert grant names to hyperlinks in already-processed HTML
        if (!htmlText || Object.keys(conversationGrants).length === 0) {
            return htmlText;
        }
        
        let result = htmlText;
        
        // Sort by title length (longest first) to match more specific titles first
        const sortedTitles = Object.keys(conversationGrants).sort((a, b) => b.length - a.length);
        
        for (const title of sortedTitles) {
            const slug = conversationGrants[title];
            if (!slug) continue;
            
            // Escape the title for HTML (it's already escaped in the HTML text)
            const escapedTitle = escapeHtml(title);
            // Escape special regex characters in escaped title
            const regexEscapedTitle = escapedTitle.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            // Match grant title (case-insensitive, word boundaries) but not inside HTML tags
            // Use a negative lookbehind and lookahead to avoid matching inside tags
            const regex = new RegExp(`(?<!<[^>]*)\\b${regexEscapedTitle}\\b(?![^<]*>)`, 'gi');
            const url = `/grants/${escapeHtml(slug)}`;
            result = result.replace(regex, (match) => {
                return `<a href="${url}" class="link link-primary" target="_blank" rel="noopener noreferrer">${match}</a>`;
            });
        }
        
        return result;
    }

    // Load messages when page loads
    async function loadConversationMessages() {
        const conversationId = {% if selected_conversation %}{{ selected_conversation.id }}{% else %}null{% endif %};
        if (!conversationId) return;
        
        const messagesContainer = document.getElementById('conversation-messages');
        if (!messagesContainer) return;
        
        try {
            const resp = await fetch(`/admin-panel/ai/conversations/${conversationId}`);
            if (!resp.ok) throw new Error('Failed to load conversation');
            
            const data = await resp.json();
            messagesContainer.innerHTML = '';
            
            // Load grant mappings from conversation metadata
            conversationGrants = {};
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    const metadata = msg.metadata || {};
                    // Check for grant_mapping (from search results)
                    if (metadata.grant_mapping) {
                        Object.values(metadata.grant_mapping).forEach(grant => {
                            if (grant.title && grant.slug) {
                                conversationGrants[grant.title] = grant.slug;
                            }
                        });
                    }
                    // Check for individual grant_title and grant_slug
                    if (metadata.grant_title && metadata.grant_slug) {
                        conversationGrants[metadata.grant_title] = metadata.grant_slug;
                    }
                });
                
                // Render messages with markdown processing
                data.messages.forEach(msg => {
                    const bubble = document.createElement('div');
                    bubble.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                    
                    let content = msg.content || '';
                    if (msg.role === 'assistant') {
                        // Process markdown and linkify grant names for assistant messages
                        const markdownHtml = parseMarkdown(content);
                        content = linkifyGrantNames(markdownHtml);
                    } else {
                        // Escape HTML for user messages
                        content = escapeHtml(content);
                    }
                    
                    bubble.innerHTML = `
                        <div class="max-w-[80%] rounded-lg px-4 py-2 ${msg.role === 'user' ? 'bg-primary text-primary-content' : 'bg-base-100'}">
                            <div class="text-sm ${msg.role === 'user' ? 'whitespace-pre-wrap' : ''}">${content}</div>
                            <div class="text-xs opacity-70 mt-1">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    `;
                    messagesContainer.appendChild(bubble);
                });
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } catch (error) {
            console.error('Error loading messages:', error);
            messagesContainer.innerHTML = `<div class="text-sm text-error">Error loading messages: ${escapeHtml(error.message)}</div>`;
        }
    }

    // Auto-scroll to bottom on load and load messages
    window.addEventListener('load', () => {
        loadConversationMessages();
    });

    async function renameConversation(conversationId, currentTitle) {
        const newTitle = prompt('Enter new title:', currentTitle);
        if (newTitle === null || newTitle.trim() === currentTitle) {
            return; // User cancelled or didn't change
        }
        
        try {
            const csrftoken = getCsrfToken();
            const resp = await fetch(`/admin-panel/ai/conversations/${conversationId}/update`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                credentials: 'same-origin',
                body: JSON.stringify({ title: newTitle.trim() }),
            });
            
            if (!resp.ok) {
                const data = await resp.json();
                throw new Error(data.error || 'Failed to rename conversation');
            }
            
            // Update the title display
            const titleDisplay = document.getElementById('conversation-title-display');
            if (titleDisplay) {
                titleDisplay.textContent = newTitle.trim() || 'New Conversation';
            }
            
            // Reload the page to update the sidebar
            window.location.reload();
        } catch (err) {
            alert('Error renaming conversation: ' + err.message);
        }
    }

    async function deleteConversation(conversationId) {
        if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
            return;
        }
        
        try {
            const csrftoken = getCsrfToken();
            const resp = await fetch(`/admin-panel/ai/conversations/${conversationId}/delete`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                credentials: 'same-origin',
            });
            
            if (!resp.ok) {
                const data = await resp.json();
                throw new Error(data.error || 'Failed to delete conversation');
            }
            
            // Redirect to conversations page without selected conversation
            window.location.href = '{% url "admin_panel:conversations_page" %}';
        } catch (err) {
            alert('Error deleting conversation: ' + err.message);
        }
    }
</script>
{% endif %}
{% endblock %}

